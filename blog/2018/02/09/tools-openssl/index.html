
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>openssl常用命令，签名、非对称加解密 - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
<!--  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script> -->
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8245190595992760"
     crossorigin="anonymous"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2><br>date [-d @int|str] [+%s|"+%F %T"]<br>netstat -ltunp<br>sar -n DEV 1</h2>
  
  <div class="hwx" style='text-align: left; position: absolute; margin-top: -130px; white-space: nowrap;'>
	  <img src="/images/wx_ok.png" width=130px; height=130px;>
	  <img src="/images/ali_ok.png" width=130px; height=130px; style="margin-left:30px;">
  </div>
</hgroup>

</header>
  <nav role="navigation" style='white-space: nowrap; min-width=1120px; position: sticky; top: 0; z-index: 999;'><form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search..." style="height:1.5em;">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">

function StringToAscii(str) {
	return str.charCodeAt(0).toString(16);
}

function AsciiToString(asccode) {
	return String.fromCharCode(asccode);
}

function UrlDecode(zipStr) {
	var uzipStr = '';
	for (var i = 0; i < zipStr.length; i += 1) {
		var chr = zipStr.charAt(i);
		if (chr === '+') {
			uzipStr += ' ';
		} else if (chr === '%') {
			var asc = zipStr.substring(i + 1, i + 3);
			if (parseInt('0x' + asc) > 0x7f) {
				uzipStr += decodeURI('%' + asc.toString() + zipStr.substring(i+3, i+9).toString());
				i += 8;
			} else {
				uzipStr += AsciiToString(parseInt('0x' + asc));
				i += 2;
			}
		} else {
			uzipStr += chr;
		}
	}
	return uzipStr;
}

/*
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = UrlDecode(query);
}
*/

var query = window.location.search.substring(1);
var vars = query.split("&");
for (var i = 0; i < vars.length; i ++) {
	var pair = vars[i].split("=");
	if (pair[0] == 'query') {
		document.getElementById('query').value = UrlDecode(pair[1]);
		break;
	}
}

</script>

<!-- Start of Site Search 360 Scripts -->
<!-- Search 360 达到次数后要收费，换成静态索引
<script type="text/javascript">
var ss360Config = {
    siteId: "abcdxyzk.github.io",
    searchBox: {
        selector: "input#query",
        searchButton: "input#query+input[type='submit']"
    }
}
</script>
<script src="https://cdn.sitesearch360.com/v13/sitesearch360-v13.min.js" async></script>
-->
<!-- End of Site Search 360 Scripts -->

<ul class="subscription" data-subscription="rss">
<li>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/search">Search</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">openssl常用命令，签名、非对称加解密</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-09T00:38:00+08:00'><span class='date'>2018-02-09</span> <span class='time'>00:38:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://blog.csdn.net/modianwutong/article/details/43059435">http://blog.csdn.net/modianwutong/article/details/43059435</a></p>

<p><a href="https://www.cnblogs.com/gordon0918/p/5363466.html">https://www.cnblogs.com/gordon0918/p/5363466.html</a></p>

<p><a href="https://stackoverflow.com/questions/5140425/openssl-command-line-to-verify-the-signature">https://stackoverflow.com/questions/5140425/openssl-command-line-to-verify-the-signature</a></p>

<hr />

<p>查看网站证书</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl s_client -showcerts -connect www.baidu.com:443</span></code></pre></td></tr></table></div></figure>


<h3>证书</h3>

<p>  证书是一个经证书授权中心签过名的包含公钥及公钥拥有者信息的文件。证书授权中心（CA）对证书签名的过程即为证书的颁发过程。证书里面的公钥只属于某一个实体（网站，个人等），它的作用是防止一个实体伪装成另外一个实体。</p>

<p> 证书可以保证非对称加密算法的合理性，假设A和B的通话过程如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> A -------&gt; Hello (plain text) ---------&gt; B
</span><span class='line'> A &lt;------- Hello (plain text) ---------- B
</span><span class='line'> A &lt;------ B Send Certificate to A --- B
</span><span class='line'> A ------- cipher text ------------------&gt; B
</span><span class='line'> A &lt;------ cipher text ------------------- B
</span><span class='line'>  … …</span></code></pre></td></tr></table></div></figure>


<p>  A在接受了B发过来的证书以后，A，B就可以使用密文进行通信了。</p>

<p>  如果C想伪装成B，应该怎么做呢？我们想象下面的通话过程：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> A-------&gt; Hello (plain text) ---------&gt; C
</span><span class='line'> A &lt;------ Hello (plain text) ----------- C
</span><span class='line'> A &lt;------ C Send Certificate to A --- C</span></code></pre></td></tr></table></div></figure>


<p>  此时A没有怀疑C的身份，理所当然的接受了C的证书，并继续进行下面的通信</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> A------- cipher text ------------------&gt; C
</span><span class='line'> A &lt;------ cipher text ------------------- C
</span><span class='line'>  … …</span></code></pre></td></tr></table></div></figure>


<p>  这样的情况下A是没有办法发现C是假的，A的用户名，密码，甚至卡号等重要信息都有可能被C截获。如果A在通话过程中要求取得B的证书，并验证证书里面的名字，如果发现名字与B不符合，就可以发现对方不是B。验证B的名字通过后，再继续通信过程。</p>

<p>  那么，如果证书是假的怎么办？或者证书被修改过怎么办？此时就要用到签名信息了。数字证书除了包含证书拥有者的名字和公钥外，还应包含颁发证书的机构名称，证书序列号和其它一些可选信息。最重要的是，它包含了证书颁发机构（Certification Authority，简称CA）的签名信息。</p>

<p>  通过检查证书里面CA的签名信息，就知道这个证书的确是由该CA签发的，然后你就可以检查证书里面的证书拥有者的名字，检查通过后，就可以提取公钥，继续通信了。这样做的基础是，你信任该CA，认为该CA没有颁发错误的证书。</p>

<p>  CA是第三方机构，被你信任，由它保证证书的确发给了应该得到证书的人。这里需要解释一下，CA也是一个实体，它也有自己的公钥和私钥，否则怎么做数字签名？它也有自己的证书，你可以去它的站点下载它的证书，来验证签名。</p>

<p>  CA也是分级别的，最高级别的CA叫RootCA，低一级别的CA的证书由它来颁发和签名。这样我们信任RootCA，那些由RootCA签名过的证书的CA就可以来颁发证书给实体或其它CA了。那RootCA谁给签名呢？他们自己给自己签名，叫自签名。</p>

<p>  现在常用的证书都是采用X.509格式的，这是一个国际标准的证书格式。任何遵循该标准的应用程序都可以读，写X509格式的证书。</p>

<p>  下面是一个证书的例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl x509 -text -in test.crt
</span><span class='line'>Certificate:
</span><span class='line'>   Data:
</span><span class='line'>       Version: 3 (0x2)
</span><span class='line'>       Serial Number: 17209717939030827578 (0xeed53348d899a23a)
</span><span class='line'>   Signature Algorithm: sha1WithRSAEncryption                             // 签名算法
</span><span class='line'>       Issuer: C=AU, ST=Some-State, O=Internet Widgits Pty Ltd            // 证书颁发者信息
</span><span class='line'>       Validity
</span><span class='line'>           Not Before: Jan 14 07:01:20 2015 GMT                           // 证书的有效期
</span><span class='line'>           Not After : Feb 13 07:01:20 2015 GMT
</span><span class='line'>       Subject: C=AU, ST=Some-State, O=Internet Widgits Pty Ltd           // 证书拥有者信息
</span><span class='line'>       Subject Public Key Info:                                           //公钥信息
</span><span class='line'>           Public Key Algorithm: rsaEncryption
</span><span class='line'>                Public-Key: (512 bit)
</span><span class='line'>                Modulus:
</span><span class='line'>                   00:c5:63:8c:c8:32:b1:2e:15:58:a6:cd:22:f4:40:
</span><span class='line'>                   ef:53:8e:e7:fa:4e:fd:d5:d9:fe:69:a2:c2:5a:fc:
</span><span class='line'>                   20:4b:da:c9:17:49:35:4e:67:92:82:ec:4e:a7:a7:
</span><span class='line'>                   1a:66:3a:c5:36:2e:74:77:30:7a:dd:65:5f:03:9a:
</span><span class='line'>                   9b:2e:d0:b1:43
</span><span class='line'>                Exponent: 65537 (0x10001)
</span><span class='line'>       X509v3 extensions:                                                 //x509扩展信息
</span><span class='line'>           X509v3 Subject Key Identifier:
</span><span class='line'>               0E:DB:FE:E6:CF:FE:A6:C8:6D:38:06:A5:22:34:DA:82:A9:BE:42:B8
</span><span class='line'>           X509v3 Authority Key Identifier:
</span><span class='line'>               keyid:0E:DB:FE:E6:CF:FE:A6:C8:6D:38:06:A5:22:34:DA:82:A9:BE:42:B8
</span><span class='line'>           X509v3 Basic Constraints:
</span><span class='line'>               CA:TRUE
</span><span class='line'>   Signature Algorithm: sha1WithRSAEncryption
</span><span class='line'>        32:43:0c:e8:32:6f:30:10:c9:0f:a3:36:24:7c:a5:dc:da:8c:            // CA的签名
</span><span class='line'>        c4:90:69:90:de:b1:1b:19:8e:b1:a5:35:ce:2e:7a:05:69:94:
</span><span class='line'>        46:72:37:c2:2c:38:57:4a:0c:89:bc:90:95:03:af:f2:6f:a0:
</span><span class='line'>        3f:13:5f:f0:90:a7:2c:bf:75:ee</span></code></pre></td></tr></table></div></figure>


<h3>算法</h3>

<p>  加密算法分为两种：对称加密算法和非对称加密算法；</p>

<h5>对称加密算法：即信息的发送方和接收方使用同一个密钥去加密和解密数据。它的最大优势是加/解密速度快，适合于对大数据量进行加密，但密钥管理困难。AES，DES等都是常用的对称加密算法；</h5>

<h5>非对称加密算法：它需要使用不同的密钥来分别完成加密和解密操作，一个公开发布，即公开密钥，另一个由用户自己秘密保存，即私用密钥。信息发送者用公开密钥去加密，而信息接收者则用私用密钥去解密。公钥机制灵活，但加密和解密速度却比对称密钥加密慢得多。RSA，DSA等是常用的非对称加密算法；</h5>

<p>  所以在实际的应用中，人们通常将两者结合在一起使用，例如，对称密钥加密系统用于存储大量数据信息，而公开密钥加密系统则用于加密密钥。</p>

<p>  另外还有一种我们需要知道的加密算法，叫做摘要算法，英文名是messagedigest，用来把任何长度的明文以一定规则变成固定长度的一串字符。那么我们在对文件做签名的时候，通常都是先使用摘要算法，获得固定长度的一串字符，然后对这串字符进行签名。</p>

<p>  Base64不是加密算法，它是编码方式，用来在ASCII码和二进制码之间进行转换。</p>

<h3>RSA</h3>

<p>  RSA是目前比较流行的非对称加密算法，所谓非对称，就是指该算法需要一对密钥，使用其中一个加密，则需要用另一个才能解密。下面简单介绍一下它的原理：</p>

<p>  RSA的算法涉及三个参数，n、e1、e2。</p>

<p>  其中，n是两个大质数p、q的积，n的二进制表示所占用的位数，就是所谓的密钥长度。</p>

<p>  e1和e2是一对相关的值，e1可以任意取，但要求e1与(p-1）<em>(q-1）互质；再选择e2，要求(e2</em>e1) mod((p-1)*(q-1))=1。</p>

<p>  (n，e1), (n，e2)就是密钥对。其中(n，e1)为公钥，(n，e2)为私钥。</p>

<p>  RSA加解密的算法完全相同，设A为明文，B为密文，则：A=B<sup>e2</sup> mod n；B=A<sup>e1</sup> mod n；（公钥加密体制中，一般用公钥加密，私钥解密）</p>

<p>  e1和e2可以互换使用，即：</p>

<p>  A=B<sup>e1mod</sup> n；B=A<sup>e2</sup> mod n;</p>

<p>  关于RSA加密算法的详细介绍可以参考百度百科；</p>

<h3>协议</h3>

<p>  SSL是Secure Sockets Layer（安全套接层协议）的缩写，可以在Internet上提供秘密性传输。Netscape公司在推出第一个Web浏览器的同时，提出了SSL协议标准。其目标是保证两个应用间通信的保密性和可靠性,可在服务器端和用户端同时实现支持。已经成为Internet上保密通讯的工业标准。</p>

<p>  OpenSSL是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。</p>

<p>  OpenSSL整个软件包大概可以分成三个主要的功能部分：SSL协议库、应用程序以及密码算法库。OpenSSL的目录结构自然也是围绕这三个功能部分进行规划的。</p>

<p>  Openssl目前最新的稳定版本是1.0.2，可以在openssl的官网下载openssl-1.0.2的源代码。</p>

<p>  Android中已经集成了openssl，源码目录在：external/openssl</p>

<h3>工具</h3>

<p>  RSA是目前最有影响力的公钥加密算法，它能抵抗到目前为止已知的绝大多数密码攻击。下面我们要介绍的工具将会主要涉及到秘钥的产生、管理，证书请求及证书的产生，数据加密、解密，算法签名及身份验证等；</p>

<h4>genrsa</h4>

<p>生成RSA私有密钥，用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa [-outfilename] [-passout arg] [-aes128] [-aes192] [-aes256] [-des] [-des3] [-idea][-f4] [-3]
</span><span class='line'>[-rand file(s)] [-engine id] [numbits]
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -outfilename：将生成的私钥输出到指定文件，默认为标准输出；
</span><span class='line'>  -passoutarg：如果对生成的密钥使用加密算法的话，可以使用”-passout”选项指定密码来源，这里的arg可以是”pass:password”，”file:pathname”，”stdin”等；
</span><span class='line'>  -des|-des3|-idea：采用什么加密算法来加密生成的密钥，一般需要输入保护密码；
</span><span class='line'>  -f4|3：生成密钥过程中使用的公共组件，65537或3，默认使用65537；
</span><span class='line'>  numbits：密钥长度，必须是genrsa命令的最后一个参数，默认值是512；</span></code></pre></td></tr></table></div></figure>


<p>注意：genrsa生成的私钥默认是PEM编码格式；</p>

<h5>Example：</h5>

<p>1）生成私钥：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -out private.pem -3 -2048</span></code></pre></td></tr></table></div></figure>


<h4>rsa</h4>

<p>RSA密钥管理工具，用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa [-informPEM|NET|DER] [-outform PEM|NET|DER] [-in filename] [-passin arg] [-outfilename] [-passout arg] [-sgckey] [-aes128] [-aes192] [-aes256] [-des] [-des3][-idea] [-text] [-noout] [-modulus] [-check] [-pubin] [-pubout]
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -informPEM|NET|DER：指定输入格式，可以是PEM，NET或DER格式；
</span><span class='line'>  -outformPEM|NET|DER：指定输出格式，可以是PEM，NET或DER格式；
</span><span class='line'>  -infilename：指定输入文件，如果是加密过的密钥，会要求你输入密码；
</span><span class='line'>  -outfilename：指定输出文件名称；
</span><span class='line'>  -passinarg：输入密钥的密码来源；
</span><span class='line'>  -passoutarg：输出密钥如果加密的话，该参数用于指定密码的来源；
</span><span class='line'>  -text：以只读方式输出密钥及组件信息；
</span><span class='line'>  -noout：不打印密钥文件；
</span><span class='line'>  -modulus：显示密钥的模数；
</span><span class='line'>  -pubin：默认从输入文件中读取私钥，如果该选项打开的话，就可以从输入文件中读取公钥；
</span><span class='line'>  -pubout：默认输出私钥，使用该选项的话，将会输出公钥，如果pubin打开的话，pubout也会被自动打开；另外使用该参数的话，可以由私钥导出公钥；
</span><span class='line'>  -check：检查RSA密钥是否被破坏；</span></code></pre></td></tr></table></div></figure>


<p>Example：</p>

<p>1）去掉私钥的保护密码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -out private_out.pem</span></code></pre></td></tr></table></div></figure>


<p>2）用DES3算法加密密钥，需要输入保护密码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -des3 -out private_out.pem</span></code></pre></td></tr></table></div></figure>


<p>3）把私钥文件从PEM格式转换为DER格式</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -outform DER -out private.der</span></code></pre></td></tr></table></div></figure>


<p>4）打印私钥组件信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -text -noout</span></code></pre></td></tr></table></div></figure>


<p>5）导出公钥文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -out public.pem -pubout</span></code></pre></td></tr></table></div></figure>


<p>6）检查密钥文件的完整性</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsa -in private.pem -check -noout</span></code></pre></td></tr></table></div></figure>


<h4>rsautil</h4>

<p> 无论是使用公钥加密还是私钥加密，RSA每次能够加密的数据长度不能超过RSA密钥长度，并且根据具体的补齐方式不同输入的加密数据最大长度也不一样，而输出长度则总是跟RSA密钥长度相等。RSA不同的补齐方法对应的输入输入长度如下表</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>数据补齐方式       输入数据长度      输出数据长度  参数字符串
</span><span class='line'>PKCS#1 v1.5       少于(密钥长度-11)字节   同密钥长度 -pkcs
</span><span class='line'>PKCS#1 OAEP       少于(密钥长度-11)字节   同密钥长度 -oaep
</span><span class='line'>PKCS#1 for SSLv23 少于(密钥长度-11)字节   同密钥长度 -ssl
</span><span class='line'>不使用补齐       同密钥长度     同密钥长度 -raw</span></code></pre></td></tr></table></div></figure>


<p>RSA工具指令，包含RSA算法签名，身份验证，加密/解密数据等功能，用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl [-in file][-out file] [-inkey file] [-pubin] [-certin] [-sign] [-verify] [-encrypt][-decrypt] [-pkcs]
</span><span class='line'>[-ssl] [-raw] [-hexdump] [-asn1parse]
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -infile：指定输入文件；
</span><span class='line'>  -outfile：指定输出文件；
</span><span class='line'>  -inkeyfile：加密/解密数据时使用的密钥文件，缺省使用RSA私钥；
</span><span class='line'>  -pubin：如果设置该选项，则使用RSA公钥加密/解密数据；
</span><span class='line'>  -certin：指定使用证书文件加密/解密，证书中包含RSA公钥；
</span><span class='line'>  -sign：数据签名，需要指定RSA私钥；
</span><span class='line'>  -verify：数据验证；
</span><span class='line'>  -encrypt：数据加密；
</span><span class='line'>  -decrypt：数据解密；
</span><span class='line'>  -pkcs|-ssl|-raw：指定数据填充模式，分别代表：PKCS#1v1.5（缺省值），SSL v2填充模式或无填充。如果要签名，只能使用pkcs或raw选项；
</span><span class='line'>  -hexdump：用十六进制输出数据；
</span><span class='line'>  -asn1parse：按照ASN.1结构分析输出数据，详细可以查看asn1parse命令，和”-verify”选项一起使用威力强大；</span></code></pre></td></tr></table></div></figure>


<p>Example：</p>

<p>1）公钥加密</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl -encrypt -in test.txt -out test.enc -inkey public.pem -pubin</span></code></pre></td></tr></table></div></figure>


<p>注意：如果使用证书加密的话，需要使用-certin选项，-inkey指定证书文件；</p>

<p>2）私钥解密</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl -decrypt -in test.enc -out test.dec -inkey private.pem</span></code></pre></td></tr></table></div></figure>


<p>3）私钥签名</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl -sign -in test.txt -out test.sig -inkey private.pem</span></code></pre></td></tr></table></div></figure>


<p>4）公钥验证</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl -verify -in test.sig -out test.vfy -inkey public.pem -pubin</span></code></pre></td></tr></table></div></figure>


<p>注意：如果使用证书验证签名，需要使用-certin选项，-inkey指定证书文件；</p>

<h4>req</h4>

<p>创建和处理证书请求的工具，它还能建立自签名的证书，做RootCA用。用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req [-inform PEM|DER][-outform PEM|DER] [-in filename] [-passin arg] [-out filename] [-passout arg][-text] [-pubkey] [-noout] [-verify] [-modulus] [-new] [-rand file(s)] [-newkeyrsa:bits] [-newkey alg:file] [-nodes] [-key filename] [-keyform PEM|DER][-keyout filename] [-keygen_engine id] [-[digest]] [-config filename] [-subjarg] [-multivalue-rdn] [-x509] [-days n] [-set_serial n] [-asn1-kludge][-no-asn1-kludge] [-newhdr] [-extensions section] [-reqexts section] [-utf8][-nameopt] [-reqopt] [-subject] [-subj arg] [-batch] [-verbose]
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>在创建证书请求（CSR）的过程中会要求用户输入一些必要的信息，包括位置、组织、邮箱等信息，可以把它们放在配置文件里，也可以放在命令行参数里；
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -text：以可读方式打印将CSR文件里的内容；
</span><span class='line'>  -noout：不要打印CSR文件的编码信息；
</span><span class='line'>  -pubkey：解析CSR文件里的公钥信息，并打印出来；
</span><span class='line'>  -modulus：解析CSR文件里的公钥模数，并打印出来；
</span><span class='line'>  -verify：检验请求文件的签名信息；
</span><span class='line'>  -new：创建新的CSR，它会要求用户输入一些必要信息。如果没有指定-key参数，将会生成新的私钥；
</span><span class='line'>  -newkeyarg：创建新的CSR和新的私钥，参数指示私钥算法等信息（类似rsa:1024）；
</span><span class='line'>  -keyfilename：指定私钥文件，该选项支持pkcs8格式的私钥；
</span><span class='line'>  -keyoutfilename：如果产生了新的私钥，则把私钥保存到指定文件；
</span><span class='line'>  -[digest]：指定证书的摘要算法，可以是sha1|md5等，默认使用哈希算法；
</span><span class='line'>  -configfilename：指定config文件，配置文件可以包含创建CSR所需的各种信息；
</span><span class='line'>  -x509：产生自签名的证书，而不是证书请求；
</span><span class='line'>  -days：证书的有效期，缺省是30天；
</span><span class='line'>  -subject：显示CSR的位置，组织等信息；
</span><span class='line'>  -subjarg：设置CSR的位置，组织等信息，格式：/C=AU/ST=Some-State/type0=value0</span></code></pre></td></tr></table></div></figure>


<p>关于配置文件的格式，可以参考openssl的在线帮助文档；</p>

<p>Example：</p>

<p>1）生成一个私钥，并使用该私钥产生证书请求</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -out private.pem 1024
</span><span class='line'>
</span><span class='line'>openssl req -new -key private.pem -out req.pem</span></code></pre></td></tr></table></div></figure>


<p>如果加上-sha256，则使用sha256摘要算法；</p>

<p>2）生成一个私钥，并使用该私钥产生证书请求，另一个方法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -newkey rsa:2048 -keyout private.pem -out req.pem</span></code></pre></td></tr></table></div></figure>


<p>3）检测并验证证书请求</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -verify -in req.pem -text -noout</span></code></pre></td></tr></table></div></figure>


<p>4）制作自签名的根证书，使用已有私钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -new -x509 -key private.pem -sha256 -out rootca.crt</span></code></pre></td></tr></table></div></figure>


<p>5）制作自签名的根证书，创建新的私钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -newkey rsa:2048 -keyout private.pem -x509 -sha256 -out rootca.crt</span></code></pre></td></tr></table></div></figure>


<h4>x509</h4>

<p>证书管理工具，可以用来显示证书的内容，证书格式转换，为证书请求签名等。用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 [-inform DER|PEM|NET][-outform DER|PEM|NET] [-keyform DER|PEM]
</span><span class='line'>
</span><span class='line'>[-CAform DER|PEM] [-CAkeyform DER|PEM][-in filename] [-out filename] [-serial] [-hash] [-subject_hash] [-issuer_hash][-ocspid] [-subject] [-issuer] [-nameopt option] [-email] [-ocsp_uri][-startdate] [-enddate] [-purpose] [-dates] [-checkend num] [-modulus][-pubkey] [-fingerprint] [-alias] [-noout] [-trustout] [-clrtrust] [-clrreject][-addtrust arg] [-addreject arg] [-setalias arg] [-days arg] [-set_serial n][-signkey filename] [-passin arg] [-x509toreq] [-req] [-CA filename] [-CAkeyfilename] [-CAcreateserial] [-CAserial filename] [-force_pubkey key] [-text][-certopt option] [-C] [-md2|-md5|-sha1|-mdc2] [-clrext] [-extfile filename][-extensions section] [-engine id]
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>
</span><span class='line'>由于x509的选项比较多，下面我们来分类介绍：
</span><span class='line'>
</span><span class='line'>1）输入/输出相关选项
</span><span class='line'>  -inform|-outformDER|PEM|NET：指定输入/输出文件的编码格式；
</span><span class='line'>  -in|-outfilename：指定输入/输出文件；
</span><span class='line'>  -md2|-md5|-sha1|-mdc2：指定摘要算法，默认使用哈希算法；
</span><span class='line'>
</span><span class='line'>2）显示选项
</span><span class='line'>  -text：以可读方式打印证书内容；
</span><span class='line'>  -pubkey：解析证书里面的公钥信息，并打印出来；
</span><span class='line'>  -modulus：解析证书里面的公钥模数信息，并打印出来；
</span><span class='line'>  -serial：显示证书的序列号；
</span><span class='line'>  -subject：显示证书拥有者的信息；
</span><span class='line'>  -issuer：显示证书颁发者的名字；
</span><span class='line'>  -email：显示邮箱信息；
</span><span class='line'>  -startdate|-enddate |-dates：显示证书有效期，起始和结束时间；
</span><span class='line'>  -fingerprint：显示DER格式证书的DER版本信息；
</span><span class='line'>  -C：以C语言源文件方式，输出证书；
</span><span class='line'>
</span><span class='line'>3）信任相关的选项
</span><span class='line'>  -purpose：显示证书用途；
</span><span class='line'>
</span><span class='line'>4）签名相关选项
</span><span class='line'>  -signkeyfilename：使用给定的私钥，对输入文件进行签名；如果输入文件是证书，那么它的颁发者就会被设置成其拥有者，其它项也会被设置成符合自签名特征的证书项；如果输入文件是证书请求，那么就会产生一个自签名的证书；
</span><span class='line'>  -days：证书有效期；
</span><span class='line'>  -x509toreq：把证书转换成证书请求，需要-signkey选项指定私钥；
</span><span class='line'>  -req：默认输入文件是一个证书，使用该选项的话，指示输入文件是一个证书请求；
</span><span class='line'>  -CAfilename：指定签名用的CA证书文件，该选项通常和-req一起用，对证书请求实施自签名；
</span><span class='line'>  -CAkeyfilename：指定CA的私钥文件，对证书进行签名；</span></code></pre></td></tr></table></div></figure>


<p>Examples：</p>

<p>1）显示证书内容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem –noout -text</span></code></pre></td></tr></table></div></figure>


<p>2）显示证书序列号</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem -noout -serial</span></code></pre></td></tr></table></div></figure>


<p>3）显示证书的subject信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem -noout -subject</span></code></pre></td></tr></table></div></figure>


<p>4）显示证书的fingerprint信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem -noout -fingerprint</span></code></pre></td></tr></table></div></figure>


<p>5）证书格式转换</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem -inform PEM -out cert.der -outform DER
</span><span class='line'>
</span><span class='line'>openssl x509 -in cert.der -inform DER -out cert.pem -outform PEM</span></code></pre></td></tr></table></div></figure>


<p>6）把证书转换为证书请求</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -x509toreq -in cert.pem -out cert.csr -signkey private.pem</span></code></pre></td></tr></table></div></figure>


<p>7）把证书请求转换为证书</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -req -in careq.pem -extfile openssl.cnf -extensions v3_ca -signkey key.pem -out cacert.pem</span></code></pre></td></tr></table></div></figure>


<p>8）从证书里面提取公钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -pubkey -in cert.pem &gt;pub.pem</span></code></pre></td></tr></table></div></figure>


<p>9）以C语言源文件方式输出证书，PEM格式转换为DER格式</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in cert.pem -out cert.der -outform DER -C &gt; cert.c</span></code></pre></td></tr></table></div></figure>


<h4>asn1parse</h4>

<p>asn1parse是一个诊断工具，可以解析ASN.1结构的密钥，证书等，用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl asn1parse [-informPEM|DER] [-in filename] [-out filename] [-noout] [-offset number]
</span><span class='line'>[-length number] [-i] [-oid filename][-dump] [-dlimit num] [-strparse offset] [-genstr string]
</span><span class='line'>[-genconf file] [-strictpem]
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -i：以缩进方式显示ASN.1结构</span></code></pre></td></tr></table></div></figure>


<p>Example：</p>

<p>1）解析文件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl asn1parse -in file.pem</span></code></pre></td></tr></table></div></figure>


<p>2）解析DER格式的文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl asn1parse -inform file.der -infile.der</span></code></pre></td></tr></table></div></figure>


<h4>dgst</h4>

<p>摘要算法，用法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl dgst[-sha|-sha1|-mdc2|-ripemd160|-sha224|-sha256|-sha384|-sha512|-md2|-md4|-md5|-dss1][-c] [-d] [-hex] [-binary] [-r] [file...]
</span><span class='line'>
</span><span class='line'>所谓摘要算法，就是把任何长度的明文以一定规则变成固定长度的一串字符。
</span><span class='line'>
</span><span class='line'>Options：
</span><span class='line'>  -sha|-sha1 |-sha256 |-md5：算法名称；
</span><span class='line'>  -c：打印出哈希结果的时候用冒号来分隔开；
</span><span class='line'>  -d：详细打印出调试信息；
</span><span class='line'>  -hex：以十六进制输出哈希结果，默认值；
</span><span class='line'>  -binary：以二进制输出哈希结果；
</span><span class='line'>  file：要哈希的文件；</span></code></pre></td></tr></table></div></figure>


<p>Example：</p>

<p>1）使用sha256摘要算法，并以二进制方式输出</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl dgst -sha256 -binary file.txt</span></code></pre></td></tr></table></div></figure>


<h4>PEM 和 DER 格式</h4>

<p> PEM和DER是两种不同的编码格式，PEM使用ASCII（base64）编码方式，PEM格式文件的第一行和最后一行指明文件内容，DER采用二进制编码格式；使用openssl工具生成的密钥或证书，默认使用PEM编码格式；</p>

<h3>实例</h3>

<h4>Image签名</h4>

<p>高通平台支持bootimg签名和校验功能，下面我们先来看看它的签名脚本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define build-boot-image
</span><span class='line'> mv -f $(1) $(1).nonsecure
</span><span class='line'> openssl dgst -$(TARGET_SHA_TYPE) -binary $(1).nonsecure &gt;$(1).$(TARGET_SHA_TYPE)
</span><span class='line'> openssl rsautl -sign -in $(1).$(TARGET_SHA_TYPE) -inkey$(PRODUCT_PRIVATE_KEY) -out $(1).sig
</span><span class='line'> dd if=/dev/zero of=$(1).sig.padded bs=$(BOARD_KERNEL_PAGESIZE) count=1
</span><span class='line'> dd if=$(1).sig of=$(1).sig.padded conv=notrunc
</span><span class='line'> cat $(1).nonsecure $(1).sig.padded &gt; $(1).secure
</span><span class='line'> rm -rf $(1).$(TARGET_SHA_TYPE) $(1).sig $(1).sig.padded
</span><span class='line'> mv -f $(1).secure $(1)
</span><span class='line'>endef</span></code></pre></td></tr></table></div></figure>


<p>这里定义了一个build-boot-image宏，使用方法如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$(INSTALLED_BOOTIMAGE_TARGET) :=$(PRODUCT_OUT)/boot.img
</span><span class='line'>INSTALLED_SEC_BOOTIMAGE_TARGET :=$(PRODUCT_OUT)/boot.img.secure
</span><span class='line'>$(INSTALLED_SEC_BOOTIMAGE_TARGET):$(INSTALLED_BOOTIMAGE_TARGET)
</span><span class='line'>   $(hide) $(callbuild-boot-image,$(INSTALLED_BOOTIMAGE_TARGET))</span></code></pre></td></tr></table></div></figure>


<p>上面就是对bootimg实施签名操作的脚本，build-boot-image宏做了什么事呢？</p>

<p>1）对bootimg实施摘要算法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl dgst -sha256 -binary boot.img.nonsecure &gt; boot.img.sha256</span></code></pre></td></tr></table></div></figure>


<p>2）制作签名</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl rsautl -sign -inboot.img.sha256 -inkey qcom.key -out boot.img.sig</span></code></pre></td></tr></table></div></figure>


<p>3）填充签名</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dd if=/dev/zero of=boot.img.sig.paddedbs=2048 count=1
</span><span class='line'>dd if=boot.img.sig of=boot.img.sig.paddedconv=notrunc</span></code></pre></td></tr></table></div></figure>


<p>生成好的签名已经保存到boot.img.sig.padded，文件大小是2048字节，用0填充；</p>

<p>4）把签名打到image上，并删除中间文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat boot.img.nonsecure boot.img.sig.padded &gt; boot.img.secure
</span><span class='line'>rm -rf $boot.img.sha256 boot.img.sigboot.img.sig.padded
</span><span class='line'>
</span><span class='line'>mv -f boot.img.secure boot.img</span></code></pre></td></tr></table></div></figure>


<p>Image签名完成，签名信息保存在image的最后2048字节，不足的都用0来填充；</p>

<p>验证签名又是怎样的过程呢？前面用到了qcom.key，这个是高通提供的私钥，那么要验证签名，我们就需要用这个私钥制作的证书。验证过程是在LK里面完成的，所以我们还需要把证书转换为C源文件方式，方法很简单，用下面几条命令就可以了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -new -x509 -key qcom.key -days11324 -sha256 -out qcom.crt
</span><span class='line'>
</span><span class='line'>openssl x509 -inform PEM -in qcom.crt-outform DER -out qcom.der &gt; cert.c</span></code></pre></td></tr></table></div></figure>


<p>好了，cert.c就是以C源文件方式存储的证书，替换到LK里面相应的数组就可以了；</p>

<h4>制作testkey</h4>

<p> testkey是用来给apk签名的，保存在build/target/product/security目录下，testkey.pk8是私钥，</p>

<p>testkey.x509.pem是证书，那么这个key和证书是如何生成的呢？README写的很清楚：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development/tools/make_key testkey '/C=US/ST=California/L=MountainView/O=Android/OU=Android/
</span><span class='line'> CN=Android/emailAddress=android@android.com'</span></code></pre></td></tr></table></div></figure>


<p>development/tools/make_key是制作testkey的脚本文件，我们看几条比较重要的命令吧：</p>

<p>1）生成私钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl genrsa -f4 2048 | tee ${one}&gt; ${two}</span></code></pre></td></tr></table></div></figure>


<p>2）制作证书</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl req -new -x509 ${hash} -key${two} -out $1.x509.pem -days 10000 -subj "$2"</span></code></pre></td></tr></table></div></figure>


<p>3）制作pk8格式私钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl pkcs8 -in ${one} -topk8-outform DER -out $1.pk8 –nocrypt</span></code></pre></td></tr></table></div></figure>


<h3>Help</h3>

<p> OpenSSL提供了非常丰富的帮助信息，如果对哪个命令或参数不了解，可以很方便的使用帮助来查看命令的详细用法；
命令列表</p>

<p>使用下面命令查看openssl支持的命令和算法列表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl [ list-standard-commands | list-message-digest-commands | list-cipher-commands | 
</span><span class='line'>          list-cipher-algorithms | list-message-digest-algorithms | list-public-key-algorithms]
</span><span class='line'>list-standard-commands：标准命令列表
</span><span class='line'>list-message-digest-commands：摘要命令列表
</span><span class='line'>list-cipher-commands：加密命令列表
</span><span class='line'>list-cipher-algorithms：加密算法列表
</span><span class='line'>list-message-digest-algorithms：摘要算法列表
</span><span class='line'>list-public-key-algorithms：公钥加密算法列表</span></code></pre></td></tr></table></div></figure>


<h3>获取帮助</h3>

<p> 虽然openssl并不支持”-h”参数，使用”-h”参数，会出现类似” unknown option -h”的错误提示，但是openssl的帮助系统还是很nice的，在使用错误参数的情况下，会把命令的详细用法及参数解释列出来，因此，还是可以用”openssl command -h”的方式来获取帮助信息。</p>

<p> 我们还可以使用类似”man genrsa”的方法，来查看openssl的帮助文档；</p>

<p> 最后，我们还可以访问openssl的主页，里面有详细的帮助文档；</p>

<h3>参考资料</h3>

<p>openssl帮助文档：<a href="http://www.openssl.org/docs/">http://www.openssl.org/docs/</a></p>

<p>openssl命令详解.pdf</p>

<p>百度百科：openssl，RSA，X509；</p>

<p>使用openssl命令剖析RSA私钥文件格式：<a href="http://blog.csdn.net/lucien_cc/article/details/18407451">http://blog.csdn.net/lucien_cc/article/details/18407451</a></p>

<p>常用证书格式切换：<a href="http://blog.chinaunix.net/uid-20553497-id-2353867.html">http://blog.chinaunix.net/uid-20553497-id-2353867.html</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2018-02-09T00:38:00+08:00'><span class='date'>2018-02-09</span> <span class='time'>00:38:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/kernel/'>kernel</a>, <a class='category' href='/blog/cats/kernel~signature/'>signature</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/02/04/mem-mb/" title="Previous Post: 内存屏障">&laquo; 内存屏障</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/02/09/kernel-keyring/" title="Next Post: 内核模块签名--密匙">内核模块签名--密匙 &raquo;</a>
      
    </p>
    <p class="meta">
	<div style='white-space: nowrap;'>
	<img src="/images/wx_ok.png" width=150px; height=150px; style="margin-left:100px;">
	<img src="/images/ali_ok.png" width=150px; height=150px; style="margin-left:100px;">
	</div>
    </p>


<!-- alert 替代 -->
<script type="text/javascript">
	cssCode = "<style type='text/css'>"
		+ ".nbaMask { position: fixed; z-index: 1000; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); } "
		+ ".nbaMaskTransparent { position: fixed; z-index: 1000; top: 0; right: 0; left: 0; bottom: 0; } "
		+ ".nbaDialog { position: fixed; z-index: 5000; width: 80%; max-width: 500px; top: 50%; left: 50%; -webkit-transform: translate(-50%, -50%); transform: translate(-50%, -50%); background-color: #fff; text-align: center; border-radius: 8px; overflow: hidden; opacity: 1; color: white; }"
		+ ".nbaDialog .nbaDialogHd { padding: .2rem .27rem .08rem .27rem; text-align: left; padding-left: 10px; padding-top: 10px; } "
		+ ".nbaDialog .nbaDialogHd .nbaDialogTitle { color:black; font-size: 17px; font-weight: 400; } "
		+ ".nbaDialog .nbaDialogBd { padding: 0 .27rem; font-size: 15px; line-height: 1.3; word-wrap: break-word; word-break: break-all; color: #000000; } "
		+ ".nbaDialog .nbaDialogFt { background: #1a6ada; float: right; margin-right:10px; margin-bottom:10px; position: relative; border-radius: 5px; width:60px;  line-height: 30px; font-size: 15px; display: -webkit-box; display: -webkit-flex; display: flex; } "
		+ ".nbaDialog .nbaDialogFt:after { content: ' '; position: absolute; left: 0; top: 0; right: 0; height: 1px; border-top: 1px solid #e6e6e6; color: #e6e6e6; -webkit-transform-origin: 0 0; transform-origin: 0 0; -webkit-transform: scaleY(0.5); transform: scaleY(0.5); } "
		+ ".nbaDialog .nbaDialogBtn { display: block; -webkit-box-flex: 1; -webkit-flex: 1; flex: 1; color: white; text-decoration: none; -webkit-tap-highlight-color: transparent; position: relative; margin-bottom: 0; } "
		+ ".nbaDialog .nbaDialogBtn:after { content: ' '; position: absolute; left: 0; top: 0; width: 1px; bottom: 0; border-left: 1px solid #e6e6e6; color: #e6e6e6; -webkit-transform-origin: 0 0; transform-origin: 0 0; -webkit-transform: scaleX(0.5); transform: scaleX(0.5); } "
		+ ".nbaDialog a { text-decoration: none; -webkit-tap-highlight-color: transparent; }"
		+ "</style>";

googleads = '<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8245190595992760"     crossorigin="anonymous"><\/script>'
+ '<ins class="adsbygoogle"'
+ '     style="display:block"'
+ '     data-ad-client="ca-pub-8245190595992760"'
+ '     data-ad-slot="3924542061"'
+ '     data-ad-format="auto"'
+ '     data-full-width-responsive="true"></ins>'
+ '<script>     (adsbygoogle = window.adsbygoogle || []).push({});<\/script>';


	htmlCode = "<div id='dialogs2' style='display: none'>"
		+ "  <div class='nbaMask'></div>"
		+ "  <div class='nbaDialog' style='max-width:600px;'>"
		+ "    <div class='nbaDialogHd'>"
		+ "        <strong class='nbaDialogTitle'>提示：</strong>"
		+ "    </div><br>"
		+ ' <div style="white-space: nowrap;"> <img src="/images/wx_ok.png" width="130px;" height="130px;"> <img src="/images/ali_ok.png" width="130px;" height="130px;" style="margin-left:100px;"> </div> '
		+ "    <div class='nbaDialogBd' id='dialog_msg2' style='white-space:normal;'>弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>"
		+ "    <div class='nbaDialogHd'>"
		+ "        <strong class='nbaDialogTitle'></strong>"
		+ "    </div><br>"
		+ "    <div class='nbaDialogFt'>"
		+ "        <a href='javascript:;' class='nbaDialogBtn nbaDialogBtnPrimary' style='display:none;' id='dialog_ok2'>确定</a>"
		+ "    </div>"
		+ googleads
		+ "  </div>"
		+ "</div>";

	htmlCode2 = "<div id='dialogs22' style='display: none;'>"
		+ "  <div class='nbaDialog' id='dialogs22_s' style='background:gray; top:50%; border-radius: 18px;'>"
		+ "    <div class='nbaDialogBd' id='dialog_msg22' style='white-space:normal; color:white;padding-top:10px;'>弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>"
		+ "    <div class='nbaDialogHd'>"
		+ "        <strong class='nbaDialogTitle'></strong>"
		+ "    </div>"
		+ "  </div>"
		+ "</div>";

function showd()
{
	document.getElementById("dialog_ok2").style.display = '';
}

function alert_money(msg) {
	var div = document.createElement("div");
	div.innerHTML = cssCode + htmlCode;
	document.body.appendChild(div);

	var dialogs2 = document.getElementById("dialogs2");
	dialogs2.style.display = 'block';

	var dialog_msg2 = document.getElementById("dialog_msg2");
	dialog_msg2.innerHTML = msg;

	// var dialog_cancel = document.getElementById("dialog_cancel");
	//	dialog_cancel.onclick = function() {
	//	dialogs2.style.display = 'none';
	// };
	var dialog_ok2 = document.getElementById("dialog_ok2");
	dialog_ok2.onclick = function() {
		dialogs2.style.display = 'none';
		//callback();
	};

	setTimeout("showd()", 10*1000);
};

alert_money('');

</script>


  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo">  Copyright &copy; 2024 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//www.abcxyzkk.xyz/matomo/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->


<!-- Histats.com  (div with counter) --><div id="histats_counter"></div>
<!-- Histats.com  START  (aync)-->
<!--
<script type="text/javascript">var _Hasync= _Hasync|| [];
_Hasync.push(['Histats.start', '1,4673876,4,107,170,20,00010000']);
_Hasync.push(['Histats.fasi', '1']);
_Hasync.push(['Histats.track_hits', '']);
(function() {
var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
hs.src = ('//s10.histats.com/js15_as.js');
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
})();</script>
<noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4673876&101" alt="simple hit counter" border="0"></a></noscript>
-->
<!-- Histats.com  END  -->

<!--  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
-->


<!--
<script>

// TODO 无法获取框架内元素
function autoads()
{
try {
	console.log('start');
	var txt = document.getElementById('mys-content').innerHTML;
	var len = txt.length;
	var url = '';
	console.log(len);
	for (var i = 0; i < len - 10; i ++) {
		if (txt.substring(i, i + 6) == 'href="') {
			i = i + 6;
			url = '';
			for ( ; i < len; i ++) {
				if (txt[i] == '"')
					break;
				url += txt[i];
			}
			url = url.replace(/&amp;/g, '&');
		//	console.log(url);
		}
	}
	console.log(url);
	if (url != '' && Math.random() < 0.3)
		window.open(url, "_blank");
} catch (e) {
}
}

window.onload = function() {
	setTimeout("autoads()", 5*1000);
}
</script>
-->


</footer>
  





</body>
</html>
