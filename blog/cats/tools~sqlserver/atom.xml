<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: tools~sqlserver | kk Blog —— 通用基础]]></title>
  <link href="http://abcdxyzk.github.io/blog/cats/tools~sqlserver/atom.xml" rel="self"/>
  <link href="http://abcdxyzk.github.io/"/>
  <updated>2024-04-26T14:38:06+08:00</updated>
  <id>http://abcdxyzk.github.io/</id>
  <author>
    <name><![CDATA[kk]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[PHP SQLServer 缓冲查询超过了10240 KB]]></title>
    <link href="http://abcdxyzk.github.io/blog/2023/07/09/sqlserver-buffer-size/"/>
    <updated>2023-07-09T15:23:00+08:00</updated>
    <id>http://abcdxyzk.github.io/blog/2023/07/09/sqlserver-buffer-size</id>
    <content type="html"><![CDATA[<p><a href="https://cloud.tencent.com/developer/ask/sof/174258">https://cloud.tencent.com/developer/ask/sof/174258</a></p>

<p>错误号: IMSSP/-59</p>

<p>超过缓冲查询的内存限制10240 KB</p>

<p>vim /etc/php.ini</p>

<pre><code>    client_buffer_max_kb_size = '4096000'
    sqlsrv.ClientBufferMaxKBSize = 4096000
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SQLServer查询执行过的SQL记录]]></title>
    <link href="http://abcdxyzk.github.io/blog/2023/02/23/sqlserver-log/"/>
    <updated>2023-02-23T15:05:00+08:00</updated>
    <id>http://abcdxyzk.github.io/blog/2023/02/23/sqlserver-log</id>
    <content type="html"><![CDATA[<p><a href="https://blog.csdn.net/zbc415766331/article/details/113924487">https://blog.csdn.net/zbc415766331/article/details/113924487</a></p>

<p>说明：仅支持sql server2008及以上版本</p>

<p>通过下面的SQL语句可以查看Sqlserver执行的SQL记录，常用于SQL优化及辅助查找数据更新相关功能bug。</p>

<pre><code>    SELECT TOP 1000
        ST.text AS '执行的SQL语句',
        QS.execution_count AS '执行次数',
        QS.total_elapsed_time AS '耗时',
        QS.total_logical_reads AS '逻辑读取次数',
        QS.total_logical_writes AS '逻辑写入次数',
        QS.total_physical_reads AS '物理读取次数',
        QS.creation_time AS '执行时间' ,  
        QS.*
    FROM sys.dm_exec_query_stats QS
        CROSS APPLY
    sys.dm_exec_sql_text(QS.sql_handle) ST
    WHERE  QS.creation_time &gt;'2020-08-18'
    ORDER BY
        QS.total_elapsed_time DESC
</code></pre>

<p>关键SQL信息查询测试</p>

<pre><code>    SELECT TOP 1000
        ST.text AS '执行的SQL语句',
        QS.total_elapsed_time AS '耗时',
        QS.creation_time AS '执行时间' 
    FROM sys.dm_exec_query_stats QS
        CROSS APPLY
    sys.dm_exec_sql_text(QS.sql_handle) ST
    WHERE QS.creation_time &gt;'2021-02-18 15:00' AND QS.creation_time &lt;'2021-02-18 23:00'
    ORDER BY
        QS.total_elapsed_time DESC
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[sp_addlinkedserver 远程数据库链接]]></title>
    <link href="http://abcdxyzk.github.io/blog/2023/02/23/sqlserver-add-link/"/>
    <updated>2023-02-23T14:47:00+08:00</updated>
    <id>http://abcdxyzk.github.io/blog/2023/02/23/sqlserver-add-link</id>
    <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/qi123/p/9061008.html">https://www.cnblogs.com/qi123/p/9061008.html</a></p>

<pre><code>    --查看当前链接情况：
    select * from sys.servers;

    --使用 sp_helpserver 来显示可用的服务器
    exec sp_helpserver

    --删除已经存在的某个链接
    exec sp_droplinkedsrvlogin 服务器别名,Null
    exec sp_dropserver 服务器别名

    --使用sp_addlinkedserver来增加链接
    exec sp_addlinkedserver
    @server='192.168.2.66',  --被访问的服务器别名（习惯上直接使用目标服务器IP，或取个别名如：JOY）
    @srvproduct='',
    @provider='SQLOLEDB',
    @datasrc='192.168.2.66'  --要访问的服务器

    --使用sp_addlinkedsrvlogin 来增加用户登录链接
    exec sp_addlinkedsrvlogin
    '192.168.2.66', --被访问的服务器别名（如果上面sp_addlinkedserver中使用别名JOY，则这里也是JOY）
    'false', NULL,
    'sa', --帐号
    'test123' --密码

    使用举例(访问目标服务器上的数据库Music，查看其中表test的内容)：

    如果建立链接时的别名是目标服务器IP，即192.168.2.66 则：
    select * from [192.168.2.66].[Music].dbo.test

    如果建立链接时的别名是JOY, 则：
    select * from [JOY].[Music].dbo.test
</code></pre>

<pre><code>    可能会遇到的问题：
    exec sp_dropserver 'JOY'执行失败，

    报错信息：仍有对服务器 'JOY' 的远程登录或链接登录。

    解决方法：
    exec sp_droplinkedsrvlogin 'JOY',null

    exec sp_dropserver 'JOY'
</code></pre>

<pre><code>    select * from sys.servers;

    exec sp_helpserver

    exec sp_dropserver 'QPAccountsDBLink'

    EXEC sp_addlinkedserver
    @server='XFGameWebLink', --被访问的服务器别名（习惯上直接使用目标服务器IP，或取个别名如：JOY）
    @srvproduct='XFGameWebLink',
    @provider='SQLOLEDB',
    @datasrc='127.0.0.1',    --要访问的服务器
    @catalog='QPWXFGame'
</code></pre>

<pre><code>    EXEC sp_addlinkedserver @server='NC',@srvproduct='',@provider='SQLOLEDB',@datasrc='192.168.1.1'

    EXEC sp_addlinkedsrvlogin 'NC','false',NULL,'lx','xxx'
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASP 备份sqlserver]]></title>
    <link href="http://abcdxyzk.github.io/blog/2023/01/20/mssql-asp-dump-sqlserver/"/>
    <updated>2023-01-20T16:11:00+08:00</updated>
    <id>http://abcdxyzk.github.io/blog/2023/01/20/mssql-asp-dump-sqlserver</id>
    <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/yechuan/articles/84208.html">https://www.cnblogs.com/yechuan/articles/84208.html</a></p>

<h3>只有备份</h3>

<pre><code>    &lt;HTML&gt;
    &lt;HEAD&gt;
        &lt;TITLE&gt;SQL Server 数据库的备份&lt;/TITLE&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=gb2312"&gt;
    &lt;/HEAD&gt;
    &lt;BODY&gt;
    &lt;form method="post" name=myform&gt;
    选择操作：&lt;INPUT TYPE="radio" NAME="act" id="act_backup" value="backup"&gt;&lt;label for=act_backup&gt;备份&lt;/label&gt;　
    &lt;input type="submit" value="确定"&gt;
    &lt;/form&gt;

    &lt;%

    dim sqlserver,sqlname,sqlpassword,sqlLoginTimeout,databasename,bak_file,act

    sqlserver = "127.0.0.1"     'sql服务器
    sqlname = "dbname"      '用户名
    sqlpassword = "passwd"      '密码
    sqlLoginTimeout = 15        '登陆超时
    databasename = "dbname"
    bak_file = Server.MapPath(".") &amp; "\np.sql"

    act = lcase(request("act"))
    if databasename = "" then
        response.write "input database name"
    else
        if act = "backup" then
            Set srv=Server.CreateObject("SQLDMO.SQLServer")
            srv.LoginTimeout = sqlLoginTimeout
            srv.Connect sqlserver,sqlname, sqlpassword
            Set bak = Server.CreateObject("SQLDMO.Backup")
            bak.Database=databasename
            bak.Devices=Files
            bak.Files=bak_file
            bak.SQLBackup srv
            if err.number&gt;0 then
                response.write err.number&amp;"&lt;font color=red&gt;&lt;br&gt;"
                response.write err.description&amp;"&lt;/font&gt;"
            end if
            Response.write "&lt;font color=green&gt;备份成功!&lt;/font&gt;"
        else
            Response.write "&lt;font color=red&gt;没有选择操作&lt;/font&gt;"
        end if
    end if
    %&gt;
    &lt;/BODY&gt;
    &lt;/HTML&gt;
</code></pre>

<h3>all</h3>

<pre><code>    &lt;HTML&gt;
    &lt;HEAD&gt;
        &lt;TITLE&gt;SQL Server 数据库的备份与恢复&lt;/TITLE&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=gb2312"&gt;
    &lt;/HEAD&gt;
    &lt;BODY&gt;

    &lt;form method="post" name=myform&gt;
    选择操作：&lt;INPUT TYPE="radio" NAME="act" id="act_backup" value="backup"&gt;&lt;label for=act_backup&gt;备份&lt;/label&gt;　
    &lt;INPUT TYPE="radio" NAME="act" id="act_restore" value="restore"&gt;&lt;label for=act_restore&gt;恢复&lt;/label&gt;
    &lt;br&gt;数据库名：&lt;INPUT TYPE="text" NAME="databasename" value="&lt;%=request("databasename")%&gt;"&gt;
    &lt;br&gt;文件路径：&lt;INPUT TYPE="text" NAME="bak_file" value="c:\$1.bak"&gt;(备份或恢复的文件路径)&lt;br&gt;
    &lt;input type="submit" value="确定"&gt;
    &lt;/form&gt;

    &lt;%

    dim sqlserver,sqlname,sqlpassword,sqlLoginTimeout,databasename,bak_file,act

    sqlserver = "localhost"       'sql服务器
    sqlname = "sa"            '用户名
    sqlpassword = "sa"        '密码
    sqlLoginTimeout = 15      '登陆超时
    databasename = trim(request("databasename"))
    bak_file = trim(request("bak_file"))
    bak_file = replace(bak_file,"$1",databasename)
    act = lcase(request("act"))

    if databasename = "" then
        response.write "input database name"
    else
        if act = "backup" then
            Set srv=Server.CreateObject("SQLDMO.SQLServer")
            srv.LoginTimeout = sqlLoginTimeout
            srv.Connect sqlserver,sqlname, sqlpassword
            Set bak = Server.CreateObject("SQLDMO.Backup")
            bak.Database=databasename
            bak.Devices=Files
            bak.Files=bak_file
            bak.SQLBackup srv
            if err.number&gt;0 then
                response.write err.number&amp;"&lt;font color=red&gt;&lt;br&gt;"
                response.write err.description&amp;"&lt;/font&gt;"
            end if
            Response.write "&lt;font color=green&gt;备份成功!&lt;/font&gt;"
        elseif act = "restore" then
            '恢复时要在没有使用数据库时进行！
            Set srv=Server.CreateObject("SQLDMO.SQLServer")
            srv.LoginTimeout = sqlLoginTimeout
            srv.Connect sqlserver,sqlname, sqlpassword
            Set rest=Server.CreateObject("SQLDMO.Restore")
            rest.Action=0 ' full db restore
            rest.Database=databasename
            rest.Devices=Files
            rest.Files=bak_file
            rest.ReplaceDatabase=True 'Force restore over existing database
            if err.number&gt;0 then
                response.write err.number&amp;"&lt;font color=red&gt;&lt;br&gt;"
                response.write err.description&amp;"&lt;/font&gt;"
            end if
            rest.SQLRestore srv

            Response.write "&lt;font color=green&gt;恢复成功!&lt;/font&gt;"
        else
            Response.write "&lt;font color=red&gt;没有选择操作&lt;/font&gt;"
       end if
    end if

    %&gt;
    &lt;/BODY&gt;
    &lt;/HTML&gt;
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASPMyAdmin web管理sqlserver]]></title>
    <link href="http://abcdxyzk.github.io/blog/2023/01/20/mssql-aspmyadmin/"/>
    <updated>2023-01-20T16:06:00+08:00</updated>
    <id>http://abcdxyzk.github.io/blog/2023/01/20/mssql-aspmyadmin</id>
    <content type="html"><![CDATA[<p><a href="http://www.a1vbcode.com/app-3301.asp">http://www.a1vbcode.com/app-3301.asp</a></p>

<p><a href="/download/tools/ASPMyAdmin.zip">ASPMyAdmin.zip</a></p>

<p>备份数据库似乎会提示error</p>
]]></content>
  </entry>
  
</feed>
