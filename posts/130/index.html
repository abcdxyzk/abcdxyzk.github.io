
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
<!--  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script> -->
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8245190595992760"
     crossorigin="anonymous"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2><br>date [-d @int|str] [+%s|"+%F %T"]<br>netstat -ltunp<br>sar -n DEV 1</h2>
  
  <div class="hwx" style='text-align: left; position: absolute; margin-top: -130px; white-space: nowrap;'>
	  <img src="/images/wx_ok.png" width=130px; height=130px;>
	  <img src="/images/ali_ok.png" width=130px; height=130px; style="margin-left:30px;">
  </div>
</hgroup>

</header>
  <nav role="navigation" style='white-space: nowrap; min-width=1120px;'><form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search..." style="height:1.5em;">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">

function StringToAscii(str) {
	return str.charCodeAt(0).toString(16);
}

function AsciiToString(asccode) {
	return String.fromCharCode(asccode);
}

function UrlDecode(zipStr) {
	var uzipStr = '';
	for (var i = 0; i < zipStr.length; i += 1) {
		var chr = zipStr.charAt(i);
		if (chr === '+') {
			uzipStr += ' ';
		} else if (chr === '%') {
			var asc = zipStr.substring(i + 1, i + 3);
			if (parseInt('0x' + asc) > 0x7f) {
				uzipStr += decodeURI('%' + asc.toString() + zipStr.substring(i+3, i+9).toString());
				i += 8;
			} else {
				uzipStr += AsciiToString(parseInt('0x' + asc));
				i += 2;
			}
		} else {
			uzipStr += chr;
		}
	}
	return uzipStr;
}

/*
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = UrlDecode(query);
}
*/

var query = window.location.search.substring(1);
var vars = query.split("&");
for (var i = 0; i < vars.length; i ++) {
	var pair = vars[i].split("=");
	if (pair[0] == 'query') {
		document.getElementById('query').value = UrlDecode(pair[1]);
		break;
	}
}

</script>

<!-- Start of Site Search 360 Scripts -->
<!-- Search 360 达到次数后要收费，换成静态索引
<script type="text/javascript">
var ss360Config = {
    siteId: "abcdxyzk.github.io",
    searchBox: {
        selector: "input#query",
        searchButton: "input#query+input[type='submit']"
    }
}
</script>
<script src="https://cdn.sitesearch360.com/v13/sitesearch360-v13.min.js" async></script>
-->
<!-- End of Site Search 360 Scripts -->

<ul class="subscription" data-subscription="rss">
<li>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/search">Search</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2018/11/12/lang-c-shm/">进程通信--共享内存</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-12T02:44:00+08:00'><span class='date'>2018-11-12</span> <span class='time'>02:44:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://blog.csdn.net/xy913741894/article/details/72571260">https://blog.csdn.net/xy913741894/article/details/72571260</a></p>

<p><a href="https://www.cnblogs.com/fangshenghui/p/4039720.html">https://www.cnblogs.com/fangshenghui/p/4039720.html</a></p>

<h4>1. 共享内存，存在于每个进程的进程地址空间中，通过页表+MMU机制映射为同一块物理内存，因此，它属于每个进程，由于它并不需要系统调用干预和数据复制，它的效率是非常高的，它比我们所学的几种IPC机制（信号量，管道，消息队列）都要快。</h4>

<h4>2. 既然它性能最好，为什么还需要有其他的IPC机制？直接用它不就好了吗？它虽然很快，但是它不提供同步互斥机制，这样子一来就需要我们程序员来提供，带来了编程的难度。</h4>

<h3>Linux下相关函数</h3>

<h4>1、shmget函数</h4>

<p>该函数用来创建共享内存，它的原型为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int shmget(key_ t key, size_t size, int shmflg);</span></code></pre></td></tr></table></div></figure>


<p>第一个参数，与信号量的semget函数一样，程序需要提供一个参数key（非0整数），它有效地为共享内存段命名，shmget函数成功时返回一个与key相关的共享内存标识符（非负整数），用于后续的共享内存函数。调用失败返回-1.</p>

<p>第二个参数，size以字节为单位指定需要共享的内存容量</p>

<p>第三个参数，shmflg是权限标志，它的作用与open函数的mode参数一样，如果要想在key标识的共享内存不存在时，创建它的话，可以与IPC_CREAT做或操作。共享内存的权限标志与文件的读写权限一样，举例来说，0644,它表示允许一个进程创建的共享内存被内存创建者所拥有的进程向共享内存读取和写入数据，同时其他用户创建的进程只能读取共享内存。</p>

<h4>2、shmat函数</h4>

<p>第一次创建完共享内存时，它还不能被任何进程访问，shmat函数的作用就是用来启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。它的原型如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void *shmat(int shm_id, const void *shm_addr, int shmflg);</span></code></pre></td></tr></table></div></figure>


<p>第一个参数，shm_id是由shmget函数返回的共享内存标识。</p>

<p>第二个参数，shm_addr指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。</p>

<p>第三个参数，shm_flg是一组标志位，通常为0。</p>

<h4>3、shmdt函数</h4>

<p>该函数用于将共享内存从当前进程中分离。注意，将共享内存分离并不是删除它，只是使该共享内存对当前进程不再可用。它的原型如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int shmdt(const void *shmaddr);</span></code></pre></td></tr></table></div></figure>


<p>参数shmaddr是shmat函数返回的地址指针，调用成功时返回0，失败时返回-1.</p>

<h4>4、shmctl函数</h4>

<p>与信号量的semctl函数一样，用来控制共享内存，它的原型如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int shmctl(int shm_id, int command, struct shmid_ds *buf);</span></code></pre></td></tr></table></div></figure>


<p>第一个参数，shm_id是shmget函数返回的共享内存标识符。</p>

<p>第二个参数，command是要采取的操作，它可以取下面的三个值 ：</p>

<p>IPC_STAT：把shmid_ds结构中的数据设置为共享内存的当前关联值，即用共享内存的当前关联值覆盖shmid_ds的值。<br/>
IPC_SET： 如果进程有足够的权限，就把共享内存的当前关联值设置为shmid_ds结构中给出的值<br/>
IPC_RMID：删除共享内存段</p>

<p>第三个参数，buf是一个结构指针，它指向共享内存模式和访问权限的结构。</p>

<h3>简单互斥机制的样例</h3>

<p>确定两个线程的可以用，更多线程需要信号量或互斥锁</p>

<h4>shmread.c</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include&lt;unistd.h&gt;
</span><span class='line'>#include&lt;stdlib.h&gt;
</span><span class='line'>#include&lt;stdio.h&gt;
</span><span class='line'>#include&lt;sys/shm.h&gt;
</span><span class='line'>
</span><span class='line'>#define TEXT_SZ 2048
</span><span class='line'>struct shared_use_st {
</span><span class='line'>&#9;int written;/* 作为一个标志，非0：表示可读，0表示可写 */
</span><span class='line'>&#9;char text[TEXT_SZ];/* 记录写入和读取的文本 */
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>#define MEM_KEY (1234)
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>&#9;int running = 1; //程序是否继续运行的标志
</span><span class='line'>&#9;void *shm = NULL; //分配的共享内存的原始首地址
</span><span class='line'>&#9;struct shared_use_st *shared;//指向shm
</span><span class='line'>&#9;int shmid; //共享内存标识符
</span><span class='line'>&#9;//创建共享内存
</span><span class='line'>&#9;shmid = shmget((key_t)MEM_KEY, sizeof(struct shared_use_st), 0666|IPC_CREAT);
</span><span class='line'>&#9;if (shmid == -1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmget failed\n");
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//将共享内存连接到当前进程的地址空间
</span><span class='line'>&#9;shm = shmat(shmid, 0, 0);
</span><span class='line'>&#9;if (shm == (void*)-1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmat failed\n");
</span><span class='line'>&#9;&#9;return -2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;printf("\nMemory attached at shmid=%d shm=%p\n", shmid, shm);
</span><span class='line'>&#9;//设置共享内存
</span><span class='line'>&#9;shared = (struct shared_use_st*)shm;
</span><span class='line'>&#9;shared-&gt;written = 0;
</span><span class='line'>&#9;//读取共享内存中的数据
</span><span class='line'>&#9;while (running) {
</span><span class='line'>&#9;&#9;//没有进程向共享内存定数据有数据可读取
</span><span class='line'>&#9;&#9;while (shared-&gt;written == 0) {
</span><span class='line'>&#9;&#9;&#9;sleep(1); //有其他进程在写数据，不能读取数据
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;printf("You wrote: %s", shared-&gt;text);
</span><span class='line'>&#9;&#9;sleep(rand() % 3);
</span><span class='line'>&#9;&#9;//输入了end，退出循环（程序）
</span><span class='line'>&#9;&#9;if (strncmp(shared-&gt;text, "end", 3) == 0)
</span><span class='line'>&#9;&#9;&#9;running = 0;
</span><span class='line'>&#9;&#9;//读取完数据，设置written使共享内存段可写
</span><span class='line'>&#9;&#9;shared-&gt;written = 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//把共享内存从当前进程中分离
</span><span class='line'>&#9;if (shmdt(shm) == -1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmdt failed\n");
</span><span class='line'>&#9;&#9;return -3;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//删除共享内存
</span><span class='line'>&#9;if (shmctl(shmid, IPC_RMID, 0) == -1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmctl(IPC_RMID) failed\n");
</span><span class='line'>&#9;&#9;return -4;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>shmwrite.c</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include&lt;unistd.h&gt;
</span><span class='line'>#include&lt;stdlib.h&gt;
</span><span class='line'>#include&lt;stdio.h&gt;
</span><span class='line'>#include&lt;string.h&gt;
</span><span class='line'>#include&lt;sys/shm.h&gt;
</span><span class='line'>
</span><span class='line'>#define TEXT_SZ 2048
</span><span class='line'>struct shared_use_st {
</span><span class='line'>&#9;int written;/* 作为一个标志，非0：表示可读，0表示可写 */
</span><span class='line'>&#9;char text[TEXT_SZ];/* 记录写入和读取的文本 */
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>#define MEM_KEY (1234)
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>&#9;int running = 1;
</span><span class='line'>&#9;void *shm = NULL;
</span><span class='line'>&#9;struct shared_use_st *shared = NULL;
</span><span class='line'>&#9;char buffer[BUFSIZ +1];//用于保存输入的文本
</span><span class='line'>&#9;int shmid;
</span><span class='line'>&#9;//创建共享内存
</span><span class='line'>&#9;shmid = shmget((key_t)MEM_KEY, sizeof(struct shared_use_st), 0666|IPC_CREAT);
</span><span class='line'>&#9;if (shmid == -1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmget failed\n");
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//将共享内存连接到当前进程的地址空间
</span><span class='line'>&#9;shm = shmat(shmid, (void*)0, 0);
</span><span class='line'>&#9;if (shm == (void*)-1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmat failed\n");
</span><span class='line'>&#9;&#9;return -2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;printf("Memory attached at shmid=%d shm=%p\n", shmid, shm);
</span><span class='line'>&#9;//设置共享内存
</span><span class='line'>&#9;shared = (struct shared_use_st*)shm;
</span><span class='line'>&#9;//向共享内存中写数据
</span><span class='line'>&#9;while (running) {
</span><span class='line'>&#9;&#9;//数据还没有被读取，则等待数据被读取,不能向共享内存中写入文本
</span><span class='line'>&#9;&#9;while (shared-&gt;written == 1) {
</span><span class='line'>&#9;&#9;&#9;sleep(1);
</span><span class='line'>&#9;&#9;&#9;printf("Waiting...\n");
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;//向共享内存中写入数据
</span><span class='line'>&#9;&#9;printf("Enter some text: ");
</span><span class='line'>&#9;&#9;fgets(buffer, BUFSIZ, stdin);
</span><span class='line'>&#9;&#9;strncpy(shared-&gt;text, buffer, TEXT_SZ);
</span><span class='line'>&#9;&#9;//写完数据，设置written使共享内存段可读
</span><span class='line'>&#9;&#9;shared-&gt;written = 1;
</span><span class='line'>&#9;&#9;//输入了end，退出循环（程序）
</span><span class='line'>&#9;&#9;if (strncmp(buffer, "end", 3) == 0)
</span><span class='line'>&#9;&#9;&#9;running = 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//把共享内存从当前进程中分离
</span><span class='line'>&#9;if (shmdt(shm) == -1) {
</span><span class='line'>&#9;&#9;fprintf(stderr,"shmdt failed\n");
</span><span class='line'>&#9;&#9;return -3;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2018/11/07/kernel-server/">select,poll,epoll内核实现</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-07T23:48:00+08:00'><span class='date'>2018-11-07</span> <span class='time'>23:48:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://blog.csdn.net/lishenglong666/article/details/45536611">https://blog.csdn.net/lishenglong666/article/details/45536611</a></p>

<p>poll/select/epoll的实现都是基于文件提供的poll方法(f_op->poll)，
该方法利用poll_table提供的<em>qproc方法向文件内部事件掩码</em>key对应的的一个或多个等待队列(wait_queue_head_t)上添加包含唤醒函数(wait_queue_t.func)的节点(wait_queue_t)，并检查文件当前就绪的状态返回给poll的调用者(依赖于文件的实现)。
当文件的状态发生改变时(例如网络数据包到达)，文件就会遍历事件对应的等待队列并调用回调函数(wait_queue_t.func)唤醒等待线程。</p>

<p>通常的file.f_ops.poll实现及相关结构体如下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct file {  
</span><span class='line'>&#9;const struct file_operations    *f_op;  
</span><span class='line'>&#9;spinlock_t          f_lock;  
</span><span class='line'>&#9;// 文件内部实现细节  
</span><span class='line'>&#9;void               *private_data;  
</span><span class='line'>#ifdef CONFIG_EPOLL  
</span><span class='line'>&#9;/* Used by fs/eventpoll.c to link all the hooks to this file */  
</span><span class='line'>&#9;struct list_head    f_ep_links;  
</span><span class='line'>&#9;struct list_head    f_tfile_llink;  
</span><span class='line'>#endif /* #ifdef CONFIG_EPOLL */  
</span><span class='line'>&#9;// 其他细节....  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// 文件操作  
</span><span class='line'>struct file_operations {  
</span><span class='line'>&#9;// 文件提供给poll/select/epoll  
</span><span class='line'>&#9;// 获取文件当前状态, 以及就绪通知接口函数  
</span><span class='line'>&#9;unsigned int (*poll) (struct file *, struct poll_table_struct *);  
</span><span class='line'>&#9;// 其他方法read/write 等... ...  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// 通常的file.f_ops.poll 方法的实现  
</span><span class='line'>unsigned int file_f_op_poll (struct file *filp, struct poll_table_struct *wait)  
</span><span class='line'>{  
</span><span class='line'>&#9;unsigned int mask = 0;  
</span><span class='line'>&#9;wait_queue_head_t * wait_queue;  
</span><span class='line'>  
</span><span class='line'>&#9;//1. 根据事件掩码wait-&gt;key_和文件实现filep-&gt;private_data 取得事件掩码对应的一个或多个wait queue head  
</span><span class='line'>&#9;some_code();  
</span><span class='line'>  
</span><span class='line'>&#9;// 2. 调用poll_wait 向获得的wait queue head 添加节点  
</span><span class='line'>&#9;poll_wait(filp, wait_queue, wait);  
</span><span class='line'>  
</span><span class='line'>&#9;// 3. 取得当前就绪状态保存到mask  
</span><span class='line'>&#9;some_code();  
</span><span class='line'>  
</span><span class='line'>&#9;return mask;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// select/poll/epoll 向文件注册就绪后回调节点的接口结构  
</span><span class='line'>typedef struct poll_table_struct {  
</span><span class='line'>&#9;// 向wait_queue_head 添加回调节点(wait_queue_t)的接口函数  
</span><span class='line'>&#9;poll_queue_proc _qproc;  
</span><span class='line'>&#9;// 关注的事件掩码, 文件的实现利用此掩码将等待队列传递给_qproc  
</span><span class='line'>&#9;unsigned long   _key;  
</span><span class='line'>} poll_table;  
</span><span class='line'>typedef void (*poll_queue_proc)(struct file *, wait_queue_head_t *, struct poll_table_struct *);  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>// 通用的poll_wait 函数, 文件的f_ops-&gt;poll 通常会调用此函数  
</span><span class='line'>static inline void poll_wait(struct file * filp, wait_queue_head_t * wait_address, poll_table *p)  
</span><span class='line'>{  
</span><span class='line'>&#9;if (p && p-&gt;_qproc && wait_address) {  
</span><span class='line'>&#9;&#9;// 调用_qproc 在wait_address 上添加节点和回调函数  
</span><span class='line'>&#9;&#9;// 调用 poll_table_struct 上的函数指针向wait_address添加节点, 并设置节点的func  
</span><span class='line'>&#9;&#9;// (如果是select或poll 则是 __pollwait, 如果是 epoll 则是 ep_ptable_queue_proc),  
</span><span class='line'>&#9;&#9;p-&gt;_qproc(filp, wait_address, p);  
</span><span class='line'>&#9;}  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>// wait_queue 头节点  
</span><span class='line'>typedef struct __wait_queue_head wait_queue_head_t;  
</span><span class='line'>struct __wait_queue_head {  
</span><span class='line'>&#9;spinlock_t lock;  
</span><span class='line'>&#9;struct list_head task_list;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// wait_queue 节点  
</span><span class='line'>typedef struct __wait_queue wait_queue_t;  
</span><span class='line'>struct __wait_queue {  
</span><span class='line'>&#9;unsigned int flags;  
</span><span class='line'>#define WQ_FLAG_EXCLUSIVE   0x01  
</span><span class='line'>&#9;void *private;  
</span><span class='line'>&#9;wait_queue_func_t func;  
</span><span class='line'>&#9;struct list_head task_list;  
</span><span class='line'>};  
</span><span class='line'>typedef int (*wait_queue_func_t)(wait_queue_t *wait, unsigned mode, int flags, void *key);  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>// 当文件的状态发生改变时, 文件会调用此函数，此函数通过调用wait_queue_t.func通知poll的调用者  
</span><span class='line'>// 其中key是文件当前的事件掩码  
</span><span class='line'>void __wake_up(wait_queue_head_t *q, unsigned int mode,  
</span><span class='line'>&#9;&#9;&#9;   int nr_exclusive, void *key)  
</span><span class='line'>{  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>  
</span><span class='line'>&#9;spin_lock_irqsave(&q-&gt;lock, flags);  
</span><span class='line'>&#9;__wake_up_common(q, mode, nr_exclusive, 0, key);  
</span><span class='line'>&#9;spin_unlock_irqrestore(&q-&gt;lock, flags);  
</span><span class='line'>}  
</span><span class='line'>static void __wake_up_common(wait_queue_head_t *q, unsigned int mode,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9; int nr_exclusive, int wake_flags, void *key)  
</span><span class='line'>{  
</span><span class='line'>&#9;wait_queue_t *curr, *next;  
</span><span class='line'>&#9;// 遍历并调用func 唤醒, 通常func会唤醒调用poll的线程  
</span><span class='line'>&#9;list_for_each_entry_safe(curr, next, &q-&gt;task_list, task_list) {  
</span><span class='line'>&#9;&#9;unsigned flags = curr-&gt;flags;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (curr-&gt;func(curr, mode, wake_flags, key) &&  
</span><span class='line'>&#9;&#9;&#9;&#9;(flags & WQ_FLAG_EXCLUSIVE) && !--nr_exclusive) {  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h2>poll 和 select</h2>

<p>poll和select的实现基本上是一致的，只是传递参数有所不同，他们的基本流程如下：</p>

<ol>
<li><p>复制用户数据到内核空间</p></li>
<li><p>估计超时时间</p></li>
<li><p>遍历每个文件并调用f_op->poll 取得文件当前就绪状态， 如果前面遍历的文件都没有就绪，向文件插入wait_queue节点</p></li>
<li><p>遍历完成后检查状态：</p></li>
</ol>


<p>  a). 如果已经有就绪的文件转到5；</p>

<p>  b). 如果有信号产生，重启poll或select（转到 1或3）；</p>

<p>  c). 否则挂起进程等待超时或唤醒，超时或被唤醒后再次遍历所有文件取得每个文件的就绪状态</p>

<ol>
<li><p>将所有文件的就绪状态复制到用户空间</p></li>
<li><p>清理申请的资源</p></li>
</ol>


<h3>关键结构体</h3>

<p>下面是poll/select共用的结构体及其相关功能:</p>

<p>poll_wqueues 是 select/poll 对poll_table接口的具体化实现,其中的table, inline_index和inline_entries都是为了管理内存。
poll_table_entry 与一个文件相关联，用于管理插入到文件的wait_queue节点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// select/poll 对poll_table的具体化实现  
</span><span class='line'>struct poll_wqueues {  
</span><span class='line'>&#9;poll_table pt;  
</span><span class='line'>&#9;struct poll_table_page *table;     // 如果inline_entries 空间不足, 从poll_table_page 中分配  
</span><span class='line'>&#9;struct task_struct *polling_task;  // 调用poll 或select 的进程  
</span><span class='line'>&#9;int triggered;                     // 已触发标记  
</span><span class='line'>&#9;int error;  
</span><span class='line'>&#9;int inline_index;                  // 下一个要分配的inline_entrie 索引  
</span><span class='line'>&#9;struct poll_table_entry inline_entries[N_INLINE_POLL_ENTRIES];//  
</span><span class='line'>};  
</span><span class='line'>// 帮助管理select/poll  申请的内存  
</span><span class='line'>struct poll_table_page {  
</span><span class='line'>&#9;struct poll_table_page  * next;       // 下一个 page  
</span><span class='line'>&#9;struct poll_table_entry * entry;      // 指向第一个entries  
</span><span class='line'>&#9;struct poll_table_entry entries[0];  
</span><span class='line'>};  
</span><span class='line'>// 与一个正在poll /select 的文件相关联,  
</span><span class='line'>struct poll_table_entry {  
</span><span class='line'>&#9;struct file *filp;               // 在poll/select中的文件  
</span><span class='line'>&#9;unsigned long key;  
</span><span class='line'>&#9;wait_queue_t wait;               // 插入到wait_queue_head_t 的节点  
</span><span class='line'>&#9;wait_queue_head_t *wait_address; // 文件上的wait_queue_head_t 地址  
</span><span class='line'>};  </span></code></pre></td></tr></table></div></figure>


<h3>公共函数</h3>

<p>下面是poll/select公用的一些函数，这些函数实现了poll和select的核心功能。</p>

<p>poll_initwait 用于初始化poll_wqueues，</p>

<p><code>__pollwait</code> 实现了向文件中添加回调节点的逻辑，</p>

<p>pollwake 当文件状态发生改变时，由文件调用，用来唤醒线程，</p>

<p>poll_get_entry，free_poll_entry，poll_freewait用来申请释放poll_table_entry 占用的内存，并负责释放文件上的wait_queue节点。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// poll_wqueues 的初始化:  
</span><span class='line'>// 初始化 poll_wqueues , __pollwait会在文件就绪时被调用  
</span><span class='line'>void poll_initwait(struct poll_wqueues *pwq)  
</span><span class='line'>{  
</span><span class='line'>&#9;// 初始化poll_table, 相当于调用基类的构造函数  
</span><span class='line'>&#9;init_poll_funcptr(&pwq-&gt;pt, __pollwait);  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * static inline void init_poll_funcptr(poll_table *pt, poll_queue_proc qproc) 
</span><span class='line'>&#9; * { 
</span><span class='line'>&#9; *     pt-&gt;_qproc = qproc; 
</span><span class='line'>&#9; *     pt-&gt;_key   = ~0UL; 
</span><span class='line'>&#9; * } 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;pwq-&gt;polling_task = current;  
</span><span class='line'>&#9;pwq-&gt;triggered = 0;  
</span><span class='line'>&#9;pwq-&gt;error = 0;  
</span><span class='line'>&#9;pwq-&gt;table = NULL;  
</span><span class='line'>&#9;pwq-&gt;inline_index = 0;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>// wait_queue设置函数  
</span><span class='line'>// poll/select 向文件wait_queue中添加节点的方法  
</span><span class='line'>static void __pollwait(struct file *filp, wait_queue_head_t *wait_address,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   poll_table *p)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct poll_wqueues *pwq = container_of(p, struct poll_wqueues, pt);  
</span><span class='line'>&#9;struct poll_table_entry *entry = poll_get_entry(pwq);  
</span><span class='line'>&#9;if (!entry) {  
</span><span class='line'>&#9;&#9;return;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;get_file(filp); //put_file() in free_poll_entry()  
</span><span class='line'>&#9;entry-&gt;filp = filp;  
</span><span class='line'>&#9;entry-&gt;wait_address = wait_address; // 等待队列头  
</span><span class='line'>&#9;entry-&gt;key = p-&gt;key;  
</span><span class='line'>&#9;// 设置回调为 pollwake  
</span><span class='line'>&#9;init_waitqueue_func_entry(&entry-&gt;wait, pollwake);  
</span><span class='line'>&#9;entry-&gt;wait.private = pwq;  
</span><span class='line'>&#9;// 添加到等待队列  
</span><span class='line'>&#9;add_wait_queue(wait_address, &entry-&gt;wait);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// 在等待队列(wait_queue_t)上回调函数(func)  
</span><span class='line'>// 文件就绪后被调用，唤醒调用进程，其中key是文件提供的当前状态掩码  
</span><span class='line'>static int pollwake(wait_queue_t *wait, unsigned mode, int sync, void *key)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct poll_table_entry *entry;  
</span><span class='line'>&#9;// 取得文件对应的poll_table_entry  
</span><span class='line'>&#9;entry = container_of(wait, struct poll_table_entry, wait);  
</span><span class='line'>&#9;// 过滤不关注的事件  
</span><span class='line'>&#9;if (key && !((unsigned long)key & entry-&gt;key)) {  
</span><span class='line'>&#9;&#9;return 0;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 唤醒  
</span><span class='line'>&#9;return __pollwake(wait, mode, sync, key);  
</span><span class='line'>}  
</span><span class='line'>static int __pollwake(wait_queue_t *wait, unsigned mode, int sync, void *key)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct poll_wqueues *pwq = wait-&gt;private;  
</span><span class='line'>&#9;// 将调用进程 pwq-&gt;polling_task 关联到 dummy_wait  
</span><span class='line'>&#9;DECLARE_WAITQUEUE(dummy_wait, pwq-&gt;polling_task);  
</span><span class='line'>&#9;smp_wmb();  
</span><span class='line'>&#9;pwq-&gt;triggered = 1;// 标记为已触发  
</span><span class='line'>&#9;// 唤醒调用进程  
</span><span class='line'>&#9;return default_wake_function(&dummy_wait, mode, sync, key);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// 默认的唤醒函数,poll/select 设置的回调函数会调用此函数唤醒  
</span><span class='line'>// 直接唤醒等待队列上的线程,即将线程移到运行队列(rq)  
</span><span class='line'>int default_wake_function(wait_queue_t *curr, unsigned mode, int wake_flags,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;  void *key)  
</span><span class='line'>{  
</span><span class='line'>&#9;// 这个函数比较复杂, 这里就不具体分析了  
</span><span class='line'>&#9;return try_to_wake_up(curr-&gt;private, mode, wake_flags);  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>poll，select对poll_table_entry的申请和释放采用的是类似内存池的管理方式，先使用预分配的空间，预分配的空间不足时，分配一个内存页，使用内存页上的空间。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 分配或使用已先前申请的 poll_table_entry,  
</span><span class='line'>static struct poll_table_entry *poll_get_entry(struct poll_wqueues *p) {  
</span><span class='line'>&#9;struct poll_table_page *table = p-&gt;table;  
</span><span class='line'>  
</span><span class='line'>&#9;if (p-&gt;inline_index &lt; N_INLINE_POLL_ENTRIES) {  
</span><span class='line'>&#9;&#9;return p-&gt;inline_entries + p-&gt;inline_index++;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;if (!table || POLL_TABLE_FULL(table)) {  
</span><span class='line'>&#9;&#9;struct poll_table_page *new_table;  
</span><span class='line'>&#9;&#9;new_table = (struct poll_table_page *) __get_free_page(GFP_KERNEL);  
</span><span class='line'>&#9;&#9;if (!new_table) {  
</span><span class='line'>&#9;&#9;&#9;p-&gt;error = -ENOMEM;  
</span><span class='line'>&#9;&#9;&#9;return NULL;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;new_table-&gt;entry = new_table-&gt;entries;  
</span><span class='line'>&#9;&#9;new_table-&gt;next = table;  
</span><span class='line'>&#9;&#9;p-&gt;table = new_table;  
</span><span class='line'>&#9;&#9;table = new_table;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return table-&gt;entry++;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// 清理poll_wqueues 占用的资源  
</span><span class='line'>void poll_freewait(struct poll_wqueues *pwq)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct poll_table_page * p = pwq-&gt;table;  
</span><span class='line'>&#9;// 遍历所有已分配的inline poll_table_entry  
</span><span class='line'>&#9;int i;  
</span><span class='line'>&#9;for (i = 0; i &lt; pwq-&gt;inline_index; i++) {  
</span><span class='line'>&#9;&#9;free_poll_entry(pwq-&gt;inline_entries + i);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 遍历在poll_table_page上分配的inline poll_table_entry  
</span><span class='line'>&#9;// 并释放poll_table_page  
</span><span class='line'>&#9;while (p) {  
</span><span class='line'>&#9;&#9;struct poll_table_entry * entry;  
</span><span class='line'>&#9;&#9;struct poll_table_page *old;  
</span><span class='line'>&#9;&#9;entry = p-&gt;entry;  
</span><span class='line'>&#9;&#9;do {  
</span><span class='line'>&#9;&#9;&#9;entry--;  
</span><span class='line'>&#9;&#9;&#9;free_poll_entry(entry);  
</span><span class='line'>&#9;&#9;} while (entry &gt; p-&gt;entries);  
</span><span class='line'>&#9;&#9;old = p;  
</span><span class='line'>&#9;&#9;p = p-&gt;next;  
</span><span class='line'>&#9;&#9;free_page((unsigned long) old);  
</span><span class='line'>&#9;}  
</span><span class='line'>}  
</span><span class='line'>static void free_poll_entry(struct poll_table_entry *entry)  
</span><span class='line'>{  
</span><span class='line'>&#9;// 从等待队列中删除, 释放文件引用计数  
</span><span class='line'>&#9;remove_wait_queue(entry-&gt;wait_address, &entry-&gt;wait);  
</span><span class='line'>&#9;fput(entry-&gt;filp);  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h3>poll/select核心结构关系</h3>

<p>下图是 poll/select 实现公共部分的关系图，包含了与文件直接的关系，以及函数之间的依赖。</p>

<p><img src="/images/kernel/2018-11-07-1.png" alt="" /></p>

<h3>poll的实现</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// poll 使用的结构体  
</span><span class='line'>struct pollfd {  
</span><span class='line'>&#9;int fd;        // 描述符  
</span><span class='line'>&#9;short events;  // 关注的事件掩码  
</span><span class='line'>&#9;short revents; // 返回的事件掩码  
</span><span class='line'>};  
</span><span class='line'>// long sys_poll(struct pollfd *ufds, unsigned int nfds, long timeout_msecs)  
</span><span class='line'>SYSCALL_DEFINE3(poll, struct pollfd __user *, ufds, unsigned int, nfds,  
</span><span class='line'>&#9;&#9;&#9;&#9;long, timeout_msecs)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct timespec end_time, *to = NULL;  
</span><span class='line'>&#9;int ret;  
</span><span class='line'>&#9;if (timeout_msecs &gt;= 0) {  
</span><span class='line'>&#9;&#9;to = &end_time;  
</span><span class='line'>&#9;&#9;// 将相对超时时间msec 转化为绝对时间  
</span><span class='line'>&#9;&#9;poll_select_set_timeout(to, timeout_msecs / MSEC_PER_SEC,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;NSEC_PER_MSEC * (timeout_msecs % MSEC_PER_SEC));  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// do sys poll  
</span><span class='line'>&#9;ret = do_sys_poll(ufds, nfds, to);  
</span><span class='line'>&#9;// do_sys_poll 被信号中断, 重新调用, 对使用者来说 poll 是不会被信号中断的.  
</span><span class='line'>&#9;if (ret == -EINTR) {  
</span><span class='line'>&#9;&#9;struct restart_block *restart_block;  
</span><span class='line'>&#9;&#9;restart_block = &current_thread_info()-&gt;restart_block;  
</span><span class='line'>&#9;&#9;restart_block-&gt;fn = do_restart_poll; // 设置重启的函数  
</span><span class='line'>&#9;&#9;restart_block-&gt;poll.ufds = ufds;  
</span><span class='line'>&#9;&#9;restart_block-&gt;poll.nfds = nfds;  
</span><span class='line'>&#9;&#9;if (timeout_msecs &gt;= 0) {  
</span><span class='line'>&#9;&#9;&#9;restart_block-&gt;poll.tv_sec = end_time.tv_sec;  
</span><span class='line'>&#9;&#9;&#9;restart_block-&gt;poll.tv_nsec = end_time.tv_nsec;  
</span><span class='line'>&#9;&#9;&#9;restart_block-&gt;poll.has_timeout = 1;  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;restart_block-&gt;poll.has_timeout = 0;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// ERESTART_RESTARTBLOCK 不会返回给用户进程,  
</span><span class='line'>&#9;&#9;// 而是会被系统捕获, 然后调用 do_restart_poll,  
</span><span class='line'>&#9;&#9;ret = -ERESTART_RESTARTBLOCK;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return ret;  
</span><span class='line'>}  
</span><span class='line'>int do_sys_poll(struct pollfd __user *ufds, unsigned int nfds,  
</span><span class='line'>&#9;&#9;&#9;&#9;struct timespec *end_time)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct poll_wqueues table;  
</span><span class='line'>&#9;int err = -EFAULT, fdcount, len, size;  
</span><span class='line'>&#9;/* 首先使用栈上的空间，节约内存，加速访问 */  
</span><span class='line'>&#9;long stack_pps[POLL_STACK_ALLOC/sizeof(long)];  
</span><span class='line'>&#9;struct poll_list *const head = (struct poll_list *)stack_pps;  
</span><span class='line'>&#9;struct poll_list *walk = head;  
</span><span class='line'>&#9;unsigned long todo = nfds;  
</span><span class='line'>&#9;if (nfds &gt; rlimit(RLIMIT_NOFILE)) {  
</span><span class='line'>&#9;&#9;// 文件描述符数量超过当前进程限制  
</span><span class='line'>&#9;&#9;return -EINVAL;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 复制用户空间数据到内核  
</span><span class='line'>&#9;len = min_t(unsigned int, nfds, N_STACK_PPS);  
</span><span class='line'>&#9;for (;;) {  
</span><span class='line'>&#9;&#9;walk-&gt;next = NULL;  
</span><span class='line'>&#9;&#9;walk-&gt;len = len;  
</span><span class='line'>&#9;&#9;if (!len) {  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 复制到当前的 entries  
</span><span class='line'>&#9;&#9;if (copy_from_user(walk-&gt;entries, ufds + nfds-todo,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;   sizeof(struct pollfd) * walk-&gt;len)) {  
</span><span class='line'>&#9;&#9;&#9;goto out_fds;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;todo -= walk-&gt;len;  
</span><span class='line'>&#9;&#9;if (!todo) {  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 栈上空间不足，在堆上申请剩余部分  
</span><span class='line'>&#9;&#9;len = min(todo, POLLFD_PER_PAGE);  
</span><span class='line'>&#9;&#9;size = sizeof(struct poll_list) + sizeof(struct pollfd) * len;  
</span><span class='line'>&#9;&#9;walk = walk-&gt;next = kmalloc(size, GFP_KERNEL);  
</span><span class='line'>&#9;&#9;if (!walk) {  
</span><span class='line'>&#9;&#9;&#9;err = -ENOMEM;  
</span><span class='line'>&#9;&#9;&#9;goto out_fds;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 初始化 poll_wqueues 结构, 设置函数指针_qproc  为__pollwait  
</span><span class='line'>&#9;poll_initwait(&table);  
</span><span class='line'>&#9;// poll  
</span><span class='line'>&#9;fdcount = do_poll(nfds, head, &table, end_time);  
</span><span class='line'>&#9;// 从文件wait queue 中移除对应的节点, 释放entry.  
</span><span class='line'>&#9;poll_freewait(&table);  
</span><span class='line'>&#9;// 复制结果到用户空间  
</span><span class='line'>&#9;for (walk = head; walk; walk = walk-&gt;next) {  
</span><span class='line'>&#9;&#9;struct pollfd *fds = walk-&gt;entries;  
</span><span class='line'>&#9;&#9;int j;  
</span><span class='line'>&#9;&#9;for (j = 0; j &lt; len; j++, ufds++)  
</span><span class='line'>&#9;&#9;&#9;if (__put_user(fds[j].revents, &ufds-&gt;revents)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;goto out_fds;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;err = fdcount;  
</span><span class='line'>out_fds:  
</span><span class='line'>&#9;// 释放申请的内存  
</span><span class='line'>&#9;walk = head-&gt;next;  
</span><span class='line'>&#9;while (walk) {  
</span><span class='line'>&#9;&#9;struct poll_list *pos = walk;  
</span><span class='line'>&#9;&#9;walk = walk-&gt;next;  
</span><span class='line'>&#9;&#9;kfree(pos);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return err;  
</span><span class='line'>}  
</span><span class='line'>// 真正的处理函数  
</span><span class='line'>static int do_poll(unsigned int nfds,  struct poll_list *list,  
</span><span class='line'>&#9;&#9;&#9;&#9;   struct poll_wqueues *wait, struct timespec *end_time)  
</span><span class='line'>{  
</span><span class='line'>&#9;poll_table* pt = &wait-&gt;pt;  
</span><span class='line'>&#9;ktime_t expire, *to = NULL;  
</span><span class='line'>&#9;int timed_out = 0, count = 0;  
</span><span class='line'>&#9;unsigned long slack = 0;  
</span><span class='line'>&#9;if (end_time && !end_time-&gt;tv_sec && !end_time-&gt;tv_nsec) {  
</span><span class='line'>&#9;&#9;// 已经超时,直接遍历所有文件描述符, 然后返回  
</span><span class='line'>&#9;&#9;pt = NULL;  
</span><span class='line'>&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;if (end_time && !timed_out) {  
</span><span class='line'>&#9;&#9;// 估计进程等待时间，纳秒  
</span><span class='line'>&#9;&#9;slack = select_estimate_accuracy(end_time);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 遍历文件，为每个文件的等待队列添加唤醒函数(pollwake)  
</span><span class='line'>&#9;for (;;) {  
</span><span class='line'>&#9;&#9;struct poll_list *walk;  
</span><span class='line'>&#9;&#9;for (walk = list; walk != NULL; walk = walk-&gt;next) {  
</span><span class='line'>&#9;&#9;&#9;struct pollfd * pfd, * pfd_end;  
</span><span class='line'>&#9;&#9;&#9;pfd = walk-&gt;entries;  
</span><span class='line'>&#9;&#9;&#9;pfd_end = pfd + walk-&gt;len;  
</span><span class='line'>&#9;&#9;&#9;for (; pfd != pfd_end; pfd++) {  
</span><span class='line'>&#9;&#9;&#9;&#9;// do_pollfd 会向文件对应的wait queue 中添加节点  
</span><span class='line'>&#9;&#9;&#9;&#9;// 和回调函数(如果 pt 不为空)  
</span><span class='line'>&#9;&#9;&#9;&#9;// 并检查当前文件状态并设置返回的掩码  
</span><span class='line'>&#9;&#9;&#9;&#9;if (do_pollfd(pfd, pt)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 该文件已经准备好了.  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 不需要向后面文件的wait queue 中添加唤醒函数了.  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;count++;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;pt = NULL;  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 下次循环的时候不需要向文件的wait queue 中添加节点,  
</span><span class='line'>&#9;&#9;// 因为前面的循环已经把该添加的都添加了  
</span><span class='line'>&#9;&#9;pt = NULL;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;// 第一次遍历没有发现ready的文件  
</span><span class='line'>&#9;&#9;if (!count) {  
</span><span class='line'>&#9;&#9;&#9;count = wait-&gt;error;  
</span><span class='line'>&#9;&#9;&#9;// 有信号产生  
</span><span class='line'>&#9;&#9;&#9;if (signal_pending(current)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;count = -EINTR;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;// 有ready的文件或已经超时  
</span><span class='line'>&#9;&#9;if (count || timed_out) {  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 转换为内核时间  
</span><span class='line'>&#9;&#9;if (end_time && !to) {  
</span><span class='line'>&#9;&#9;&#9;expire = timespec_to_ktime(*end_time);  
</span><span class='line'>&#9;&#9;&#9;to = &expire;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 等待事件就绪, 如果有事件发生或超时，就再循  
</span><span class='line'>&#9;&#9;// 环一遍，取得事件状态掩码并计数,  
</span><span class='line'>&#9;&#9;// 注意此次循环中, 文件 wait queue 中的节点依然存在  
</span><span class='line'>&#9;&#9;if (!poll_schedule_timeout(wait, TASK_INTERRUPTIBLE, to, slack)) {  
</span><span class='line'>&#9;&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return count;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>static inline unsigned int do_pollfd(struct pollfd *pollfd, poll_table *pwait)  
</span><span class='line'>{  
</span><span class='line'>&#9;unsigned int mask;  
</span><span class='line'>&#9;int fd;  
</span><span class='line'>&#9;mask = 0;  
</span><span class='line'>&#9;fd = pollfd-&gt;fd;  
</span><span class='line'>&#9;if (fd &gt;= 0) {  
</span><span class='line'>&#9;&#9;int fput_needed;  
</span><span class='line'>&#9;&#9;struct file * file;  
</span><span class='line'>&#9;&#9;// 取得fd对应的文件结构体  
</span><span class='line'>&#9;&#9;file = fget_light(fd, &fput_needed);  
</span><span class='line'>&#9;&#9;mask = POLLNVAL;  
</span><span class='line'>&#9;&#9;if (file != NULL) {  
</span><span class='line'>&#9;&#9;&#9;// 如果没有 f_op 或 f_op-&gt;poll 则认为文件始终处于就绪状态.  
</span><span class='line'>&#9;&#9;&#9;mask = DEFAULT_POLLMASK;  
</span><span class='line'>&#9;&#9;&#9;if (file-&gt;f_op && file-&gt;f_op-&gt;poll) {  
</span><span class='line'>&#9;&#9;&#9;&#9;if (pwait) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 设置关注的事件掩码  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;pwait-&gt;key = pollfd-&gt;events | POLLERR | POLLHUP;  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;// 注册回调函数，并返回当前就绪状态，就绪后会调用pollwake  
</span><span class='line'>&#9;&#9;&#9;&#9;mask = file-&gt;f_op-&gt;poll(file, pwait);  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;mask &= pollfd-&gt;events | POLLERR | POLLHUP; // 移除不需要的状态掩码  
</span><span class='line'>&#9;&#9;&#9;fput_light(file, fput_needed);// 释放文件  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;pollfd-&gt;revents = mask; // 更新事件状态  
</span><span class='line'>&#9;return mask;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>static long do_restart_poll(struct restart_block *restart_block)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct pollfd __user *ufds = restart_block-&gt;poll.ufds;  
</span><span class='line'>&#9;int nfds = restart_block-&gt;poll.nfds;  
</span><span class='line'>&#9;struct timespec *to = NULL, end_time;  
</span><span class='line'>&#9;int ret;  
</span><span class='line'>&#9;if (restart_block-&gt;poll.has_timeout) {  
</span><span class='line'>&#9;&#9;// 获取先前的超时时间  
</span><span class='line'>&#9;&#9;end_time.tv_sec = restart_block-&gt;poll.tv_sec;  
</span><span class='line'>&#9;&#9;end_time.tv_nsec = restart_block-&gt;poll.tv_nsec;  
</span><span class='line'>&#9;&#9;to = &end_time;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;ret = do_sys_poll(ufds, nfds, to); // 重新调用 do_sys_poll  
</span><span class='line'>&#9;if (ret == -EINTR) {  
</span><span class='line'>&#9;&#9;// 又被信号中断了, 再次重启  
</span><span class='line'>&#9;&#9;restart_block-&gt;fn = do_restart_poll;  
</span><span class='line'>&#9;&#9;ret = -ERESTART_RESTARTBLOCK;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return ret;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h2>select 实现</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef struct {  
</span><span class='line'>&#9;unsigned long *in, *out, *ex;  
</span><span class='line'>&#9;unsigned long *res_in, *res_out, *res_ex;  
</span><span class='line'>} fd_set_bits;  
</span><span class='line'>//  long sys_select(int n, fd_set *inp, fd_set *outp, fd_set *exp, struct timeval *tvp)  
</span><span class='line'>SYSCALL_DEFINE5(select, int, n, fd_set __user *, inp, fd_set __user *, outp,  
</span><span class='line'>&#9;&#9;&#9;&#9;fd_set __user *, exp, struct timeval __user *, tvp)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct timespec end_time, *to = NULL;  
</span><span class='line'>&#9;struct timeval tv;  
</span><span class='line'>&#9;int ret;  
</span><span class='line'>&#9;if (tvp) {  
</span><span class='line'>&#9;&#9;if (copy_from_user(&tv, tvp, sizeof(tv))) {  
</span><span class='line'>&#9;&#9;&#9;return -EFAULT;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 计算超时时间  
</span><span class='line'>&#9;&#9;to = &end_time;  
</span><span class='line'>&#9;&#9;if (poll_select_set_timeout(to,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;tv.tv_sec + (tv.tv_usec / USEC_PER_SEC),  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;(tv.tv_usec % USEC_PER_SEC) * NSEC_PER_USEC)) {  
</span><span class='line'>&#9;&#9;&#9;return -EINVAL;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;ret = core_sys_select(n, inp, outp, exp, to);  
</span><span class='line'>&#9;// 复制剩余时间到用户空间  
</span><span class='line'>&#9;ret = poll_select_copy_remaining(&end_time, tvp, 1, ret);  
</span><span class='line'>&#9;return ret;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>int core_sys_select(int n, fd_set __user *inp, fd_set __user *outp,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;fd_set __user *exp, struct timespec *end_time)  
</span><span class='line'>{  
</span><span class='line'>&#9;fd_set_bits fds;  
</span><span class='line'>&#9;void *bits;  
</span><span class='line'>&#9;int ret, max_fds;  
</span><span class='line'>&#9;unsigned int size;  
</span><span class='line'>&#9;struct fdtable *fdt;  
</span><span class='line'>&#9;//小对象使用栈上的空间,节约内存, 加快访问速度  
</span><span class='line'>&#9;long stack_fds[SELECT_STACK_ALLOC/sizeof(long)];  
</span><span class='line'>  
</span><span class='line'>&#9;ret = -EINVAL;  
</span><span class='line'>&#9;if (n &lt; 0) {  
</span><span class='line'>&#9;&#9;goto out_nofds;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;rcu_read_lock();  
</span><span class='line'>&#9;// 取得进程对应的 fdtable  
</span><span class='line'>&#9;fdt = files_fdtable(current-&gt;files);  
</span><span class='line'>&#9;max_fds = fdt-&gt;max_fds;  
</span><span class='line'>&#9;rcu_read_unlock();  
</span><span class='line'>&#9;if (n &gt; max_fds) {  
</span><span class='line'>&#9;&#9;n = max_fds;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;size = FDS_BYTES(n);  
</span><span class='line'>&#9;bits = stack_fds;  
</span><span class='line'>&#9;if (size &gt; sizeof(stack_fds) / 6) {  
</span><span class='line'>&#9;&#9;// 栈上的空间不够, 申请内存, 全部使用堆上的空间  
</span><span class='line'>&#9;&#9;ret = -ENOMEM;  
</span><span class='line'>&#9;&#9;bits = kmalloc(6 * size, GFP_KERNEL);  
</span><span class='line'>&#9;&#9;if (!bits) {  
</span><span class='line'>&#9;&#9;&#9;goto out_nofds;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;fds.in     = bits;  
</span><span class='line'>&#9;fds.out    = bits +   size;  
</span><span class='line'>&#9;fds.ex     = bits + 2*size;  
</span><span class='line'>&#9;fds.res_in  = bits + 3*size;  
</span><span class='line'>&#9;fds.res_out = bits + 4*size;  
</span><span class='line'>&#9;fds.res_ex  = bits + 5*size;  
</span><span class='line'>  
</span><span class='line'>&#9;// 复制用户空间到内核  
</span><span class='line'>&#9;if ((ret = get_fd_set(n, inp, fds.in)) ||  
</span><span class='line'>&#9;&#9;&#9;(ret = get_fd_set(n, outp, fds.out)) ||  
</span><span class='line'>&#9;&#9;&#9;(ret = get_fd_set(n, exp, fds.ex))) {  
</span><span class='line'>&#9;&#9;goto out;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 初始化fd set  
</span><span class='line'>&#9;zero_fd_set(n, fds.res_in);  
</span><span class='line'>&#9;zero_fd_set(n, fds.res_out);  
</span><span class='line'>&#9;zero_fd_set(n, fds.res_ex);  
</span><span class='line'>  
</span><span class='line'>&#9;ret = do_select(n, &fds, end_time);  
</span><span class='line'>  
</span><span class='line'>&#9;if (ret &lt; 0) {  
</span><span class='line'>&#9;&#9;goto out;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;if (!ret) {  
</span><span class='line'>&#9;&#9;// 该返回值会被系统捕获, 并以同样的参数重新调用sys_select()  
</span><span class='line'>&#9;&#9;ret = -ERESTARTNOHAND;  
</span><span class='line'>&#9;&#9;if (signal_pending(current)) {  
</span><span class='line'>&#9;&#9;&#9;goto out;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;ret = 0;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 复制到用户空间  
</span><span class='line'>&#9;if (set_fd_set(n, inp, fds.res_in) ||  
</span><span class='line'>&#9;&#9;&#9;set_fd_set(n, outp, fds.res_out) ||  
</span><span class='line'>&#9;&#9;&#9;set_fd_set(n, exp, fds.res_ex)) {  
</span><span class='line'>&#9;&#9;ret = -EFAULT;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>out:  
</span><span class='line'>&#9;if (bits != stack_fds) {  
</span><span class='line'>&#9;&#9;kfree(bits);  
</span><span class='line'>&#9;}  
</span><span class='line'>out_nofds:  
</span><span class='line'>&#9;return ret;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>int do_select(int n, fd_set_bits *fds, struct timespec *end_time)  
</span><span class='line'>{  
</span><span class='line'>&#9;ktime_t expire, *to = NULL;  
</span><span class='line'>&#9;struct poll_wqueues table;  
</span><span class='line'>&#9;poll_table *wait;  
</span><span class='line'>&#9;int retval, i, timed_out = 0;  
</span><span class='line'>&#9;unsigned long slack = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;rcu_read_lock();  
</span><span class='line'>&#9;// 检查fds中fd的有效性, 并获取当前最大的fd  
</span><span class='line'>&#9;retval = max_select_fd(n, fds);  
</span><span class='line'>&#9;rcu_read_unlock();  
</span><span class='line'>  
</span><span class='line'>&#9;if (retval &lt; 0) {  
</span><span class='line'>&#9;&#9;return retval;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;n = retval;  
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化 poll_wqueues 结构, 设置函数指针_qproc    为__pollwait  
</span><span class='line'>&#9;poll_initwait(&table);  
</span><span class='line'>&#9;wait = &table.pt;  
</span><span class='line'>&#9;if (end_time && !end_time-&gt;tv_sec && !end_time-&gt;tv_nsec) {  
</span><span class='line'>&#9;&#9;wait = NULL;  
</span><span class='line'>&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;if (end_time && !timed_out) {  
</span><span class='line'>&#9;&#9;// 估计需要等待的时间.  
</span><span class='line'>&#9;&#9;slack = select_estimate_accuracy(end_time);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;retval = 0;  
</span><span class='line'>&#9;for (;;) {  
</span><span class='line'>&#9;&#9;unsigned long *rinp, *routp, *rexp, *inp, *outp, *exp;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;inp = fds-&gt;in;  
</span><span class='line'>&#9;&#9;outp = fds-&gt;out;  
</span><span class='line'>&#9;&#9;exp = fds-&gt;ex;  
</span><span class='line'>&#9;&#9;rinp = fds-&gt;res_in;  
</span><span class='line'>&#9;&#9;routp = fds-&gt;res_out;  
</span><span class='line'>&#9;&#9;rexp = fds-&gt;res_ex;  
</span><span class='line'>&#9;&#9;// 遍历所有的描述符, i 文件描述符  
</span><span class='line'>&#9;&#9;for (i = 0; i &lt; n; ++rinp, ++routp, ++rexp) {  
</span><span class='line'>&#9;&#9;&#9;unsigned long in, out, ex, all_bits, bit = 1, mask, j;  
</span><span class='line'>&#9;&#9;&#9;unsigned long res_in = 0, res_out = 0, res_ex = 0;  
</span><span class='line'>&#9;&#9;&#9;const struct file_operations *f_op = NULL;  
</span><span class='line'>&#9;&#9;&#9;struct file *file = NULL;  
</span><span class='line'>&#9;&#9;&#9;// 检查当前的 slot 中的描述符  
</span><span class='line'>&#9;&#9;&#9;in = *inp++;  
</span><span class='line'>&#9;&#9;&#9;out = *outp++;  
</span><span class='line'>&#9;&#9;&#9;ex = *exp++;  
</span><span class='line'>&#9;&#9;&#9;all_bits = in | out | ex;  
</span><span class='line'>&#9;&#9;&#9;if (all_bits == 0) { // 没有需要监听的描述符, 下一个slot  
</span><span class='line'>&#9;&#9;&#9;&#9;i += __NFDBITS;  
</span><span class='line'>&#9;&#9;&#9;&#9;continue;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;for (j = 0; j &lt; __NFDBITS; ++j, ++i, bit &lt;&lt;= 1) {  
</span><span class='line'>&#9;&#9;&#9;&#9;int fput_needed;  
</span><span class='line'>&#9;&#9;&#9;&#9;if (i &gt;= n) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;// 不需要监听描述符 i  
</span><span class='line'>&#9;&#9;&#9;&#9;if (!(bit & all_bits)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;continue;  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;// 取得文件结构  
</span><span class='line'>&#9;&#9;&#9;&#9;file = fget_light(i, &fput_needed);  
</span><span class='line'>&#9;&#9;&#9;&#9;if (file) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;f_op = file-&gt;f_op;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 没有 f_op 的话就认为一直处于就绪状态  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;mask = DEFAULT_POLLMASK;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (f_op && f_op-&gt;poll) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;// 设置等待事件的掩码  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait_key_set(wait, in, out, bit);  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;/* 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;static inline void wait_key_set(poll_table *wait, unsigned long in, 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;unsigned long out, unsigned long bit) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;{ 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait-&gt;_key = POLLEX_SET;// (POLLPRI) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;if (in & bit) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait-&gt;_key |= POLLIN_SET;//(POLLRDNORM | POLLRDBAND | POLLIN | POLLHUP | POLLERR) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;if (out & bit) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait-&gt;_key |= POLLOUT_SET;//POLLOUT_SET (POLLWRBAND | POLLWRNORM | POLLOUT | POLLERR) 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;} 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;*/  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;// 获取当前的就绪状态, 并添加到文件的对应等待队列中  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;mask = (*f_op-&gt;poll)(file, wait);  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;// 和poll完全一样  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;fput_light(file, fput_needed);  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 释放文件  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;// 检查文件 i 是否已有事件就绪，  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if ((mask & POLLIN_SET) && (in & bit)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;res_in |= bit;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;retval++;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;// 如果已有就绪事件就不再向其他文件的  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;// 等待队列中添加回调函数  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait = NULL;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if ((mask & POLLOUT_SET) && (out & bit)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;res_out |= bit;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;retval++;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait = NULL;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if ((mask & POLLEX_SET) && (ex & bit)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;res_ex |= bit;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;retval++;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;wait = NULL;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;if (res_in) {  
</span><span class='line'>&#9;&#9;&#9;&#9;*rinp = res_in;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;if (res_out) {  
</span><span class='line'>&#9;&#9;&#9;&#9;*routp = res_out;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;if (res_ex) {  
</span><span class='line'>&#9;&#9;&#9;&#9;*rexp = res_ex;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;cond_resched();  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;wait = NULL; // 该添加回调函数的都已经添加了  
</span><span class='line'>&#9;&#9;if (retval || timed_out || signal_pending(current)) {  
</span><span class='line'>&#9;&#9;&#9;break;   // 信号发生，监听事件就绪或超时  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;if (table.error) {  
</span><span class='line'>&#9;&#9;&#9;retval = table.error; // 产生错误了  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 转换到内核时间  
</span><span class='line'>&#9;&#9;if (end_time && !to) {  
</span><span class='line'>&#9;&#9;&#9;expire = timespec_to_ktime(*end_time);  
</span><span class='line'>&#9;&#9;&#9;to = &expire;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 等待直到超时, 或由回调函数唤醒, 超时后会再次遍历文件描述符  
</span><span class='line'>&#9;&#9;if (!poll_schedule_timeout(&table, TASK_INTERRUPTIBLE,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   to, slack)) {  
</span><span class='line'>&#9;&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;poll_freewait(&table);  
</span><span class='line'>  
</span><span class='line'>&#9;return retval;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h2>epoll实现</h2>

<p>epoll 的实现比poll/select 复杂一些，这是因为：</p>

<ol>
<li>epoll_wait, epoll_ctl 的调用完全独立开来,内核需要锁机制对这些操作进行保护，并且需要持久的维护添加到epoll的文件</li>
<li>epoll本身也是文件，也可以被poll/select/epoll监视，这可能导致epoll之间循环唤醒的问题</li>
<li>单个文件的状态改变可能唤醒过多监听在其上的epoll，产生唤醒风暴</li>
</ol>


<p>epoll各个功能的实现要非常小心面对这些问题，使得复杂度大大增加。</p>

<h3>epoll的核心数据结构</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// epoll的核心实现对应于一个epoll描述符  
</span><span class='line'>struct eventpoll {  
</span><span class='line'>&#9;spinlock_t lock;  
</span><span class='line'>&#9;struct mutex mtx;  
</span><span class='line'>&#9;wait_queue_head_t wq; // sys_epoll_wait() 等待在这里  
</span><span class='line'>&#9;// f_op-&gt;poll()  使用的, 被其他事件通知机制利用的wait_address  
</span><span class='line'>&#9;wait_queue_head_t poll_wait;  
</span><span class='line'>&#9;/* 已就绪的需要检查的epitem 列表 */  
</span><span class='line'>&#9;struct list_head rdllist;  
</span><span class='line'>&#9;/* 保存所有加入到当前epoll的文件对应的epitem*/  
</span><span class='line'>&#9;struct rb_root rbr;  
</span><span class='line'>&#9;// 当正在向用户空间复制数据时, 产生的可用文件  
</span><span class='line'>&#9;struct epitem *ovflist;  
</span><span class='line'>&#9;/* The user that created the eventpoll descriptor */  
</span><span class='line'>&#9;struct user_struct *user;  
</span><span class='line'>&#9;struct file *file;  
</span><span class='line'>&#9;/*优化循环检查，避免循环检查中重复的遍历 */  
</span><span class='line'>&#9;int visited;  
</span><span class='line'>&#9;struct list_head visited_list_link;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// 对应于一个加入到epoll的文件  
</span><span class='line'>struct epitem {  
</span><span class='line'>&#9;// 挂载到eventpoll 的红黑树节点  
</span><span class='line'>&#9;struct rb_node rbn;  
</span><span class='line'>&#9;// 挂载到eventpoll.rdllist 的节点  
</span><span class='line'>&#9;struct list_head rdllink;  
</span><span class='line'>&#9;// 连接到ovflist 的指针  
</span><span class='line'>&#9;struct epitem *next;  
</span><span class='line'>&#9;/* 文件描述符信息fd + file, 红黑树的key */  
</span><span class='line'>&#9;struct epoll_filefd ffd;  
</span><span class='line'>&#9;/* Number of active wait queue attached to poll operations */  
</span><span class='line'>&#9;int nwait;  
</span><span class='line'>&#9;// 当前文件的等待队列(eppoll_entry)列表  
</span><span class='line'>&#9;// 同一个文件上可能会监视多种事件,  
</span><span class='line'>&#9;// 这些事件可能属于不同的wait_queue中  
</span><span class='line'>&#9;// (取决于对应文件类型的实现),  
</span><span class='line'>&#9;// 所以需要使用链表  
</span><span class='line'>&#9;struct list_head pwqlist;  
</span><span class='line'>&#9;// 当前epitem 的所有者  
</span><span class='line'>&#9;struct eventpoll *ep;  
</span><span class='line'>&#9;/* List header used to link this item to the &quot;struct file&quot; items list */  
</span><span class='line'>&#9;struct list_head fllink;  
</span><span class='line'>&#9;/* epoll_ctl 传入的用户数据 */  
</span><span class='line'>&#9;struct epoll_event event;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>struct epoll_filefd {  
</span><span class='line'>&#9;struct file *file;  
</span><span class='line'>&#9;int fd;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// 与一个文件上的一个wait_queue_head 相关联，因为同一文件可能有多个等待的事件，这些事件可能使用不同的等待队列  
</span><span class='line'>struct eppoll_entry {  
</span><span class='line'>&#9;// List struct epitem.pwqlist  
</span><span class='line'>&#9;struct list_head llink;  
</span><span class='line'>&#9;// 所有者  
</span><span class='line'>&#9;struct epitem *base;  
</span><span class='line'>&#9;// 添加到wait_queue 中的节点  
</span><span class='line'>&#9;wait_queue_t wait;  
</span><span class='line'>&#9;// 文件wait_queue 头  
</span><span class='line'>&#9;wait_queue_head_t *whead;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// 用户使用的epoll_event  
</span><span class='line'>struct epoll_event {  
</span><span class='line'>&#9;__u32 events;  
</span><span class='line'>&#9;__u64 data;  
</span><span class='line'>} EPOLL_PACKED;  </span></code></pre></td></tr></table></div></figure>


<h3>文件系统初始化和epoll_create</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// epoll 文件系统的相关实现  
</span><span class='line'>// epoll 文件系统初始化, 在系统启动时会调用  
</span><span class='line'>  
</span><span class='line'>static int __init eventpoll_init(void)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct sysinfo si;  
</span><span class='line'>  
</span><span class='line'>&#9;si_meminfo(&si);  
</span><span class='line'>&#9;// 限制可添加到epoll的最多的描述符数量  
</span><span class='line'>  
</span><span class='line'>&#9;max_user_watches = (((si.totalram - si.totalhigh) / 25) &lt;&lt; PAGE_SHIFT) /  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   EP_ITEM_COST;  
</span><span class='line'>&#9;BUG_ON(max_user_watches &lt; 0);  
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化递归检查队列  
</span><span class='line'>   ep_nested_calls_init(&poll_loop_ncalls);  
</span><span class='line'>&#9;ep_nested_calls_init(&poll_safewake_ncalls);  
</span><span class='line'>&#9;ep_nested_calls_init(&poll_readywalk_ncalls);  
</span><span class='line'>&#9;// epoll 使用的slab分配器分别用来分配epitem和eppoll_entry  
</span><span class='line'>&#9;epi_cache = kmem_cache_create("eventpoll_epi", sizeof(struct epitem),  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;  0, SLAB_HWCACHE_ALIGN | SLAB_PANIC, NULL);  
</span><span class='line'>&#9;pwq_cache = kmem_cache_create("eventpoll_pwq",  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;  sizeof(struct eppoll_entry), 0, SLAB_PANIC, NULL);  
</span><span class='line'>  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>SYSCALL_DEFINE1(epoll_create, int, size)  
</span><span class='line'>{  
</span><span class='line'>&#9;if (size &lt;= 0) {  
</span><span class='line'>&#9;&#9;return -EINVAL;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;return sys_epoll_create1(0);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>SYSCALL_DEFINE1(epoll_create1, int, flags)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error, fd;  
</span><span class='line'>&#9;struct eventpoll *ep = NULL;  
</span><span class='line'>&#9;struct file *file;  
</span><span class='line'>  
</span><span class='line'>&#9;/* Check the EPOLL_* constant for consistency.  */  
</span><span class='line'>&#9;BUILD_BUG_ON(EPOLL_CLOEXEC != O_CLOEXEC);  
</span><span class='line'>  
</span><span class='line'>&#9;if (flags & ~EPOLL_CLOEXEC) {  
</span><span class='line'>&#9;&#9;return -EINVAL;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Create the internal data structure ("struct eventpoll"). 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;error = ep_alloc(&ep);  
</span><span class='line'>&#9;if (error &lt; 0) {  
</span><span class='line'>&#9;&#9;return error;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Creates all the items needed to setup an eventpoll file. That is, 
</span><span class='line'>&#9; * a file structure and a free file descriptor. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;fd = get_unused_fd_flags(O_RDWR | (flags & O_CLOEXEC));  
</span><span class='line'>&#9;if (fd &lt; 0) {  
</span><span class='line'>&#9;&#9; error = fd;  
</span><span class='line'>&#9;&#9; goto out_free_ep;  
</span><span class='line'>&#9;  }  
</span><span class='line'>&#9;  // 设置epfd的相关操作，由于epoll也是文件也提供了poll操作  
</span><span class='line'>&#9;file = anon_inode_getfile("[eventpoll]", &eventpoll_fops, ep,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;  O_RDWR | (flags & O_CLOEXEC));  
</span><span class='line'>&#9;if (IS_ERR(file)) {  
</span><span class='line'>&#9;&#9;error = PTR_ERR(file);  
</span><span class='line'>&#9;&#9;goto out_free_fd;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;fd_install(fd, file);  
</span><span class='line'>&#9;ep-&gt;file = file;  
</span><span class='line'>&#9;return fd;  
</span><span class='line'>  
</span><span class='line'>out_free_fd:  
</span><span class='line'>&#9;put_unused_fd(fd);  
</span><span class='line'>out_free_ep:  
</span><span class='line'>&#9;ep_free(ep);  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h3>epoll中的递归死循环和深度检查</h3>

<h4>递归深度检测(ep_call_nested)</h4>

<p>epoll本身也是文件，也可以被poll/select/epoll监视，如果epoll之间互相监视就有可能导致死循环。epoll的实现中，所有可能产生递归调用的函数都由函函数ep_call_nested进行包裹，递归调用过程中出现死循环或递归过深就会打破死循环和递归调用直接返回。该函数的实现依赖于一个外部的全局链表nested_call_node(不同的函数调用使用不同的节点)，每次调用可能发生递归的函数(nproc)就向链表中添加一个包含当前函数调用上下文ctx(进程，CPU，或epoll文件)和处理的对象标识cookie的节点，通过检测是否有相同的节点就可以知道是否发生了死循环，检查链表中同一上下文包含的节点个数就可以知道递归的深度。以下就是这一过程的源码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct nested_call_node {  
</span><span class='line'>&#9;struct list_head llink;  
</span><span class='line'>&#9;void *cookie;   // 函数运行标识, 任务标志  
</span><span class='line'>&#9;void *ctx;      // 运行环境标识  
</span><span class='line'>};  
</span><span class='line'>struct nested_calls {  
</span><span class='line'>&#9;struct list_head tasks_call_list;  
</span><span class='line'>&#9;spinlock_t lock;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>// 全局的不同调用使用的链表  
</span><span class='line'>// 死循环检查和唤醒风暴检查链表  
</span><span class='line'>static nested_call_node poll_loop_ncalls;  
</span><span class='line'>// 唤醒时使用的检查链表  
</span><span class='line'>static nested_call_node poll_safewake_ncalls;  
</span><span class='line'>// 扫描readylist 时使用的链表  
</span><span class='line'>static nested_call_node poll_readywalk_ncalls;  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>// 限制epoll 中直接或间接递归调用的深度并防止死循环  
</span><span class='line'>// ctx: 任务运行上下文(进程, CPU 等)  
</span><span class='line'>// cookie: 每个任务的标识  
</span><span class='line'>// priv: 任务运行需要的私有数据  
</span><span class='line'>// 如果用面向对象语言实现应该就会是一个wapper类  
</span><span class='line'>static int ep_call_nested(struct nested_calls *ncalls, int max_nests,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;  int (*nproc)(void *, void *, int), void *priv,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;  void *cookie, void *ctx)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error, call_nests = 0;  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>&#9;struct list_head *lsthead = &ncalls-&gt;tasks_call_list;  
</span><span class='line'>&#9;struct nested_call_node *tncur;  
</span><span class='line'>&#9;struct nested_call_node tnode;  
</span><span class='line'>&#9;spin_lock_irqsave(&ncalls-&gt;lock, flags);  
</span><span class='line'>&#9;// 检查原有的嵌套调用链表ncalls, 查看是否有深度超过限制的情况  
</span><span class='line'>&#9;list_for_each_entry(tncur, lsthead, llink) {  
</span><span class='line'>&#9;&#9;// 同一上下文中(ctx)有相同的任务(cookie)说明产生了死循环  
</span><span class='line'>&#9;&#9;// 同一上下文的递归深度call_nests 超过限制  
</span><span class='line'>&#9;&#9;if (tncur-&gt;ctx == ctx &&  
</span><span class='line'>&#9;&#9;&#9;&#9;(tncur-&gt;cookie == cookie || ++call_nests &gt; max_nests)) {  
</span><span class='line'>&#9;&#9;&#9;error = -1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;goto out_unlock;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;/* 将当前的任务请求添加到调用列表*/  
</span><span class='line'>&#9;tnode.ctx = ctx;  
</span><span class='line'>&#9;tnode.cookie = cookie;  
</span><span class='line'>&#9;list_add(&tnode.llink, lsthead);  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ncalls-&gt;lock, flags);  
</span><span class='line'>&#9;/* nproc 可能会导致递归调用(直接或间接)ep_call_nested 
</span><span class='line'>&#9;&#9; * 如果发生递归调用, 那么在此函数返回之前, 
</span><span class='line'>&#9;&#9; * ncalls 又会被加入额外的节点, 
</span><span class='line'>&#9;&#9; * 这样通过前面的检测就可以知道递归调用的深度 
</span><span class='line'>&#9;  */  
</span><span class='line'>&#9;error = (*nproc)(priv, cookie, call_nests);  
</span><span class='line'>&#9;/* 从链表中删除当前任务*/  
</span><span class='line'>&#9;spin_lock_irqsave(&ncalls-&gt;lock, flags);  
</span><span class='line'>&#9;list_del(&tnode.llink);  
</span><span class='line'>out_unlock:  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ncalls-&gt;lock, flags);  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>循环检测(ep_loop_check)</h4>

<p>循环检查(ep_loop_check)，该函数递归调用ep_loop_check_proc利用ep_call_nested来实现epoll之间相互监视的死循环。因为ep_call_nested中已经对死循环和过深的递归做了检查，实际的ep_loop_check_proc的实现只是递归调用自己。其中的visited_list和visited标记完全是为了优化处理速度，如果没有visited_list和visited标记函数也是能够工作的。该函数中得上下文就是当前的进程，cookie就是正在遍历的epoll结构。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static LIST_HEAD(visited_list);  
</span><span class='line'>// 检查 file (epoll)和ep 之间是否有循环  
</span><span class='line'>static int ep_loop_check(struct eventpoll *ep, struct file *file)  
</span><span class='line'>{  
</span><span class='line'>&#9;int ret;  
</span><span class='line'>&#9;struct eventpoll *ep_cur, *ep_next;  
</span><span class='line'>  
</span><span class='line'>&#9;ret = ep_call_nested(&poll_loop_ncalls, EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9; ep_loop_check_proc, file, ep, current);  
</span><span class='line'>&#9;/* 清除链表和标志 */  
</span><span class='line'>&#9;list_for_each_entry_safe(ep_cur, ep_next, &visited_list,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9; visited_list_link) {  
</span><span class='line'>&#9;&#9;ep_cur-&gt;visited = 0;  
</span><span class='line'>&#9;&#9;list_del(&ep_cur-&gt;visited_list_link);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return ret;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_loop_check_proc(void *priv, void *cookie, int call_nests)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error = 0;  
</span><span class='line'>&#9;struct file *file = priv;  
</span><span class='line'>&#9;struct eventpoll *ep = file-&gt;private_data;  
</span><span class='line'>&#9;struct eventpoll *ep_tovisit;  
</span><span class='line'>&#9;struct rb_node *rbp;  
</span><span class='line'>&#9;struct epitem *epi;  
</span><span class='line'>  
</span><span class='line'>&#9;mutex_lock_nested(&ep-&gt;mtx, call_nests + 1);  
</span><span class='line'>&#9;// 标记当前为已遍历  
</span><span class='line'>&#9;ep-&gt;visited = 1;  
</span><span class='line'>&#9;list_add(&ep-&gt;visited_list_link, &visited_list);  
</span><span class='line'>&#9;// 遍历所有ep 监视的文件  
</span><span class='line'>&#9;for (rbp = rb_first(&ep-&gt;rbr); rbp; rbp = rb_next(rbp)) {  
</span><span class='line'>&#9;&#9;epi = rb_entry(rbp, struct epitem, rbn);  
</span><span class='line'>&#9;&#9;if (unlikely(is_file_epoll(epi-&gt;ffd.file))) {  
</span><span class='line'>&#9;&#9;&#9;ep_tovisit = epi-&gt;ffd.file-&gt;private_data;  
</span><span class='line'>&#9;&#9;&#9;// 跳过先前已遍历的, 避免循环检查  
</span><span class='line'>&#9;&#9;&#9;if (ep_tovisit-&gt;visited) {  
</span><span class='line'>&#9;&#9;&#9;&#9;continue;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;// 所有ep监视的未遍历的epoll  
</span><span class='line'>&#9;&#9;&#9;error = ep_call_nested(&poll_loop_ncalls, EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   ep_loop_check_proc, epi-&gt;ffd.file,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   ep_tovisit, current);  
</span><span class='line'>&#9;&#9;&#9;if (error != 0) {  
</span><span class='line'>&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;// 文件不在tfile_check_list 中, 添加  
</span><span class='line'>&#9;&#9;&#9;// 最外层的epoll 需要检查子epoll监视的文件  
</span><span class='line'>&#9;&#9;&#9;if (list_empty(&epi-&gt;ffd.file-&gt;f_tfile_llink))  
</span><span class='line'>&#9;&#9;&#9;&#9;list_add(&epi-&gt;ffd.file-&gt;f_tfile_llink,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9; &tfile_check_list);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;mutex_unlock(&ep-&gt;mtx);  
</span><span class='line'>  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>唤醒风暴检测（reverse_path_check）</h4>

<p> 当文件状态发生改变时，会唤醒监听在其上的epoll文件，而这个epoll文件还可能唤醒其他的epoll文件，这种连续的唤醒就形成了一个唤醒路径，所有的唤醒路径就形成了一个有向图。如果文件对应的epoll唤醒有向图的节点过多，那么文件状态的改变就会唤醒所有的这些epoll(可能会唤醒很多进程，这样的开销是很大的)，而实际上一个文件经过少数epoll处理以后就可能从就绪转到未就绪，剩余的epoll虽然认为文件已就绪而实际上经过某些处理后已不可用。epoll的实现中考虑到了此问题，在每次添加新文件到epoll中时，就会首先检查是否会出现这样的唤醒风暴。</p>

<p>该函数的实现逻辑是这样的，递归调用reverse_path_check_proc遍历监听在当前文件上的epoll文件，在reverse_pach_check_proc中统计并检查不同路径深度上epoll的个数，从而避免产生唤醒风暴。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define PATH_ARR_SIZE 5  
</span><span class='line'>// 在EPOLL_CTL_ADD 时, 检查是否有可能产生唤醒风暴  
</span><span class='line'>// epoll 允许的单个文件的唤醒深度小于5, 例如  
</span><span class='line'>// 一个文件最多允许唤醒1000个深度为1的epoll描述符,  
</span><span class='line'>//允许所有被单个文件直接唤醒的epoll描述符再次唤醒的epoll描述符总数是500  
</span><span class='line'>//  
</span><span class='line'>  
</span><span class='line'>// 深度限制  
</span><span class='line'>static const int path_limits[PATH_ARR_SIZE] = { 1000, 500, 100, 50, 10 };  
</span><span class='line'>// 计算出来的深度  
</span><span class='line'>static int path_count[PATH_ARR_SIZE];  
</span><span class='line'>  
</span><span class='line'>static int path_count_inc(int nests)  
</span><span class='line'>{  
</span><span class='line'>&#9;/* Allow an arbitrary number of depth 1 paths */  
</span><span class='line'>&#9;if (nests == 0) {  
</span><span class='line'>&#9;&#9;return 0;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;if (++path_count[nests] &gt; path_limits[nests]) {  
</span><span class='line'>&#9;&#9;return -1;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static void path_count_init(void)  
</span><span class='line'>{  
</span><span class='line'>&#9;int i;  
</span><span class='line'>  
</span><span class='line'>&#9;for (i = 0; i &lt; PATH_ARR_SIZE; i++) {  
</span><span class='line'>&#9;&#9;path_count[i] = 0;  
</span><span class='line'>&#9;}  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>// 唤醒风暴检查函数  
</span><span class='line'>static int reverse_path_check(void)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error = 0;  
</span><span class='line'>&#9;struct file *current_file;  
</span><span class='line'>  
</span><span class='line'>&#9;/* let's call this for all tfiles */  
</span><span class='line'>&#9;// 遍历全局tfile_check_list 中的文件, 第一级  
</span><span class='line'>&#9;list_for_each_entry(current_file, &tfile_check_list, f_tfile_llink) {  
</span><span class='line'>&#9;&#9;// 初始化  
</span><span class='line'>&#9;&#9;path_count_init();  
</span><span class='line'>&#9;&#9;// 限制递归的深度, 并检查每个深度上唤醒的epoll 数量  
</span><span class='line'>&#9;&#9;error = ep_call_nested(&poll_loop_ncalls, EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;   reverse_path_check_proc, current_file,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;   current_file, current);  
</span><span class='line'>&#9;&#9;if (error) {  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  
</span><span class='line'>static int reverse_path_check_proc(void *priv, void *cookie, int call_nests)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error = 0;  
</span><span class='line'>&#9;struct file *file = priv;  
</span><span class='line'>&#9;struct file *child_file;  
</span><span class='line'>&#9;struct epitem *epi;  
</span><span class='line'>  
</span><span class='line'>&#9;list_for_each_entry(epi, &file-&gt;f_ep_links, fllink) {  
</span><span class='line'>&#9;&#9;// 遍历监视file 的epoll  
</span><span class='line'>&#9;&#9;child_file = epi-&gt;ep-&gt;file;  
</span><span class='line'>&#9;&#9;if (is_file_epoll(child_file)) {  
</span><span class='line'>&#9;&#9;&#9;if (list_empty(&child_file-&gt;f_ep_links)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;// 没有其他的epoll监视当前的这个epoll,  
</span><span class='line'>&#9;&#9;&#9;&#9;// 已经是叶子了  
</span><span class='line'>&#9;&#9;&#9;&#9;if (path_count_inc(call_nests)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;error = -1;  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;&#9;// 遍历监视这个epoll 文件的epoll,  
</span><span class='line'>&#9;&#9;&#9;&#9;// 递归调用  
</span><span class='line'>&#9;&#9;&#9;&#9;error = ep_call_nested(&poll_loop_ncalls,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   reverse_path_check_proc,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   child_file, child_file,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;   current);  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;if (error != 0) {  
</span><span class='line'>&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;// 不是epoll , 不可能吧?  
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "reverse_path_check_proc: "  
</span><span class='line'>&#9;&#9;&#9;&#9;   "file is not an ep!\n");  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>epoll 的唤醒过程</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void ep_poll_safewake(wait_queue_head_t *wq)  
</span><span class='line'>{  
</span><span class='line'>&#9;int this_cpu = get_cpu();  
</span><span class='line'>  
</span><span class='line'>&#9;ep_call_nested(&poll_safewake_ncalls, EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;   ep_poll_wakeup_proc, NULL, wq, (void *) (long) this_cpu);  
</span><span class='line'>  
</span><span class='line'>&#9;put_cpu();  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_poll_wakeup_proc(void *priv, void *cookie, int call_nests)  
</span><span class='line'>{  
</span><span class='line'>&#9;ep_wake_up_nested((wait_queue_head_t *) cookie, POLLIN,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;  1 + call_nests);  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static inline void ep_wake_up_nested(wait_queue_head_t *wqueue,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9; unsigned long events, int subclass)  
</span><span class='line'>{  
</span><span class='line'>&#9;// 这回唤醒所有正在等待此epfd 的select/epoll/poll 等  
</span><span class='line'>&#9;// 如果唤醒的是epoll 就可能唤醒其他的epoll, 产生连锁反应  
</span><span class='line'>&#9;// 这个很可能在中断上下文中被调用  
</span><span class='line'>&#9;wake_up_poll(wqueue, events);  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h3>epoll_ctl</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// long epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);  
</span><span class='line'>  
</span><span class='line'>SYSCALL_DEFINE4(epoll_ctl, int, epfd, int, op, int, fd,  
</span><span class='line'>&#9;&#9;&#9;&#9;struct epoll_event __user *, event)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error;  
</span><span class='line'>&#9;int did_lock_epmutex = 0;  
</span><span class='line'>&#9;struct file *file, *tfile;  
</span><span class='line'>&#9;struct eventpoll *ep;  
</span><span class='line'>&#9;struct epitem *epi;  
</span><span class='line'>&#9;struct epoll_event epds;  
</span><span class='line'>  
</span><span class='line'>&#9;error = -EFAULT;  
</span><span class='line'>&#9;if (ep_op_has_event(op) &&  
</span><span class='line'>&#9;&#9;&#9;// 复制用户空间数据到内核  
</span><span class='line'>&#9;&#9;&#9;copy_from_user(&epds, event, sizeof(struct epoll_event))) {  
</span><span class='line'>&#9;&#9;goto error_return;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 取得 epfd 对应的文件  
</span><span class='line'>&#9;error = -EBADF;  
</span><span class='line'>&#9;file = fget(epfd);  
</span><span class='line'>&#9;if (!file) {  
</span><span class='line'>&#9;&#9;goto error_return;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 取得目标文件  
</span><span class='line'>&#9;tfile = fget(fd);  
</span><span class='line'>&#9;if (!tfile) {  
</span><span class='line'>&#9;&#9;goto error_fput;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 目标文件必须提供 poll 操作  
</span><span class='line'>&#9;error = -EPERM;  
</span><span class='line'>&#9;if (!tfile-&gt;f_op || !tfile-&gt;f_op-&gt;poll) {  
</span><span class='line'>&#9;&#9;goto error_tgt_fput;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 添加自身或epfd 不是epoll 句柄  
</span><span class='line'>&#9;error = -EINVAL;  
</span><span class='line'>&#9;if (file == tfile || !is_file_epoll(file)) {  
</span><span class='line'>&#9;&#9;goto error_tgt_fput;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 取得内部结构eventpoll  
</span><span class='line'>&#9;ep = file-&gt;private_data;  
</span><span class='line'>  
</span><span class='line'>&#9;// EPOLL_CTL_MOD 不需要加全局锁 epmutex  
</span><span class='line'>&#9;if (op == EPOLL_CTL_ADD || op == EPOLL_CTL_DEL) {  
</span><span class='line'>&#9;&#9;mutex_lock(&epmutex);  
</span><span class='line'>&#9;&#9;did_lock_epmutex = 1;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;if (op == EPOLL_CTL_ADD) {  
</span><span class='line'>&#9;&#9;if (is_file_epoll(tfile)) {  
</span><span class='line'>&#9;&#9;&#9;error = -ELOOP;  
</span><span class='line'>&#9;&#9;&#9;// 目标文件也是epoll 检测是否有循环包含的问题  
</span><span class='line'>&#9;&#9;&#9;if (ep_loop_check(ep, tfile) != 0) {  
</span><span class='line'>&#9;&#9;&#9;&#9;goto error_tgt_fput;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;} else  
</span><span class='line'>&#9;&#9;{  
</span><span class='line'>&#9;&#9;&#9;// 将目标文件添加到 epoll 全局的tfile_check_list 中  
</span><span class='line'>&#9;&#9;&#9;list_add(&tfile-&gt;f_tfile_llink, &tfile_check_list);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;mutex_lock_nested(&ep-&gt;mtx, 0);  
</span><span class='line'>  
</span><span class='line'>&#9;// 以tfile 和fd 为key 在rbtree 中查找文件对应的epitem  
</span><span class='line'>&#9;epi = ep_find(ep, tfile, fd);  
</span><span class='line'>  
</span><span class='line'>&#9;error = -EINVAL;  
</span><span class='line'>&#9;switch (op) {  
</span><span class='line'>&#9;case EPOLL_CTL_ADD:  
</span><span class='line'>&#9;&#9;if (!epi) {  
</span><span class='line'>&#9;&#9;&#9;// 没找到, 添加额外添加ERR HUP 事件  
</span><span class='line'>&#9;&#9;&#9;epds.events |= POLLERR | POLLHUP;  
</span><span class='line'>&#9;&#9;&#9;error = ep_insert(ep, &epds, tfile, fd);  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;error = -EEXIST;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 清空文件检查列表  
</span><span class='line'>&#9;&#9;clear_tfile_check_list();  
</span><span class='line'>&#9;&#9;break;  
</span><span class='line'>&#9;case EPOLL_CTL_DEL:  
</span><span class='line'>&#9;&#9;if (epi) {  
</span><span class='line'>&#9;&#9;&#9;error = ep_remove(ep, epi);  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;error = -ENOENT;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;break;  
</span><span class='line'>&#9;case EPOLL_CTL_MOD:  
</span><span class='line'>&#9;&#9;if (epi) {  
</span><span class='line'>&#9;&#9;&#9;epds.events |= POLLERR | POLLHUP;  
</span><span class='line'>&#9;&#9;&#9;error = ep_modify(ep, epi, &epds);  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;error = -ENOENT;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;break;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;mutex_unlock(&ep-&gt;mtx);  
</span><span class='line'>  
</span><span class='line'>error_tgt_fput:  
</span><span class='line'>&#9;if (did_lock_epmutex) {  
</span><span class='line'>&#9;&#9;mutex_unlock(&epmutex);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;fput(tfile);  
</span><span class='line'>error_fput:  
</span><span class='line'>&#9;fput(file);  
</span><span class='line'>error_return:  
</span><span class='line'>  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>EPOLL_CTL_ADD 实现</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// EPOLL_CTL_ADD  
</span><span class='line'>static int ep_insert(struct eventpoll *ep, struct epoll_event *event,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9; struct file *tfile, int fd)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error, revents, pwake = 0;  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>&#9;long user_watches;  
</span><span class='line'>&#9;struct epitem *epi;  
</span><span class='line'>&#9;struct ep_pqueue epq;  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9;struct ep_pqueue { 
</span><span class='line'>&#9;&#9;poll_table pt; 
</span><span class='line'>&#9;&#9;struct epitem *epi; 
</span><span class='line'>&#9;}; 
</span><span class='line'>&#9;*/  
</span><span class='line'>  
</span><span class='line'>&#9;// 增加监视文件数  
</span><span class='line'>&#9;user_watches = atomic_long_read(&ep-&gt;user-&gt;epoll_watches);  
</span><span class='line'>&#9;if (unlikely(user_watches &gt;= max_user_watches)) {  
</span><span class='line'>&#9;&#9;return -ENOSPC;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;// 分配初始化 epi  
</span><span class='line'>&#9;if (!(epi = kmem_cache_alloc(epi_cache, GFP_KERNEL))) {  
</span><span class='line'>&#9;&#9;return -ENOMEM;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;INIT_LIST_HEAD(&epi-&gt;rdllink);  
</span><span class='line'>&#9;INIT_LIST_HEAD(&epi-&gt;fllink);  
</span><span class='line'>&#9;INIT_LIST_HEAD(&epi-&gt;pwqlist);  
</span><span class='line'>&#9;epi-&gt;ep = ep;  
</span><span class='line'>&#9;// 初始化红黑树中的key  
</span><span class='line'>&#9;ep_set_ffd(&epi-&gt;ffd, tfile, fd);  
</span><span class='line'>&#9;// 直接复制用户结构  
</span><span class='line'>&#9;epi-&gt;event = *event;  
</span><span class='line'>&#9;epi-&gt;nwait = 0;  
</span><span class='line'>&#9;epi-&gt;next = EP_UNACTIVE_PTR;  
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化临时的 epq  
</span><span class='line'>&#9;epq.epi = epi;  
</span><span class='line'>&#9;init_poll_funcptr(&epq.pt, ep_ptable_queue_proc);  
</span><span class='line'>&#9;// 设置事件掩码  
</span><span class='line'>&#9;epq.pt._key = event-&gt;events;  
</span><span class='line'>&#9;//  内部会调用ep_ptable_queue_proc, 在文件对应的wait queue head 上  
</span><span class='line'>&#9;// 注册回调函数, 并返回当前文件的状态  
</span><span class='line'>&#9;revents = tfile-&gt;f_op-&gt;poll(tfile, &epq.pt);  
</span><span class='line'>  
</span><span class='line'>&#9;// 检查错误  
</span><span class='line'>&#9;error = -ENOMEM;  
</span><span class='line'>&#9;if (epi-&gt;nwait &lt; 0) { // f_op-&gt;poll 过程出错  
</span><span class='line'>&#9;&#9;goto error_unregister;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 添加当前的epitem 到文件的f_ep_links 链表  
</span><span class='line'>&#9;spin_lock(&tfile-&gt;f_lock);  
</span><span class='line'>&#9;list_add_tail(&epi-&gt;fllink, &tfile-&gt;f_ep_links);  
</span><span class='line'>&#9;spin_unlock(&tfile-&gt;f_lock);  
</span><span class='line'>  
</span><span class='line'>&#9;// 插入epi 到rbtree  
</span><span class='line'>&#9;ep_rbtree_insert(ep, epi);  
</span><span class='line'>  
</span><span class='line'>&#9;/* now check if we've created too many backpaths */  
</span><span class='line'>&#9;error = -EINVAL;  
</span><span class='line'>&#9;if (reverse_path_check()) {  
</span><span class='line'>&#9;&#9;goto error_remove_epi;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 文件已经就绪插入到就绪链表rdllist */  
</span><span class='line'>&#9;if ((revents & event-&gt;events) && !ep_is_linked(&epi-&gt;rdllink)) {  
</span><span class='line'>&#9;&#9;list_add_tail(&epi-&gt;rdllink, &ep-&gt;rdllist);  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (waitqueue_active(&ep-&gt;wq))  
</span><span class='line'>&#9;&#9;&#9;// 通知sys_epoll_wait , 调用回调函数唤醒sys_epoll_wait 进程  
</span><span class='line'>&#9;&#9;{  
</span><span class='line'>&#9;&#9;&#9;wake_up_locked(&ep-&gt;wq);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 先不通知调用eventpoll_poll 的进程  
</span><span class='line'>&#9;&#9;if (waitqueue_active(&ep-&gt;poll_wait)) {  
</span><span class='line'>&#9;&#9;&#9;pwake++;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;atomic_long_inc(&ep-&gt;user-&gt;epoll_watches);  
</span><span class='line'>  
</span><span class='line'>&#9;if (pwake)  
</span><span class='line'>&#9;&#9;// 安全通知调用eventpoll_poll 的进程  
</span><span class='line'>&#9;{  
</span><span class='line'>&#9;&#9;ep_poll_safewake(&ep-&gt;poll_wait);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>  
</span><span class='line'>error_remove_epi:  
</span><span class='line'>&#9;spin_lock(&tfile-&gt;f_lock);  
</span><span class='line'>&#9;// 删除文件上的 epi  
</span><span class='line'>&#9;if (ep_is_linked(&epi-&gt;fllink)) {  
</span><span class='line'>&#9;&#9;list_del_init(&epi-&gt;fllink);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;spin_unlock(&tfile-&gt;f_lock);  
</span><span class='line'>  
</span><span class='line'>&#9;// 从红黑树中删除  
</span><span class='line'>&#9;rb_erase(&epi-&gt;rbn, &ep-&gt;rbr);  
</span><span class='line'>  
</span><span class='line'>error_unregister:  
</span><span class='line'>&#9;// 从文件的wait_queue 中删除, 释放epitem 关联的所有eppoll_entry  
</span><span class='line'>&#9;ep_unregister_pollwait(ep, epi);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * We need to do this because an event could have been arrived on some 
</span><span class='line'>&#9; * allocated wait queue. Note that we don't care about the ep-&gt;ovflist 
</span><span class='line'>&#9; * list, since that is used/cleaned only inside a section bound by "mtx". 
</span><span class='line'>&#9; * And ep_insert() is called with "mtx" held. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;// TODO:  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;if (ep_is_linked(&epi-&gt;rdllink)) {  
</span><span class='line'>&#9;&#9;list_del_init(&epi-&gt;rdllink);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;// 释放epi  
</span><span class='line'>&#9;kmem_cache_free(epi_cache, epi);  
</span><span class='line'>  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>EPOLL_CTL_DEL</h4>

<p>EPOLL_CTL_DEL 的实现调用的是 ep_remove 函数，函数只是清除ADD时， 添加的各种结构，EPOLL_CTL_MOD 的实现调用的是ep_modify，在ep_modify中用新的事件掩码调用f_ops->poll，检测事件是否已可用，如果可用就直接唤醒epoll，这两个的实现与EPOLL_CTL_ADD 类似，代码上比较清晰，这里就不具体分析了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ep_remove(struct eventpoll *ep, struct epitem *epi)  
</span><span class='line'>{  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>&#9;struct file *file = epi-&gt;ffd.file;  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Removes poll wait queue hooks. We _have_ to do this without holding 
</span><span class='line'>&#9; * the "ep-&gt;lock" otherwise a deadlock might occur. This because of the 
</span><span class='line'>&#9; * sequence of the lock acquisition. Here we do "ep-&gt;lock" then the wait 
</span><span class='line'>&#9; * queue head lock when unregistering the wait queue. The wakeup callback 
</span><span class='line'>&#9; * will run by holding the wait queue head lock and will call our callback 
</span><span class='line'>&#9; * that will try to get "ep-&gt;lock". 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;ep_unregister_pollwait(ep, epi);  
</span><span class='line'>  
</span><span class='line'>&#9;/* Remove the current item from the list of epoll hooks */  
</span><span class='line'>&#9;spin_lock(&file-&gt;f_lock);  
</span><span class='line'>&#9;if (ep_is_linked(&epi-&gt;fllink))  
</span><span class='line'>&#9;&#9;list_del_init(&epi-&gt;fllink);  
</span><span class='line'>&#9;spin_unlock(&file-&gt;f_lock);  
</span><span class='line'>  
</span><span class='line'>&#9;rb_erase(&epi-&gt;rbn, &ep-&gt;rbr);  
</span><span class='line'>  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;if (ep_is_linked(&epi-&gt;rdllink))  
</span><span class='line'>&#9;&#9;list_del_init(&epi-&gt;rdllink);  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;/* At this point it is safe to free the eventpoll item */  
</span><span class='line'>&#9;kmem_cache_free(epi_cache, epi);  
</span><span class='line'>  
</span><span class='line'>&#9;atomic_long_dec(&ep-&gt;user-&gt;epoll_watches);  
</span><span class='line'>  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* 
</span><span class='line'> * Modify the interest event mask by dropping an event if the new mask 
</span><span class='line'> * has a match in the current file status. Must be called with "mtx" held. 
</span><span class='line'> */  
</span><span class='line'>static int ep_modify(struct eventpoll *ep, struct epitem *epi, struct epoll_event *event)  
</span><span class='line'>{  
</span><span class='line'>&#9;int pwake = 0;  
</span><span class='line'>&#9;unsigned int revents;  
</span><span class='line'>&#9;poll_table pt;  
</span><span class='line'>  
</span><span class='line'>&#9;init_poll_funcptr(&pt, NULL);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Set the new event interest mask before calling f_op-&gt;poll(); 
</span><span class='line'>&#9; * otherwise we might miss an event that happens between the 
</span><span class='line'>&#9; * f_op-&gt;poll() call and the new event set registering. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;epi-&gt;event.events = event-&gt;events;  
</span><span class='line'>&#9;pt._key = event-&gt;events;  
</span><span class='line'>&#9;epi-&gt;event.data = event-&gt;data; /* protected by mtx */  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Get current event bits. We can safely use the file* here because 
</span><span class='line'>&#9; * its usage count has been increased by the caller of this function. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;revents = epi-&gt;ffd.file-&gt;f_op-&gt;poll(epi-&gt;ffd.file, &pt);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * If the item is "hot" and it is not registered inside the ready 
</span><span class='line'>&#9; * list, push it inside. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;if (revents & event-&gt;events) {  
</span><span class='line'>&#9;&#9;spin_lock_irq(&ep-&gt;lock);  
</span><span class='line'>&#9;&#9;if (!ep_is_linked(&epi-&gt;rdllink)) {  
</span><span class='line'>&#9;&#9;&#9;list_add_tail(&epi-&gt;rdllink, &ep-&gt;rdllist);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;/* Notify waiting tasks that events are available */  
</span><span class='line'>&#9;&#9;&#9;if (waitqueue_active(&ep-&gt;wq))  
</span><span class='line'>&#9;&#9;&#9;&#9;wake_up_locked(&ep-&gt;wq);  
</span><span class='line'>&#9;&#9;&#9;if (waitqueue_active(&ep-&gt;poll_wait))  
</span><span class='line'>&#9;&#9;&#9;&#9;pwake++;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;spin_unlock_irq(&ep-&gt;lock);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;/* We have to call this outside the lock */  
</span><span class='line'>&#9;if (pwake)  
</span><span class='line'>&#9;&#9;ep_poll_safewake(&ep-&gt;poll_wait);  
</span><span class='line'>  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h3>epoll_wait</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* 
</span><span class='line'>epoll_wait实现 
</span><span class='line'>*/  
</span><span class='line'>  
</span><span class='line'>SYSCALL_DEFINE4(epoll_wait, int, epfd, struct epoll_event __user *, events,  
</span><span class='line'>&#9;&#9;&#9;&#9;int, maxevents, int, timeout)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error;  
</span><span class='line'>&#9;struct file *file;  
</span><span class='line'>&#9;struct eventpoll *ep;  
</span><span class='line'>  
</span><span class='line'>&#9;// 检查输入数据有效性  
</span><span class='line'>&#9;if (maxevents &lt;= 0 || maxevents &gt; EP_MAX_EVENTS) {  
</span><span class='line'>&#9;&#9;return -EINVAL;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;if (!access_ok(VERIFY_WRITE, events, maxevents * sizeof(struct epoll_event))) {  
</span><span class='line'>&#9;&#9;error = -EFAULT;  
</span><span class='line'>&#9;&#9;goto error_return;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;/* Get the "struct file *" for the eventpoll file */  
</span><span class='line'>&#9;error = -EBADF;  
</span><span class='line'>&#9;file = fget(epfd);  
</span><span class='line'>&#9;if (!file) {  
</span><span class='line'>&#9;&#9;goto error_return;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;error = -EINVAL;  
</span><span class='line'>&#9;if (!is_file_epoll(file)) {  
</span><span class='line'>&#9;&#9;goto error_fput;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 取得ep 结构  
</span><span class='line'>&#9;ep = file-&gt;private_data;  
</span><span class='line'>  
</span><span class='line'>&#9;// 等待事件  
</span><span class='line'>&#9;error = ep_poll(ep, events, maxevents, timeout);  
</span><span class='line'>  
</span><span class='line'>error_fput:  
</span><span class='line'>&#9;fput(file);  
</span><span class='line'>error_return:  
</span><span class='line'>  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_poll(struct eventpoll *ep, struct epoll_event __user *events,  
</span><span class='line'>&#9;&#9;&#9;&#9;   int maxevents, long timeout)  
</span><span class='line'>{  
</span><span class='line'>&#9;int res = 0, eavail, timed_out = 0;  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>&#9;long slack = 0;  
</span><span class='line'>&#9;wait_queue_t wait;  
</span><span class='line'>&#9;ktime_t expires, *to = NULL;  
</span><span class='line'>  
</span><span class='line'>&#9;if (timeout &gt; 0) {  
</span><span class='line'>&#9;&#9;// 转换为内核时间  
</span><span class='line'>&#9;&#9;struct timespec end_time = ep_set_mstimeout(timeout);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;slack = select_estimate_accuracy(&end_time);  
</span><span class='line'>&#9;&#9;to = &expires;  
</span><span class='line'>&#9;&#9;*to = timespec_to_ktime(end_time);  
</span><span class='line'>&#9;} else if (timeout == 0) {  
</span><span class='line'>&#9;&#9;// 已经超时直接检查readylist  
</span><span class='line'>&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;&#9;goto check_events;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>fetch_events:  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;// 没有可用的事件，ready list 和ovflist 都为空  
</span><span class='line'>&#9;if (!ep_events_available(ep)) {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;// 添加当前进程的唤醒函数  
</span><span class='line'>&#9;&#9;init_waitqueue_entry(&wait, current);  
</span><span class='line'>&#9;&#9;__add_wait_queue_exclusive(&ep-&gt;wq, &wait);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;for (;;) {  
</span><span class='line'>&#9;&#9;&#9;/* 
</span><span class='line'>&#9;&#9;&#9; * We don't want to sleep if the ep_poll_callback() sends us 
</span><span class='line'>&#9;&#9;&#9; * a wakeup in between. That's why we set the task state 
</span><span class='line'>&#9;&#9;&#9; * to TASK_INTERRUPTIBLE before doing the checks. 
</span><span class='line'>&#9;&#9;&#9; */  
</span><span class='line'>&#9;&#9;&#9;set_current_state(TASK_INTERRUPTIBLE);  
</span><span class='line'>&#9;&#9;&#9;if (ep_events_available(ep) || timed_out) {  
</span><span class='line'>&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;if (signal_pending(current)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;res = -EINTR;  
</span><span class='line'>&#9;&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;&#9;&#9;// 挂起当前进程，等待唤醒或超时  
</span><span class='line'>&#9;&#9;&#9;if (!schedule_hrtimeout_range(to, slack, HRTIMER_MODE_ABS)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;timed_out = 1;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;  
</span><span class='line'>&#9;&#9;__remove_wait_queue(&ep-&gt;wq, &wait);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;set_current_state(TASK_RUNNING);  
</span><span class='line'>&#9;}  
</span><span class='line'>check_events:  
</span><span class='line'>&#9;// 再次检查是否有可用事件  
</span><span class='line'>&#9;eavail = ep_events_available(ep);  
</span><span class='line'>  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * Try to transfer events to user space. In case we get 0 events and 
</span><span class='line'>&#9; * there's still timeout left over, we go trying again in search of 
</span><span class='line'>&#9; * more luck. 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;if (!res && eavail   
</span><span class='line'>&#9;&#9;&#9;&& !(res = ep_send_events(ep, events, maxevents)) // 复制事件到用户空间  
</span><span class='line'>&#9;&#9;&#9;&& !timed_out) // 复制事件失败并且没有超时，重新等待。  
</span><span class='line'>&#9;&#9;&#9;{  
</span><span class='line'>&#9;&#9;goto fetch_events;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;return res;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>static inline int ep_events_available(struct eventpoll *ep)  
</span><span class='line'>{  
</span><span class='line'>&#9;return !list_empty(&ep-&gt;rdllist) || ep-&gt;ovflist != EP_UNACTIVE_PTR;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>struct ep_send_events_data {  
</span><span class='line'>&#9;int maxevents;  
</span><span class='line'>&#9;struct epoll_event __user *events;  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>static int ep_send_events(struct eventpoll *ep,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;  struct epoll_event __user *events, int maxevents)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct ep_send_events_data esed;  
</span><span class='line'>  
</span><span class='line'>&#9;esed.maxevents = maxevents;  
</span><span class='line'>&#9;esed.events = events;  
</span><span class='line'>  
</span><span class='line'>&#9;return ep_scan_ready_list(ep, ep_send_events_proc, &esed, 0);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_send_events_proc(struct eventpoll *ep, struct list_head *head,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;   void *priv)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct ep_send_events_data *esed = priv;  
</span><span class='line'>&#9;int eventcnt;  
</span><span class='line'>&#9;unsigned int revents;  
</span><span class='line'>&#9;struct epitem *epi;  
</span><span class='line'>&#9;struct epoll_event __user *uevent;  
</span><span class='line'>  
</span><span class='line'>&#9;// 遍历已就绪链表  
</span><span class='line'>&#9;for (eventcnt = 0, uevent = esed-&gt;events;  
</span><span class='line'>&#9;&#9;&#9;!list_empty(head) && eventcnt &lt; esed-&gt;maxevents;) {  
</span><span class='line'>&#9;&#9;epi = list_first_entry(head, struct epitem, rdllink);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;list_del_init(&epi-&gt;rdllink);  
</span><span class='line'>&#9;&#9;// 获取ready 事件掩码  
</span><span class='line'>&#9;&#9;revents = epi-&gt;ffd.file-&gt;f_op-&gt;poll(epi-&gt;ffd.file, NULL) &  
</span><span class='line'>&#9;&#9;&#9;&#9;  epi-&gt;event.events;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* 
</span><span class='line'>&#9;&#9; * If the event mask intersect the caller-requested one, 
</span><span class='line'>&#9;&#9; * deliver the event to userspace. Again, ep_scan_ready_list() 
</span><span class='line'>&#9;&#9; * is holding "mtx", so no operations coming from userspace 
</span><span class='line'>&#9;&#9; * can change the item. 
</span><span class='line'>&#9;&#9; */  
</span><span class='line'>&#9;&#9;if (revents) {  
</span><span class='line'>&#9;&#9;&#9;// 事件就绪, 复制到用户空间  
</span><span class='line'>&#9;&#9;&#9;if (__put_user(revents, &uevent-&gt;events) ||  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;__put_user(epi-&gt;event.data, &uevent-&gt;data)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;list_add(&epi-&gt;rdllink, head);  
</span><span class='line'>&#9;&#9;&#9;&#9;return eventcnt ? eventcnt : -EFAULT;  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;eventcnt++;  
</span><span class='line'>&#9;&#9;&#9;uevent++;  
</span><span class='line'>&#9;&#9;&#9;if (epi-&gt;event.events & EPOLLONESHOT) {  
</span><span class='line'>&#9;&#9;&#9;&#9;epi-&gt;event.events &= EP_PRIVATE_BITS;  
</span><span class='line'>&#9;&#9;&#9;} else if (!(epi-&gt;event.events & EPOLLET)) {  
</span><span class='line'>&#9;&#9;&#9;&#9;// 不是边缘模式, 再次添加到ready list,  
</span><span class='line'>&#9;&#9;&#9;&#9;// 下次epoll_wait 时直接进入此函数检查ready list是否仍然继续  
</span><span class='line'>&#9;&#9;&#9;&#9;list_add_tail(&epi-&gt;rdllink, &ep-&gt;rdllist);  
</span><span class='line'>&#9;&#9;&#9;}  
</span><span class='line'>&#9;&#9;&#9;// 如果是边缘模式, 只有当文件状态发生改变时,  
</span><span class='line'>&#9;&#9;&#9;// 才文件会再次触发wait_address 上wait_queue的回调函数,  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;return eventcnt;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>eventpoll_poll</h4>

<p> 由于epoll自身也是文件系统，其描述符也可以被poll/select/epoll监视，因此需要实现poll方法。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static const struct file_operations eventpoll_fops = {  
</span><span class='line'>&#9;.release = ep_eventpoll_release,  
</span><span class='line'>&#9;.poll    = ep_eventpoll_poll,  
</span><span class='line'>&#9;.llseek  = noop_llseek,  
</span><span class='line'>};  
</span><span class='line'>  
</span><span class='line'>static unsigned int ep_eventpoll_poll(struct file *file, poll_table *wait)  
</span><span class='line'>{  
</span><span class='line'>&#9;int pollflags;  
</span><span class='line'>&#9;struct eventpoll *ep = file-&gt;private_data;  
</span><span class='line'>&#9;// 插入到wait_queue  
</span><span class='line'>&#9;poll_wait(file, &ep-&gt;poll_wait, wait);  
</span><span class='line'>&#9;// 扫描就绪的文件列表, 调用每个文件上的poll 检测是否真的就绪,  
</span><span class='line'>&#9;// 然后复制到用户空间  
</span><span class='line'>&#9;// 文件列表中有可能有epoll文件, 调用poll的时候有可能会产生递归,  
</span><span class='line'>&#9;// 调用所以用ep_call_nested 包装一下, 防止死循环和过深的调用  
</span><span class='line'>&#9;pollflags = ep_call_nested(&poll_readywalk_ncalls, EP_MAX_NESTS,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;   ep_poll_readyevents_proc, ep, ep, current);  
</span><span class='line'>&#9;// static struct nested_calls poll_readywalk_ncalls;  
</span><span class='line'>&#9;return pollflags != -1 ? pollflags : 0;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_poll_readyevents_proc(void *priv, void *cookie, int call_nests)  
</span><span class='line'>{  
</span><span class='line'>&#9;return ep_scan_ready_list(priv, ep_read_events_proc, NULL, call_nests + 1);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_scan_ready_list(struct eventpoll *ep,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;  int (*sproc)(struct eventpoll *,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;  struct list_head *, void *),  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;  void *priv,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;  int depth)  
</span><span class='line'>{  
</span><span class='line'>&#9;int error, pwake = 0;  
</span><span class='line'>&#9;unsigned long flags;  
</span><span class='line'>&#9;struct epitem *epi, *nepi;  
</span><span class='line'>&#9;LIST_HEAD(txlist);  
</span><span class='line'>  
</span><span class='line'>&#9;/* 
</span><span class='line'>&#9; * We need to lock this because we could be hit by 
</span><span class='line'>&#9; * eventpoll_release_file() and epoll_ctl(). 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;mutex_lock_nested(&ep-&gt;mtx, depth);  
</span><span class='line'>  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>&#9;// 移动rdllist 到新的链表txlist  
</span><span class='line'>&#9;list_splice_init(&ep-&gt;rdllist, &txlist);  
</span><span class='line'>&#9;// 改变ovflist 的状态, 如果ep-&gt;ovflist != EP_UNACTIVE_PTR,  
</span><span class='line'>&#9;// 当文件激活wait_queue时，就会将对应的epitem加入到ep-&gt;ovflist  
</span><span class='line'>&#9;// 否则将文件直接加入到ep-&gt;rdllist，  
</span><span class='line'>&#9;// 这样做的目的是避免丢失事件  
</span><span class='line'>&#9;// 这里不需要检查ep-&gt;ovflist 的状态，因为ep-&gt;mtx的存在保证此处的ep-&gt;ovflist  
</span><span class='line'>&#9;// 一定是EP_UNACTIVE_PTR  
</span><span class='line'>&#9;ep-&gt;ovflist = NULL;  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;// 调用扫描函数处理txlist  
</span><span class='line'>&#9;error = (*sproc)(ep, &txlist, priv);  
</span><span class='line'>  
</span><span class='line'>&#9;spin_lock_irqsave(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;// 调用 sproc 时可能有新的事件，遍历这些新的事件将其插入到ready list  
</span><span class='line'>&#9;for (nepi = ep-&gt;ovflist; (epi = nepi) != NULL;  
</span><span class='line'>&#9;&#9;&#9;nepi = epi-&gt;next, epi-&gt;next = EP_UNACTIVE_PTR) {  
</span><span class='line'>&#9;&#9;// #define EP_UNACTIVE_PTR (void *) -1  
</span><span class='line'>&#9;&#9;// epi 不在rdllist, 插入  
</span><span class='line'>&#9;&#9;if (!ep_is_linked(&epi-&gt;rdllink)) {  
</span><span class='line'>&#9;&#9;&#9;list_add_tail(&epi-&gt;rdllink, &ep-&gt;rdllist);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;// 还原ep-&gt;ovflist的状态  
</span><span class='line'>&#9;ep-&gt;ovflist = EP_UNACTIVE_PTR;  
</span><span class='line'>  
</span><span class='line'>&#9;// 将处理后的 txlist 链接到 rdllist  
</span><span class='line'>&#9;list_splice(&txlist, &ep-&gt;rdllist);  
</span><span class='line'>  
</span><span class='line'>&#9;if (!list_empty(&ep-&gt;rdllist)) {  
</span><span class='line'>&#9;&#9;// 唤醒epoll_wait  
</span><span class='line'>&#9;&#9;if (waitqueue_active(&ep-&gt;wq)) {  
</span><span class='line'>&#9;&#9;&#9;wake_up_locked(&ep-&gt;wq);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;&#9;// 当前的ep有其他的事件通知机制监控  
</span><span class='line'>&#9;&#9;if (waitqueue_active(&ep-&gt;poll_wait)) {  
</span><span class='line'>&#9;&#9;&#9;pwake++;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;spin_unlock_irqrestore(&ep-&gt;lock, flags);  
</span><span class='line'>  
</span><span class='line'>&#9;mutex_unlock(&ep-&gt;mtx);  
</span><span class='line'>  
</span><span class='line'>&#9;if (pwake) {  
</span><span class='line'>&#9;&#9;// 安全唤醒外部的事件通知机制  
</span><span class='line'>&#9;&#9;ep_poll_safewake(&ep-&gt;poll_wait);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;return error;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int ep_read_events_proc(struct eventpoll *ep, struct list_head *head,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;   void *priv)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct epitem *epi, *tmp;  
</span><span class='line'>&#9;poll_table pt;  
</span><span class='line'>&#9;init_poll_funcptr(&pt, NULL);  
</span><span class='line'>&#9;list_for_each_entry_safe(epi, tmp, head, rdllink) {  
</span><span class='line'>&#9;&#9;pt._key = epi-&gt;event.events;  
</span><span class='line'>&#9;&#9;if (epi-&gt;ffd.file-&gt;f_op-&gt;poll(epi-&gt;ffd.file, &pt) &  
</span><span class='line'>&#9;&#9;&#9;&#9;epi-&gt;event.events) {  
</span><span class='line'>&#9;&#9;&#9;return POLLIN | POLLRDNORM;  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9; // 这个事件虽然在就绪列表中,  
</span><span class='line'>&#9;&#9;&#9; // 但是实际上并没有就绪, 将他移除  
</span><span class='line'>&#9;&#9; // 这有可能是水平触发模式中没有将文件从就绪列表中移除  
</span><span class='line'>&#9;&#9; // 也可能是事件插入到就绪列表后有其他的线程对文件进行了操作  
</span><span class='line'>&#9;&#9;&#9;list_del_init(&epi-&gt;rdllink);  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return 0;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h3>epoll全景</h3>

<p>以下是epoll使用的全部数据结构之间的关系图，采用的是一种类UML图，希望对理解epoll的内部实现有所帮助。</p>

<p><img src="/images/kernel/2018-11-07-2.png" alt="" /></p>

<h2>poll/select/epoll 对比</h2>

<p>通过以上的分析可以看出，poll和select的实现基本是一致，只是用户到内核传递的数据格式有所不同，</p>

<p>select和poll即使只有一个描述符就绪，也要遍历整个集合。如果集合中活跃的描述符很少，遍历过程的开销就会变得很大，而如果集合中大部分的描述符都是活跃的，遍历过程的开销又可以忽略。</p>

<p>epoll的实现中每次只遍历活跃的描述符(如果是水平触发，也会遍历先前活跃的描述符)，在活跃描述符较少的情况下就会很有优势，在代码的分析过程中可以看到epoll的实现过于复杂并且其实现过程中需要同步处理(锁)，如果大部分描述符都是活跃的，epoll的效率可能不如select或poll。(参见epoll 和poll的性能测试 <a href="http://jacquesmattheij.com/Poll+vs+Epoll+once+again">http://jacquesmattheij.com/Poll+vs+Epoll+once+again</a>)</p>

<p>select能够处理的最大fd无法超出FDSETSIZE。</p>

<p>select会复写传入的fd_set 指针，而poll对每个fd返回一个掩码，不更改原来的掩码，从而可以对同一个集合多次调用poll，而无需调整。</p>

<p>select对每个文件描述符最多使用3个bit，而poll采用的pollfd需要使用64个bit，epoll采用的 epoll_event则需要96个bit</p>

<p>如果事件需要循环处理select, poll 每一次的处理都要将全部的数据复制到内核，而epoll的实现中，内核将持久维护加入的描述符，减少了内核和用户复制数据的开销。</p>

<hr />

<p><a href="https://www.cnblogs.com/wsw-seu/p/8274195.html">https://www.cnblogs.com/wsw-seu/p/8274195.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2018/11/07/lang-c-server/">select,poll,epoll</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-07T23:13:00+08:00'><span class='date'>2018-11-07</span> <span class='time'>23:13:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>样例 <a href="/download/tools/socket_select_poll_epoll.tar">socket_select_poll_epoll.tar</a></p>

<hr />

<p><a href="https://blog.csdn.net/jyy305/article/details/73012706">https://blog.csdn.net/jyy305/article/details/73012706</a></p>

<h2>select</h2>

<h4>select函数预备知识</h4>

<p>1.struct fd_set可以理解为一个集合，这个集合中存放的是文件描述符(file descriptor)，即文件句柄，这可以是我们所说的普通意义的文件，当然Unix下任何设备、管道、FIFO等都是文件形式，全部包括在内，所以毫无疑问一个socket就是一个文件，socket句柄就是一个文件描述符。fd_set集合可以通过一些宏由人为来操作。</p>

<p>(1) FD_CLR(inr fd,fd_set<em> set)：用来清除描述词组set中相关fd 的位<br/>
(2) FD_ISSET(int fd,fd_set </em>set）：用来测试描述词组set中相关fd 的位是否为真<br/>
    FD_SET（int fd,fd_set*set）：用来设置描述词组set中相关fd的位</p>

<p>2.struct timeval是一个大家常用的结构，用来代表时间值，有两个成员，一个是秒数，另一个是毫秒数。</p>

<p>FD_ZERO（fd_set *set）；用来清除描述词组set的全部位</p>

<h4>select函数介绍</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int select(int maxfdp,fd_set *readfds,fd_set *writefds,fd_set *errorfds,struct timeval *timeout);</span></code></pre></td></tr></table></div></figure>


<p>maxfdp : 需要监视的最大文件描述符加1。</p>

<p>readfds、writefds、errorfds：分别对应于需要检测的可读文件描述符的集合，可写文件描述符的集 合及异常文件描述符的集合。</p>

<p>timeout：等待时间，这个时间内，需要监视的描述符没有事件<br/>
发⽣生则函数返回，返回值为0。设为-1表示阻塞式等待，一直等到有事件就绪，函数才会返回，0表示非阻塞式等待，没有事件就立即返回，大于0表示等待的时间。<br/>
返回值：大于0表示就绪时间的个数，等于0表示timeout等待时间到了，小于0表示调用失败。</p>

<h4>select函数原理</h4>

<p>select系统调用是用来让我们的程序监视多个文件句柄的状态变化的。程序会停在select这⾥里等待，直到被监视的文件句柄有一个或多个发⽣生了状态改变。关于文件句柄，其实就是⼀一个整数，我们最熟悉的句柄是0、1、2三个，0是标准输入，1是标准输出，2是标准错误输出。0、1、2是整数表示的，对应的FILE *结构的表示就是stdin、stdout、stderr。</p>

<p>1.我们通常需要额外定义一个数组来保存需要监视的文件描述符，并将其他没有保存描述符的位置初始化为一个特定值，一般为-1，这样方便我们遍历数组，判断对应的文件描述符是否发生了相应的事件。</p>

<p>2.采用上述的宏操作FD_SET（int fd,fd_set*set）遍历数组将关心的文件描述符设置到对应的事件集合里。并且每次调用之前都需要遍历数组，设置文件描述符。</p>

<p>3.调用select函数等待所关心的文件描述符。有文件描述符上的事件就绪后select函数返回，没有事件就绪的文件描述符在文件描述符集合中对应的位置会被置为0，这就是上述第二步的原因。</p>

<p>4.select 返回值大于0表示就绪的文件描述符的个数，0表示等待时间到了，小于0表示调用失败，因此我们可以遍历数组采用FD_ISSET(int fd,fd_set *set）判断哪个文件描述符上的事件就绪，然后执行相应的操作。</p>

<hr />

<p><a href="https://www.cnblogs.com/Anker/p/3261006.html">https://www.cnblogs.com/Anker/p/3261006.html</a></p>

<h2>poll</h2>

<h4>1、基本知识</h4>

<p>poll的机制与select类似，与select在本质上没有多大差别，管理多个描述符也是进行轮询，根据描述符的状态进行处理，但是poll没有最大文件描述符数量的限制。poll和select同样存在一个缺点就是，包含大量文件描述符的数组被整体复制于用户态和内核的地址空间之间，而不论这些文件描述符是否就绪，它的开销随着文件描述符数量的增加而线性增大。</p>

<h4>2、poll函数</h4>

<p>函数格式如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;poll.h&gt;
</span><span class='line'>int poll ( struct pollfd * fds, unsigned int nfds, int timeout);</span></code></pre></td></tr></table></div></figure>


<p>pollfd 结构体定义如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct pollfd {
</span><span class='line'>&#9;int fd;         /* 文件描述符 */
</span><span class='line'>&#9;short events;   /* 等待的事件 */
</span><span class='line'>&#9;short revents;  /* 实际发生了的事件 */
</span><span class='line'>} ; </span></code></pre></td></tr></table></div></figure>


<p>每一个pollfd结构体指定了一个被监视的文件描述符，可以传递多个结构体，指示poll()监视多个文件描述符。每个结构体的events域是监视该文件描述符的事件掩码，由用户来设置这个域。revents域是文件描述符的操作结果事件掩码，内核在调用返回时设置这个域。events域中请求的任何事件都可能在revents域中返回。合法的事件如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>POLLIN           有数据可读。
</span><span class='line'>POLLRDNORM       有普通数据可读。
</span><span class='line'>POLLRDBAND       有优先数据可读。
</span><span class='line'>POLLPRI          有紧迫数据可读。
</span><span class='line'>POLLOUT          写数据不会导致阻塞。
</span><span class='line'>POLLWRNORM       写普通数据不会导致阻塞。
</span><span class='line'>POLLWRBAND       写优先数据不会导致阻塞。
</span><span class='line'>POLLMSGSIGPOLL   消息可用。
</span><span class='line'>
</span><span class='line'># 此外，revents域中还可能返回下列事件：
</span><span class='line'># 这些事件在events域中无意义，因为它们在合适的时候总是会从revents中返回。
</span><span class='line'>POLLER           指定的文件描述符发生错误。
</span><span class='line'>POLLHUP          指定的文件描述符挂起事件。
</span><span class='line'>POLLNVAL         指定的文件描述符非法。</span></code></pre></td></tr></table></div></figure>


<p>使用poll()和select()不一样，你不需要显式地请求异常情况报告。</p>

<p>POLLIN | POLLPRI等价于select()的读事件，POLLOUT |POLLWRBAND等价于select()的写事件。POLLIN等价于POLLRDNORM |POLLRDBAND，而POLLOUT则等价于POLLWRNORM。</p>

<p>例如，要同时监视一个文件描述符是否可读和可写，我们可以设置 events为POLLIN | POLLOUT。在poll返回时，我们可以检查revents中的标志，对应于文件描述符请求的events结构体。如果POLLIN事件被设置，则文件描述符可以被读取而不阻塞。如果POLLOUT被设置，则文件描述符可以写入而不导致阻塞。这些标志并不是互斥的：它们可能被同时设置，表示这个文件描述符的读取和写入操作都会正常返回而不阻塞。</p>

<p>timeout参数指定等待的毫秒数，无论I/O是否准备好，poll都会返回。timeout指定为负数值表示无限超时，使poll()一直挂起直到一个指定事件发生；timeout为0指示poll调用立即返回并列出准备好I/O的文件描述符，但并不等待其它的事件。这种情况下，poll()就像它的名字那样，一旦选举出来，立即返回。</p>

<h5>返回值和错误代码</h5>

<p>成功时，poll()返回结构体中revents域不为0的文件描述符个数；如果在超时前没有任何事件发生，poll()返回0；失败时，poll()返回-1，并设置errno为下列值之一：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EBADF       一个或多个结构体中指定的文件描述符无效。
</span><span class='line'>EFAULTfds   指针指向的地址超出进程的地址空间。
</span><span class='line'>EINTR       请求的事件之前产生一个信号，调用可以重新发起。
</span><span class='line'>EINVALnfds  参数超出PLIMIT_NOFILE值。
</span><span class='line'>ENOMEM      可用内存不足，无法完成请求。</span></code></pre></td></tr></table></div></figure>


<hr />

<p><a href="https://www.jianshu.com/p/ee381d365a29">https://www.jianshu.com/p/ee381d365a29</a></p>

<p><a href="https://blog.csdn.net/libaineu2004/article/details/70197825">https://blog.csdn.net/libaineu2004/article/details/70197825</a></p>

<p><a href="https://www.cnblogs.com/fnlingnzb-learner/p/5835573.html">https://www.cnblogs.com/fnlingnzb-learner/p/5835573.html</a></p>

<h2>epoll</h2>

<p>在linux的网络编程中，很长的时间都在使用select来做事件触发。在linux新的内核中，有了一种替换它的机制，就是epoll。
相比于select，epoll最大的好处在于它不会随着监听fd数目的增长而降低效率。因为在内核中的select实现中，它是采用轮询来处理的，轮询的fd数目越多，自然耗时越多。并且，在linux/posix_types.h头文件有这样的声明：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define __FD_SETSIZE    1024</span></code></pre></td></tr></table></div></figure>


<p>表示select最多同时监听1024个fd，当然，可以通过修改头文件再重编译内核来扩大这个数目，但这似乎并不治本。</p>

<p>EPOLL 的API用来执行类似poll()的任务。能够用于检测在多个文件描述符中任何IO可用的情况。Epoll API可以用于边缘触发(edge-triggered)和水平触发(level-triggered), 同时epoll可以检测更多的文件描述符。以下的系统调用函数提供了创建和管理epoll实例：</p>

<p>epoll_create() 可以创建一个epoll实例并返回相应的文件描述符(epoll_create1() 扩展了epoll_create() 的功能)。<br/>
注册相关的文件描述符使用epoll_ctl()<br/>
epoll_wait() 可以用于等待IO事件。如果当前没有可用的事件，这个函数会阻塞调用线程。</p>

<h3>关于ET、LT两种工作模式：</h3>

<p>ET模式仅当状态发生变化的时候才获得通知,这里所谓的状态的变化并不包括缓冲区中还有未处理的数据,也就是说,如果要采用ET模式,需要一直read/write直到出错为止,很多人反映为什么采用ET模式只接收了一部分数据就再也得不到通知了,大多因为这样;而LT模式是只要有数据没有处理就会一直通知下去的.</p>

<p>下面情况下推荐使用ET模式:</p>

<p>使用非阻塞的IO。<br/>
epoll_wait() 只需要在read或者write返回的时候。</p>

<p>相比之下，当我们使用LT的时候（默认）,epoll会比poll更简单更快速，而且我们可以使用在任何一个地方。</p>

<h3>API介绍</h3>

<h4>1. 创建epoll</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/epoll.h&gt;
</span><span class='line'>
</span><span class='line'>int epoll_create(int size);
</span><span class='line'>int epoll_create1(int flags);</span></code></pre></td></tr></table></div></figure>


<p>epoll_create() 可以创建一个epoll实例。在linux 内核版本大于2.6.8 后，这个size 参数就被弃用了，但是传入的值必须大于0。</p>

<p>在 epoll_create () 的最初实现版本时， size参数的作用是创建epoll实例时候告诉内核需要使用多少个文件描述符。内核会使用 size 的大小去申请对应的内存(如果在使用的时候超过了给定的size， 内核会申请更多的空间)。现在，这个size参数不再使用了（内核会动态的申请需要的内存）。但要注意的是，这个size必须要大于0，为了兼容旧版的linux 内核的代码。</p>

<p>epoll_create() 会返回新的epoll对象的文件描述符。这个文件描述符用于后续的epoll操作。如果不需要使用这个描述符，请使用close关闭。</p>

<p>epoll_create1() 如果flags的值是0，epoll_create1()等同于epoll_create()除了过时的size被遗弃了。当然flasg可以使用 EPOLL_CLOEXEC，请查看 open() 中的O_CLOEXEC来查看 EPOLL_CLOEXEC有什么用。</p>

<h5>返回值: 如果执行成功，返回一个非负数(实际为文件描述符), 如果执行失败，会返回-1，具体原因请查看erro</h5>

<h4>2. 设置epoll事件</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/epoll.h&gt;
</span><span class='line'>
</span><span class='line'>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</span></code></pre></td></tr></table></div></figure>


<p>epoll的事件注册函数，它不同与select()是在监听事件时告诉内核要监听什么类型的事件，而是在这里先注册要监听的事件类型。第一个参数是epoll_create()的返回值，第二个参数表示动作，用三个宏来表示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EPOLL_CTL_ADD    注册新的fd到epfd中；
</span><span class='line'>EPOLL_CTL_MOD 修改已经注册的fd的监听事件；
</span><span class='line'>EPOLL_CTL_DEL 从epfd中删除一个fd；</span></code></pre></td></tr></table></div></figure>


<p>第三个参数是需要监听的fd，第四个参数是告诉内核需要监听什么事，struct epoll_event结构如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef union epoll_data {
</span><span class='line'>&#9;void *ptr;
</span><span class='line'>&#9;int fd;
</span><span class='line'>&#9;__uint32_t u32;
</span><span class='line'>&#9;__uint64_t u64;
</span><span class='line'>} epoll_data_t;
</span><span class='line'>
</span><span class='line'>struct epoll_event {
</span><span class='line'>&#9;__uint32_t events; /* Epoll events */
</span><span class='line'>&#9;epoll_data_t data; /* User data variable */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>events可以是以下几个宏的集合：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EPOLLIN      表示对应的文件描述符可以读（包括对端SOCKET正常关闭）；
</span><span class='line'>EPOLLOUT  表示对应的文件描述符可以写；
</span><span class='line'>EPOLLPRI  表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）；
</span><span class='line'>EPOLLERR  表示对应的文件描述符发生错误；
</span><span class='line'>EPOLLHUP  表示对应的文件描述符被挂断；
</span><span class='line'>EPOLLET       将EPOLL设为边缘触发(Edge Triggered)模式，这是相对于水平触发(Level Triggered)来说的。
</span><span class='line'>EPOLLONESHOT  只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里</span></code></pre></td></tr></table></div></figure>


<h5>返回值：如果成功，返回0。如果失败，会返回-1， errno将会被设置</h5>

<p>有以下几种错误：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EBADF  - epfd 或者 fd 是无效的文件描述符。
</span><span class='line'>EEXIST - op是EPOLL_CTL_ADD，同时 fd 在之前，已经被注册到epoll中了。
</span><span class='line'>EINVAL - epfd不是一个epoll描述符。或者fd和epfd相同，或者op参数非法。
</span><span class='line'>ENOENT - op是EPOLL_CTL_MOD或者EPOLL_CTL_DEL，但是fd还没有被注册到epoll上。
</span><span class='line'>ENOMEM - 内存不足。
</span><span class='line'>EPERM  - 目标的fd不支持epoll。</span></code></pre></td></tr></table></div></figure>


<h4>3. 等待epoll事件</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/epoll.h&gt;
</span><span class='line'>
</span><span class='line'>int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</span></code></pre></td></tr></table></div></figure>


<p>epoll_wait 这个系统调用是用来等待epfd中的事件。events指向调用者可以使用的事件的内存区域。maxevents告知内核有多少个events，必须要大于0.</p>

<p>timeout这个参数是用来制定epoll_wait 会阻塞多少毫秒，会一直阻塞到下面几种情况：</p>

<p>一个文件描述符触发了事件。<br/>
被一个信号处理函数打断，或者timeout超时。</p>

<p>当timeout等于-1的时候这个函数会无限期的阻塞下去，当timeout等于0的时候，就算没有任何事件，也会立刻返回。</p>

<h5>epoll_pwait</h5>

<p>还有一个系统调用epoll_pwait ()。epoll_pwait()和epoll_wait ()的关系就像select()和 pselect()的关系。和pselect()一样，epoll_pwait()可以让应用程序安全的等待知道某一个文件描述符就绪或者捕捉到信号。</p>

<p>下面的 epoll_pwait () 调用：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ready = epoll_pwait(epfd, &events, maxevents, timeout, &sigmask);</span></code></pre></td></tr></table></div></figure>


<p>在内部等同于:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pthread_sigmask(SIG_SETMASK, &sigmask, &origmask);
</span><span class='line'>ready = epoll_wait(epfd, &events, maxevents, timeout);
</span><span class='line'>pthread_sigmask(SIG_SETMASK, &origmask, NULL);</span></code></pre></td></tr></table></div></figure>


<p>如果 sigmask为NULL, epoll_pwait()等同于epoll_wait()。</p>

<p>返回值：有多少个IO事件已经准备就绪。如果返回0说明没有IO事件就绪，而是timeout超时。遇到错误的时候，会返回-1，并设置 errno。</p>

<p>有以下几种错误:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EBADF  - epfd是无效的文件描述符
</span><span class='line'>EFAULT - 指针events指向的内存没有访问权限
</span><span class='line'>EINTR  - 这个调用被信号打断。
</span><span class='line'>EINVAL - epfd不是一个epoll的文件描述符，或者maxevents小于等于0</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/131">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/129">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories
<span class='right_span'>(925)</span>

</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(13)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(151)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>32</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~excel/?opendiv=language'>excel</a><a href='##' onmousedown=showDiv('language~excel') id='aexp_language~excel'><span class='exp_style' id='exp_language~excel'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~excel')) document.getElementById('aexp_language~excel').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~jsp/?opendiv=language'>jsp</a><a href='##' onmousedown=showDiv('language~jsp') id='aexp_language~jsp'><span class='exp_style' id='exp_language~jsp'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~jsp')) document.getElementById('aexp_language~jsp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~php/?opendiv=language'>php</a><a href='##' onmousedown=showDiv('language~php') id='aexp_language~php'><span class='exp_style' id='exp_language~php'>[+]</span></a><span class='right_span'>50</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~php')) document.getElementById('aexp_language~php').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~python/?opendiv=language'>python</a><a href='##' onmousedown=showDiv('language~python') id='aexp_language~python'><span class='exp_style' id='exp_language~python'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~python')) document.getElementById('aexp_language~python').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>48</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(16)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~win/?opendiv=assembly'>win</a><a href='##' onmousedown=showDiv('assembly~win') id='aexp_assembly~win'><span class='exp_style' id='exp_assembly~win'>[+]</span></a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~win')) document.getElementById('aexp_assembly~win').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(198)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~apache2/?opendiv=tools'>apache2</a><a href='##' onmousedown=showDiv('tools~apache2') id='aexp_tools~apache2'><span class='exp_style' id='exp_tools~apache2'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~apache2')) document.getElementById('aexp_tools~apache2').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~cloud/?opendiv=tools'>cloud</a><a href='##' onmousedown=showDiv('tools~cloud') id='aexp_tools~cloud'><span class='exp_style' id='exp_tools~cloud'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~cloud')) document.getElementById('aexp_tools~cloud').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>30</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~dns/?opendiv=tools'>dns</a><a href='##' onmousedown=showDiv('tools~dns') id='aexp_tools~dns'><span class='exp_style' id='exp_tools~dns'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~dns')) document.getElementById('aexp_tools~dns').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~graphviz,-codeviz/?opendiv=tools'>graphviz、codeviz</a><a href='##' onmousedown=showDiv('tools~graphviz、codeviz') id='aexp_tools~graphviz、codeviz'><span class='exp_style' id='exp_tools~graphviz、codeviz'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~graphviz、codeviz')) document.getElementById('aexp_tools~graphviz、codeviz').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~isal/?opendiv=tools'>isal</a><a href='##' onmousedown=showDiv('tools~isal') id='aexp_tools~isal'><span class='exp_style' id='exp_tools~isal'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~isal')) document.getElementById('aexp_tools~isal').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>30</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~nginx/?opendiv=tools'>nginx</a><a href='##' onmousedown=showDiv('tools~nginx') id='aexp_tools~nginx'><span class='exp_style' id='exp_tools~nginx'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~nginx')) document.getElementById('aexp_tools~nginx').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~obs/?opendiv=tools'>obs</a><a href='##' onmousedown=showDiv('tools~obs') id='aexp_tools~obs'><span class='exp_style' id='exp_tools~obs'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~obs')) document.getElementById('aexp_tools~obs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~openvpn/?opendiv=tools'>openvpn</a><a href='##' onmousedown=showDiv('tools~openvpn') id='aexp_tools~openvpn'><span class='exp_style' id='exp_tools~openvpn'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~openvpn')) document.getElementById('aexp_tools~openvpn').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~oracle/?opendiv=tools'>oracle</a><a href='##' onmousedown=showDiv('tools~oracle') id='aexp_tools~oracle'><span class='exp_style' id='exp_tools~oracle'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~oracle')) document.getElementById('aexp_tools~oracle').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~picture/?opendiv=tools'>picture</a><a href='##' onmousedown=showDiv('tools~picture') id='aexp_tools~picture'><span class='exp_style' id='exp_tools~picture'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~picture')) document.getElementById('aexp_tools~picture').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~redis/?opendiv=tools'>redis</a><a href='##' onmousedown=showDiv('tools~redis') id='aexp_tools~redis'><span class='exp_style' id='exp_tools~redis'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~redis')) document.getElementById('aexp_tools~redis').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~smb/?opendiv=tools'>smb</a><a href='##' onmousedown=showDiv('tools~smb') id='aexp_tools~smb'><span class='exp_style' id='exp_tools~smb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~smb')) document.getElementById('aexp_tools~smb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~socksvpn/?opendiv=tools'>socksvpn</a><a href='##' onmousedown=showDiv('tools~socksvpn') id='aexp_tools~socksvpn'><span class='exp_style' id='exp_tools~socksvpn'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~socksvpn')) document.getElementById('aexp_tools~socksvpn').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~sqlmap/?opendiv=tools'>sqlmap</a><a href='##' onmousedown=showDiv('tools~sqlmap') id='aexp_tools~sqlmap'><span class='exp_style' id='exp_tools~sqlmap'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~sqlmap')) document.getElementById('aexp_tools~sqlmap').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~sqlserver/?opendiv=tools'>sqlserver</a><a href='##' onmousedown=showDiv('tools~sqlserver') id='aexp_tools~sqlserver'><span class='exp_style' id='exp_tools~sqlserver'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~sqlserver')) document.getElementById('aexp_tools~sqlserver').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~squid/?opendiv=tools'>squid</a><a href='##' onmousedown=showDiv('tools~squid') id='aexp_tools~squid'><span class='exp_style' id='exp_tools~squid'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~squid')) document.getElementById('aexp_tools~squid').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssl/?opendiv=tools'>ssl</a><a href='##' onmousedown=showDiv('tools~ssl') id='aexp_tools~ssl'><span class='exp_style' id='exp_tools~ssl'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ssl')) document.getElementById('aexp_tools~ssl').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~switch/?opendiv=tools'>switch</a><a href='##' onmousedown=showDiv('tools~switch') id='aexp_tools~switch'><span class='exp_style' id='exp_tools~switch'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~switch')) document.getElementById('aexp_tools~switch').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~vim/?opendiv=tools'>vim</a><a href='##' onmousedown=showDiv('tools~vim') id='aexp_tools~vim'><span class='exp_style' id='exp_tools~vim'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~vim')) document.getElementById('aexp_tools~vim').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~wxwork/?opendiv=tools'>wxwork</a><a href='##' onmousedown=showDiv('tools~wxwork') id='aexp_tools~wxwork'><span class='exp_style' id='exp_tools~wxwork'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~wxwork')) document.getElementById('aexp_tools~wxwork').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(114)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>25</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~docker/?opendiv=system'>docker</a><a href='##' onmousedown=showDiv('system~docker') id='aexp_system~docker'><span class='exp_style' id='exp_system~docker'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~docker')) document.getElementById('aexp_system~docker').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~fs/?opendiv=system'>fs</a><a href='##' onmousedown=showDiv('system~fs') id='aexp_system~fs'><span class='exp_style' id='exp_system~fs'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~fs')) document.getElementById('aexp_system~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~grub/?opendiv=system'>grub</a><a href='##' onmousedown=showDiv('system~grub') id='aexp_system~grub'><span class='exp_style' id='exp_system~grub'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~grub')) document.getElementById('aexp_system~grub').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~hik/?opendiv=system'>hik</a><a href='##' onmousedown=showDiv('system~hik') id='aexp_system~hik'><span class='exp_style' id='exp_system~hik'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~hik')) document.getElementById('aexp_system~hik').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~influx/?opendiv=system'>influx</a><a href='##' onmousedown=showDiv('system~influx') id='aexp_system~influx'><span class='exp_style' id='exp_system~influx'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~influx')) document.getElementById('aexp_system~influx').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~mail/?opendiv=system'>mail</a><a href='##' onmousedown=showDiv('system~mail') id='aexp_system~mail'><span class='exp_style' id='exp_system~mail'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~mail')) document.getElementById('aexp_system~mail').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~rpmbuild/?opendiv=system'>rpmbuild</a><a href='##' onmousedown=showDiv('system~rpmbuild') id='aexp_system~rpmbuild'><span class='exp_style' id='exp_system~rpmbuild'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~rpmbuild')) document.getElementById('aexp_system~rpmbuild').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>18</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(274)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~10gb/?opendiv=kernel'>10gb</a><a href='##' onmousedown=showDiv('kernel~10gb') id='aexp_kernel~10gb'><span class='exp_style' id='exp_kernel~10gb'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~10gb')) document.getElementById('aexp_kernel~10gb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~bonding/?opendiv=kernel'>bonding</a><a href='##' onmousedown=showDiv('kernel~bonding') id='aexp_kernel~bonding'><span class='exp_style' id='exp_kernel~bonding'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~bonding')) document.getElementById('aexp_kernel~bonding').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~clock/?opendiv=kernel'>clock</a><a href='##' onmousedown=showDiv('kernel~clock') id='aexp_kernel~clock'><span class='exp_style' id='exp_kernel~clock'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~clock')) document.getElementById('aexp_kernel~clock').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~crypto/?opendiv=kernel'>crypto</a><a href='##' onmousedown=showDiv('kernel~crypto') id='aexp_kernel~crypto'><span class='exp_style' id='exp_kernel~crypto'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~crypto')) document.getElementById('aexp_kernel~crypto').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fpu/?opendiv=kernel'>fpu</a><a href='##' onmousedown=showDiv('kernel~fpu') id='aexp_kernel~fpu'><span class='exp_style' id='exp_kernel~fpu'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fpu')) document.getElementById('aexp_kernel~fpu').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fs/?opendiv=kernel'>fs</a><a href='##' onmousedown=showDiv('kernel~fs') id='aexp_kernel~fs'><span class='exp_style' id='exp_kernel~fs'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fs')) document.getElementById('aexp_kernel~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~ipsec/?opendiv=kernel'>ipsec</a><a href='##' onmousedown=showDiv('kernel~ipsec') id='aexp_kernel~ipsec'><span class='exp_style' id='exp_kernel~ipsec'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~ipsec')) document.getElementById('aexp_kernel~ipsec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>34</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mptcp/?opendiv=kernel'>mptcp</a><a href='##' onmousedown=showDiv('kernel~mptcp') id='aexp_kernel~mptcp'><span class='exp_style' id='exp_kernel~mptcp'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mptcp')) document.getElementById('aexp_kernel~mptcp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>113</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~proc/?opendiv=kernel'>proc</a><a href='##' onmousedown=showDiv('kernel~proc') id='aexp_kernel~proc'><span class='exp_style' id='exp_kernel~proc'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~proc')) document.getElementById('aexp_kernel~proc').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>20</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~signature/?opendiv=kernel'>signature</a><a href='##' onmousedown=showDiv('kernel~signature') id='aexp_kernel~signature'><span class='exp_style' id='exp_kernel~signature'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~signature')) document.getElementById('aexp_kernel~signature').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sound/?opendiv=kernel'>sound</a><a href='##' onmousedown=showDiv('kernel~sound') id='aexp_kernel~sound'><span class='exp_style' id='exp_kernel~sound'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~sound')) document.getElementById('aexp_kernel~sound').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~tcp/?opendiv=kernel'>tcp</a><a href='##' onmousedown=showDiv('kernel~tcp') id='aexp_kernel~tcp'><span class='exp_style' id='exp_kernel~tcp'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~tcp')) document.getElementById('aexp_kernel~tcp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~vpn/?opendiv=kernel'>vpn</a><a href='##' onmousedown=showDiv('kernel~vpn') id='aexp_kernel~vpn'><span class='exp_style' id='exp_kernel~vpn'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~vpn')) document.getElementById('aexp_kernel~vpn').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(84)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~http/?opendiv=debug'>http</a><a href='##' onmousedown=showDiv('debug~http') id='aexp_debug~http'><span class='exp_style' id='exp_debug~http'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~http')) document.getElementById('aexp_debug~http').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~ksplice/?opendiv=debug'>ksplice</a><a href='##' onmousedown=showDiv('debug~ksplice') id='aexp_debug~ksplice'><span class='exp_style' id='exp_debug~ksplice'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~ksplice')) document.getElementById('aexp_debug~ksplice').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(28)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>15</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~g9300/?opendiv=android'>g9300</a><a href='##' onmousedown=showDiv('android~g9300') id='aexp_android~g9300'><span class='exp_style' id='exp_android~g9300'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~g9300')) document.getElementById('aexp_android~g9300').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(33)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>24</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~game/?opendiv=algorithm'>game</a><a href='##' onmousedown=showDiv('algorithm~game') id='aexp_algorithm~game'><span class='exp_style' id='exp_algorithm~game'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~game')) document.getElementById('aexp_algorithm~game').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/lernel~ipsec/?opendiv=algorithm'>ipsec</a><a href='##' onmousedown=showDiv('algorithm~ipsec') id='aexp_algorithm~ipsec'><span class='exp_style' id='exp_algorithm~ipsec'>[+]</span></a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~ipsec')) document.getElementById('aexp_algorithm~ipsec').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories
<span class='right_span'>(925)</span>

</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2024/'>2024</a><a href='##' onmousedown=showDiv('2024')><span class='exp_style' id='exp_2024'>[+]</span></a><span class='right_span'>(45)</span></li>
<div id='2024' class='catsub'><li><a href='/blog/cats/2024~07/?opendiv=2024'>2024-07</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2024~06/?opendiv=2024'>2024-06</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2024~05/?opendiv=2024'>2024-05</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~04/?opendiv=2024'>2024-04</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~03/?opendiv=2024'>2024-03</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~02/?opendiv=2024'>2024-02</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2024~01/?opendiv=2024'>2024-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2023/'>2023</a><a href='##' onmousedown=showDiv('2023')><span class='exp_style' id='exp_2023'>[+]</span></a><span class='right_span'>(87)</span></li>
<div id='2023' class='catsub'><li><a href='/blog/cats/2023~12/?opendiv=2023'>2023-12</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2023~11/?opendiv=2023'>2023-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2023~10/?opendiv=2023'>2023-10</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2023~09/?opendiv=2023'>2023-09</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2023~08/?opendiv=2023'>2023-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2023~07/?opendiv=2023'>2023-07</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2023~06/?opendiv=2023'>2023-06</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2023~05/?opendiv=2023'>2023-05</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2023~04/?opendiv=2023'>2023-04</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2023~03/?opendiv=2023'>2023-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2023~02/?opendiv=2023'>2023-02</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2023~01/?opendiv=2023'>2023-01</a><span class='right_span'>18</span></li>
</div><li class='catclass'><a href='/blog/cats/2022/'>2022</a><a href='##' onmousedown=showDiv('2022')><span class='exp_style' id='exp_2022'>[+]</span></a><span class='right_span'>(83)</span></li>
<div id='2022' class='catsub'><li><a href='/blog/cats/2022~12/?opendiv=2022'>2022-12</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2022~11/?opendiv=2022'>2022-11</a><span class='right_span'>16</span></li>
<li><a href='/blog/cats/2022~10/?opendiv=2022'>2022-10</a><span class='right_span'>17</span></li>
<li><a href='/blog/cats/2022~09/?opendiv=2022'>2022-09</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2022~08/?opendiv=2022'>2022-08</a><span class='right_span'>29</span></li>
<li><a href='/blog/cats/2022~07/?opendiv=2022'>2022-07</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2021/'>2021</a><a href='##' onmousedown=showDiv('2021')><span class='exp_style' id='exp_2021'>[+]</span></a><span class='right_span'>(73)</span></li>
<div id='2021' class='catsub'><li><a href='/blog/cats/2021~07/?opendiv=2021'>2021-07</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2021~06/?opendiv=2021'>2021-06</a><span class='right_span'>34</span></li>
<li><a href='/blog/cats/2021~05/?opendiv=2021'>2021-05</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2021~04/?opendiv=2021'>2021-04</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2021~03/?opendiv=2021'>2021-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2021~01/?opendiv=2021'>2021-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2020/'>2020</a><a href='##' onmousedown=showDiv('2020')><span class='exp_style' id='exp_2020'>[+]</span></a><span class='right_span'>(70)</span></li>
<div id='2020' class='catsub'><li><a href='/blog/cats/2020~12/?opendiv=2020'>2020-12</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2020~11/?opendiv=2020'>2020-11</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2020~10/?opendiv=2020'>2020-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2020~09/?opendiv=2020'>2020-09</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2020~08/?opendiv=2020'>2020-08</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2020~07/?opendiv=2020'>2020-07</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2020~05/?opendiv=2020'>2020-05</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2020~01/?opendiv=2020'>2020-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2019/'>2019</a><a href='##' onmousedown=showDiv('2019')><span class='exp_style' id='exp_2019'>[+]</span></a><span class='right_span'>(22)</span></li>
<div id='2019' class='catsub'><li><a href='/blog/cats/2019~12/?opendiv=2019'>2019-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2019~10/?opendiv=2019'>2019-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2019~08/?opendiv=2019'>2019-08</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2019~06/?opendiv=2019'>2019-06</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2019~01/?opendiv=2019'>2019-01</a><span class='right_span'>3</span></li>
</div><li class='catclass'><a href='/blog/cats/2018/'>2018</a><a href='##' onmousedown=showDiv('2018')><span class='exp_style' id='exp_2018'>[+]</span></a><span class='right_span'>(56)</span></li>
<div id='2018' class='catsub'><li><a href='/blog/cats/2018~12/?opendiv=2018'>2018-12</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2018~11/?opendiv=2018'>2018-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2018~10/?opendiv=2018'>2018-10</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~09/?opendiv=2018'>2018-09</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~08/?opendiv=2018'>2018-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~07/?opendiv=2018'>2018-07</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2018~06/?opendiv=2018'>2018-06</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2018~04/?opendiv=2018'>2018-04</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2018~03/?opendiv=2018'>2018-03</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2018~02/?opendiv=2018'>2018-02</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2018~01/?opendiv=2018'>2018-01</a><span class='right_span'>9</span></li>
</div><li class='catclass'><a href='/blog/cats/2017/'>2017</a><a href='##' onmousedown=showDiv('2017')><span class='exp_style' id='exp_2017'>[+]</span></a><span class='right_span'>(10)</span></li>
<div id='2017' class='catsub'><li><a href='/blog/cats/2017~12/?opendiv=2017'>2017-12</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2017~07/?opendiv=2017'>2017-07</a><span class='right_span'>8</span></li>
</div><li class='catclass'><a href='/blog/cats/2016/'>2016</a><a href='##' onmousedown=showDiv('2016')><span class='exp_style' id='exp_2016'>[+]</span></a><span class='right_span'>(21)</span></li>
<div id='2016' class='catsub'><li><a href='/blog/cats/2016~08/?opendiv=2016'>2016-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~05/?opendiv=2016'>2016-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2016~03/?opendiv=2016'>2016-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2016~02/?opendiv=2016'>2016-02</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~01/?opendiv=2016'>2016-01</a><span class='right_span'>6</span></li>
</div><li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(207)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~12/?opendiv=2015'>2015-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2015~11/?opendiv=2015'>2015-11</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2015~10/?opendiv=2015'>2015-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 124%" href="/tags/10gb/">10gb(7)</a>
<a style="font-size: 114%" href="/tags/lvm/">LVM(5)</a>
<a style="font-size: 100%" href="/tags/chrome-debug/">chrome_debug(3)</a>
<a style="font-size: 131%" href="/tags/gdb/">gdb(9)</a>
<a style="font-size: 127%" href="/tags/git/">git(8)</a>
<a style="font-size: 114%" href="/tags/ipv6/">ipv6(5)</a>
<a style="font-size: 124%" href="/tags/ixgbe/">ixgbe(7)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 100%" href="/tags/lvs/">lvs(3)</a>
<a style="font-size: 131%" href="/tags/mptcp/">mptcp(9)</a>
<a style="font-size: 119%" href="/tags/nginx/">nginx(6)</a>
<a style="font-size: 114%" href="/tags/squid/">squid(5)</a>
<a style="font-size: 131%" href="/tags/vpn/">vpn(9)</a>
<a style="font-size: 108%" href="/tags/shu-ju-cai-ji/">数据采集(4)</a>
<a style="font-size: 141%" href="/tags/hui-bian/">汇编(13)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2024/07/31/lvm-attr/">LVM 输出更多信息</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/31/lvm-pvmove/">LVM 缩减 VG 大小 ( pvmove )</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/31/lang-web-override/">Chrome浏览器使用Overrides调试线上代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/31/lang-web-fetch/">fetch使用介绍, chrome如何重新提交请求并且更改参数</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/31/lang-web-95598/">95598停电公告信息抓取</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/30/lang-php-sm1234/">sm1、sm2、sm3、sm4简单介绍</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/30/lang-php-sm2/">php sm2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/30/lang-php-sm3/">php sm3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/30/lang-php-bgcolor/">php spreadsheet 填充背景色</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/07/30/lang-php-mb/">php统计文章字数</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href='https://blog.csdn.net/abcdxyzk2?type=blog' target=_blank>CSDN博客</a>
	</li>
	<li>
		<a href='https://www.cnblogs.com/abcdxyzk' target=_blank>博客园</a>
	</li>
	<li>
		<a href='http://blog.chinaunix.net/uid/29997432.html' target=_blank>ChinaUnix博客</a>
	</li>
	<li>
		<a href='https://blog.51cto.com/u_16189960' target=_blank>51CTO博客</a>
	</li>
	<li>
		<a href='https://segmentfault.com/a/1190000044015394' target=_blank>segmentfault博客</a>
	</li>
	<li>
		<a href='http://hi.baidu.com/abcdxyzk' target=_blank>hi.baidu</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/zhangskd' target=_blank>zhangsk</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/justlinux2010' target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href='http://simohayha.iteye.com/' target=_blank>simohayha</a>
	</li>
	<li>
		<a href='http://linux.chinaunix.net/techdoc/net/' target=_blank>技术文档</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/cybertan' target=_blank>cybertan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/newnewman80' target=_blank>newnewman80</a>
	</li>
	<li>
		<a href='http://www.cppblog.com/fwxjj/' target=_blank>fwxjj</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/ustc_dylan' target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/nkguohao' target=_blank>nkguohao</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/yusiguyuan' target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href='http://www.oenhan.com/' target=_blank>oenhan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/bullbat' target=_blank>bullbat</a>
	</li>
	<li>
		<a href='http://www.wowotech.net/' target=_blank>wowotech</a>
	</li>
	<li>
		<a href='http://www.lenky.info/' target=_blank>lenky</a>
	</li>
	<li>
		<a href='http://smilejay.com/' target=_blank>smilejay</a>
	</li>
	<li>
		<a href='http://blog.chinaunix.net/uid/10167808.html' target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<!--
<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>
-->

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo">  Copyright &copy; 2024 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//www.abcxyzkk.xyz/matomo/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->


<!-- Histats.com  (div with counter) --><div id="histats_counter"></div>
<!-- Histats.com  START  (aync)-->
<!--
<script type="text/javascript">var _Hasync= _Hasync|| [];
_Hasync.push(['Histats.start', '1,4673876,4,107,170,20,00010000']);
_Hasync.push(['Histats.fasi', '1']);
_Hasync.push(['Histats.track_hits', '']);
(function() {
var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
hs.src = ('//s10.histats.com/js15_as.js');
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
})();</script>
<noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4673876&101" alt="simple hit counter" border="0"></a></noscript>
-->
<!-- Histats.com  END  -->

<!--  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
-->


<!--
<script>

// TODO 无法获取框架内元素
function autoads()
{
try {
	console.log('start');
	var txt = document.getElementById('mys-content').innerHTML;
	var len = txt.length;
	var url = '';
	console.log(len);
	for (var i = 0; i < len - 10; i ++) {
		if (txt.substring(i, i + 6) == 'href="') {
			i = i + 6;
			url = '';
			for ( ; i < len; i ++) {
				if (txt[i] == '"')
					break;
				url += txt[i];
			}
			url = url.replace(/&amp;/g, '&');
		//	console.log(url);
		}
	}
	console.log(url);
	if (url != '' && Math.random() < 0.3)
		window.open(url, "_blank");
} catch (e) {
}
}

window.onload = function() {
	setTimeout("autoads()", 5*1000);
}
</script>
-->


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
