
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
<!--  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script> -->
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8245190595992760"
     crossorigin="anonymous"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2><br>date [-d @int|str] [+%s|"+%F %T"]<br>netstat -ltunp<br>sar -n DEV 1</h2>
  
  <div class="hwx" style='text-align: left; position: absolute; margin-top: -130px; white-space: nowrap;'>
	  <img src="/images/wx_ok.png" width=130px; height=130px;>
	  <img src="/images/ali_ok.png" width=130px; height=130px; style="margin-left:30px;">
  </div>
</hgroup>

</header>
  <nav role="navigation" style='white-space: nowrap; min-width=1120px; position: sticky; top: 0; z-index: 999;'><form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search..." style="height:1.5em;">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">

function StringToAscii(str) {
	return str.charCodeAt(0).toString(16);
}

function AsciiToString(asccode) {
	return String.fromCharCode(asccode);
}

function UrlDecode(zipStr) {
	var uzipStr = '';
	for (var i = 0; i < zipStr.length; i += 1) {
		var chr = zipStr.charAt(i);
		if (chr === '+') {
			uzipStr += ' ';
		} else if (chr === '%') {
			var asc = zipStr.substring(i + 1, i + 3);
			if (parseInt('0x' + asc) > 0x7f) {
				uzipStr += decodeURI('%' + asc.toString() + zipStr.substring(i+3, i+9).toString());
				i += 8;
			} else {
				uzipStr += AsciiToString(parseInt('0x' + asc));
				i += 2;
			}
		} else {
			uzipStr += chr;
		}
	}
	return uzipStr;
}

/*
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = UrlDecode(query);
}
*/

var query = window.location.search.substring(1);
var vars = query.split("&");
for (var i = 0; i < vars.length; i ++) {
	var pair = vars[i].split("=");
	if (pair[0] == 'query') {
		document.getElementById('query').value = UrlDecode(pair[1]);
		break;
	}
}

</script>

<!-- Start of Site Search 360 Scripts -->
<!-- Search 360 达到次数后要收费，换成静态索引
<script type="text/javascript">
var ss360Config = {
    siteId: "abcdxyzk.github.io",
    searchBox: {
        selector: "input#query",
        searchButton: "input#query+input[type='submit']"
    }
}
</script>
<script src="https://cdn.sitesearch360.com/v13/sitesearch360-v13.min.js" async></script>
-->
<!-- End of Site Search 360 Scripts -->

<ul class="subscription" data-subscription="rss">
<li>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/search">Search</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/03/27/kernel-net-netdevice/">内核网络设备的注册与初始化(eth0...)</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T17:56:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:56:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>找到eth0&hellip;之类的设备的数据结构</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># crash vmlinux
</span><span class='line'>
</span><span class='line'>p init_net
</span><span class='line'>找到：
</span><span class='line'>  dev_base_head = {
</span><span class='line'>&#9;next = 0xffff88003e48b070, 
</span><span class='line'>&#9;prev = 0xffff880037582070
</span><span class='line'>  },
</span><span class='line'>next 就是 struct net_device *dev; 中 dev-&gt;dev_list;
</span><span class='line'>算算 dev_list 在 dev 中的偏移为0x50（可能会不同）
</span><span class='line'>
</span><span class='line'>struct net_device 0xffff88003e48b020
</span><span class='line'>然后根据 dev中的dev_list.next取下一个net_device
</span><span class='line'>  dev_list = {
</span><span class='line'>&#9;next = 0xffff880037582070, 
</span><span class='line'>&#9;prev = 0xffffffff81b185b0
</span><span class='line'>  },</span></code></pre></td></tr></table></div></figure>


<h4>找到net_device对应的XXX_adapter, 如ixgbe_adapter</h4>

<p>ixgbe模块在申请net_device时会把需要预留给ixgbe_adapter的空间大小传给alloc_etherdev</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netdev = alloc_etherdev(sizeof(struct ixgbe_adapter));
</span><span class='line'>
</span><span class='line'>adapter = netdev_priv(netdev);
</span><span class='line'>
</span><span class='line'>static inline void *netdev_priv(const struct net_device *dev)
</span><span class='line'>{
</span><span class='line'>&#9;return (char *)dev + ALIGN(sizeof(struct net_device), NETDEV_ALIGN);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>所以ixgbe_adapter在net_device结构按32位对其后面，偏移0x6c0（视内核而定）</p>

<hr />

<p><a href="http://blog.csdn.net/sfrysh/article/details/5736752">http://blog.csdn.net/sfrysh/article/details/5736752</a></p>

<p>首先来看如何分配内存给一个网络设备。</p>

<p>内核通过alloc_netdev来分配内存给一个指定的网络设备:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define alloc_netdev(sizeof_priv, name, setup) /   
</span><span class='line'>&#9;alloc_netdev_mq(sizeof_priv, name, setup, 1)   
</span><span class='line'>  
</span><span class='line'>struct net_device *alloc_netdev_mq(int sizeof_priv, const char *name,   
</span><span class='line'>&#9;&#9;void (*setup)(struct net_device *), unsigned int queue_count)  </span></code></pre></td></tr></table></div></figure>


<p>其中alloc_netdev_mq中的第一个元素是每个网络设备的私有数据(主要是包含一些硬件参数，比如中断之类的)的大小，也就是net_device结构中的priv的大小。第二个参数是设备名，我们传递进来一般都是一个待format的字符串，比如"eth%d",到时多个相同类型网卡设备就会依次为eth0,1(内核会通过dev_alloc_name来进行设置)&hellip; 第三个参数setup是一个初始化net_device结构的回调函数。</p>

<p>可是一般我们不需要直接调用alloc_netdev的，内核提供了一些包装好的函数：</p>

<p>这里我们只看alloc_etherdev：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define alloc_etherdev(sizeof_priv) alloc_etherdev_mq(sizeof_priv, 1)   
</span><span class='line'>struct net_device *alloc_etherdev_mq(int sizeof_priv, unsigned int queue_count)   
</span><span class='line'>{   
</span><span class='line'>&#9;return alloc_netdev_mq(sizeof_priv, "eth%d", ether_setup, queue_count);   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>这里实际是根据网卡的类型进行包装，也就类似于oo中的基类，ether_setup初始化一些所有相同类型的网络设备的一些相同配置的域：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void ether_setup(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;dev-&gt;header_ops      = &eth_header_ops;   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;change_mtu      = eth_change_mtu;   
</span><span class='line'>&#9;dev-&gt;set_mac_address     = eth_mac_addr;   
</span><span class='line'>&#9;dev-&gt;validate_addr   = eth_validate_addr;   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;type        = ARPHRD_ETHER;   
</span><span class='line'>&#9;dev-&gt;hard_header_len     = ETH_HLEN;   
</span><span class='line'>&#9;dev-&gt;mtu     = ETH_DATA_LEN;   
</span><span class='line'>&#9;dev-&gt;addr_len        = ETH_ALEN;   
</span><span class='line'>&#9;dev-&gt;tx_queue_len    = 1000; /* Ethernet wants good queues */  
</span><span class='line'>&#9;dev-&gt;flags       = IFF_BROADCAST|IFF_MULTICAST;   
</span><span class='line'>  
</span><span class='line'>&#9;memset(dev-&gt;broadcast, 0xFF, ETH_ALEN);   
</span><span class='line'>  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>接下来我们来看注册网络设备的一些细节。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int register_netdev(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;int err;   
</span><span class='line'>  
</span><span class='line'>&#9;rtnl_lock();   
</span><span class='line'>  
</span><span class='line'>&#9;/*  
</span><span class='line'>&#9; * If the name is a format string the caller wants us to do a  
</span><span class='line'>&#9; * name allocation.  
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;if (strchr(dev-&gt;name, '%')) {   
</span><span class='line'>&#9;&#9;// 这里通过dev_alloc_name函数来对设备名进行设置。   
</span><span class='line'>&#9;&#9;err = dev_alloc_name(dev, dev-&gt;name);   
</span><span class='line'>&#9;&#9;if (err &lt; 0)   
</span><span class='line'>&#9;&#9;&#9;goto out;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 注册当前的网络设备到全局的网络设备链表中.下面会详细看这个函数.   
</span><span class='line'>&#9;err = register_netdevice(dev);   
</span><span class='line'>out:   
</span><span class='line'>&#9;rtnl_unlock();   
</span><span class='line'>&#9;return err;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>整个网络设备就是一个链表，他需要很方便的遍历所有设备，以及很快的定位某个指定的设备。为此net_device包含了下面3个链表(有关内核中数据结构的介绍，可以去自己google下)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 可以根据index来定位设备   
</span><span class='line'>struct hlist_node   index_hlist;   
</span><span class='line'>// 可以根据name来定位设备   
</span><span class='line'>struct hlist_node   name_hlist;   
</span><span class='line'>// 通过dev_list，将此设备插入到全局的dev_base_head中，我们下面会介绍这个。   
</span><span class='line'>struct list_head    dev_list;  </span></code></pre></td></tr></table></div></figure>


<p>当设备注册成功后，还需要通知内核的其他组件，这里通过netdev_chain类型的notifier chain来通知其他组件。事件是NETDEV_REGISTER..其他设备通过register_netdevice_notifier来注册自己感兴趣的事件到此notifier chain上。</p>

<p>网络设备(比如打开或关闭一个设备)，与用户空间的通信通过rtmsg_ifinfo函数，也就是RTMGRP_LINK的netlink。</p>

<p>每个设备还包含两个状态，一个是state字段，表示排队策略状态(用位图表示)，一个是注册状态。</p>

<p>包的排队策略也就是qos了。。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int register_netdevice(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct hlist_head *head;   
</span><span class='line'>&#9;struct hlist_node *p;   
</span><span class='line'>&#9;int ret;   
</span><span class='line'>&#9;struct net *net;   
</span><span class='line'>  
</span><span class='line'>&#9;BUG_ON(dev_boot_phase);   
</span><span class='line'>&#9;ASSERT_RTNL();   
</span><span class='line'>  
</span><span class='line'>&#9;might_sleep();   
</span><span class='line'>  
</span><span class='line'>&#9;/* When net_device's are persistent, this will be fatal. */  
</span><span class='line'>&#9;BUG_ON(dev-&gt;reg_state != NETREG_UNINITIALIZED);   
</span><span class='line'>&#9;BUG_ON(!dev_net(dev));   
</span><span class='line'>&#9;net = dev_net(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化相关的锁   
</span><span class='line'>&#9;spin_lock_init(&dev-&gt;addr_list_lock);   
</span><span class='line'>&#9;netdev_set_addr_lockdep_class(dev);   
</span><span class='line'>&#9;netdev_init_queue_locks(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;iflink = -1;   
</span><span class='line'>  
</span><span class='line'>&#9;/* Init, if this function is available */  
</span><span class='line'>&#9;if (dev-&gt;init) {   
</span><span class='line'>&#9;&#9;ret = dev-&gt;init(dev);   
</span><span class='line'>&#9;&#9;if (ret) {   
</span><span class='line'>&#9;&#9;&#9;if (ret &gt; 0)   
</span><span class='line'>&#9;&#9;&#9;&#9;ret = -EIO;   
</span><span class='line'>&#9;&#9;&#9;goto out;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;if (!dev_valid_name(dev-&gt;name)) {   
</span><span class='line'>&#9;&#9;ret = -EINVAL;   
</span><span class='line'>&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 给设备分配一个唯一的identifier.   
</span><span class='line'>&#9;dev-&gt;ifindex = dev_new_index(net);   
</span><span class='line'>&#9;if (dev-&gt;iflink == -1)   
</span><span class='line'>&#9;&#9;dev-&gt;iflink = dev-&gt;ifindex;   
</span><span class='line'>  
</span><span class='line'>&#9;// 在全局的链表中检测是否有重复的名字   
</span><span class='line'>&#9;head = dev_name_hash(net, dev-&gt;name);   
</span><span class='line'>&#9;hlist_for_each(p, head) {   
</span><span class='line'>&#9;&#9;struct net_device *d   
</span><span class='line'>&#9;&#9;&#9;= hlist_entry(p, struct net_device, name_hlist);   
</span><span class='line'>&#9;&#9;if (!strncmp(d-&gt;name, dev-&gt;name, IFNAMSIZ)) {   
</span><span class='line'>&#9;&#9;&#9;ret = -EEXIST;   
</span><span class='line'>&#9;&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 下面是检测一些特性的组合是否合法。   
</span><span class='line'>&#9;/* Fix illegal checksum combinations */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_HW_CSUM) &&   
</span><span class='line'>&#9;&#9;(dev-&gt;features & (NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM))) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: mixed HW and IP checksum settings./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~(NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM);   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_NO_CSUM) &&   
</span><span class='line'>&#9;&#9;(dev-&gt;features & (NETIF_F_HW_CSUM|NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM))) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: mixed no checksumming and other settings./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~(NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM|NETIF_F_HW_CSUM);   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>&#9;/* Fix illegal SG+CSUM combinations. */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_SG) &&   
</span><span class='line'>&#9;&#9;!(dev-&gt;features & NETIF_F_ALL_CSUM)) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: Dropping NETIF_F_SG since no checksum feature./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~NETIF_F_SG;   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;/* TSO requires that SG is present as well. */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_TSO) &&   
</span><span class='line'>&#9;&#9;!(dev-&gt;features & NETIF_F_SG)) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: Dropping NETIF_F_TSO since no SG feature./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~NETIF_F_TSO;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;if (dev-&gt;features & NETIF_F_UFO) {   
</span><span class='line'>&#9;&#9;if (!(dev-&gt;features & NETIF_F_HW_CSUM)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "%s: Dropping NETIF_F_UFO since no "  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;"NETIF_F_HW_CSUM feature./n",   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;dev-&gt;name);   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;features &= ~NETIF_F_UFO;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;&#9;if (!(dev-&gt;features & NETIF_F_SG)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "%s: Dropping NETIF_F_UFO since no "  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;"NETIF_F_SG feature./n",   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;dev-&gt;name);   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;features &= ~NETIF_F_UFO;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;/* Enable software GSO if SG is supported. */  
</span><span class='line'>&#9;if (dev-&gt;features & NETIF_F_SG)   
</span><span class='line'>&#9;&#9;dev-&gt;features |= NETIF_F_GSO;   
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化设备驱动的kobject并创建相关的sysfs   
</span><span class='line'>&#9;netdev_initialize_kobject(dev);   
</span><span class='line'>&#9;ret = netdev_register_kobject(dev);   
</span><span class='line'>&#9;if (ret)   
</span><span class='line'>&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;// 设置注册状态。   
</span><span class='line'>&#9;dev-&gt;reg_state = NETREG_REGISTERED;   
</span><span class='line'>  
</span><span class='line'>&#9;/*  
</span><span class='line'>&#9; *  Default initial state at registry is that the  
</span><span class='line'>&#9; *  device is present.  
</span><span class='line'>&#9; */  
</span><span class='line'>  
</span><span class='line'>&#9;// 设置排队策略状态。   
</span><span class='line'>&#9;set_bit(__LINK_STATE_PRESENT, &dev-&gt;state);   
</span><span class='line'>&#9;// 初始化排队规则   
</span><span class='line'>&#9;dev_init_scheduler(dev);   
</span><span class='line'>&#9;dev_hold(dev);   
</span><span class='line'>&#9;// 将相应的链表插入到全局的链表中。紧接着会介绍这个函数   
</span><span class='line'>&#9;list_netdevice(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;/* Notify protocols, that a new device appeared. */  
</span><span class='line'>&#9;// 调用netdev_chain通知内核其他子系统。   
</span><span class='line'>&#9;ret = call_netdevice_notifiers(NETDEV_REGISTER, dev);   
</span><span class='line'>&#9;ret = notifier_to_errno(ret);   
</span><span class='line'>&#9;if (ret) {   
</span><span class='line'>&#9;&#9;rollback_registered(dev);   
</span><span class='line'>&#9;&#9;dev-&gt;reg_state = NETREG_UNREGISTERED;   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>out:   
</span><span class='line'>&#9;return ret;   
</span><span class='line'>  
</span><span class='line'>err_uninit:   
</span><span class='line'>&#9;if (dev-&gt;uninit)   
</span><span class='line'>&#9;&#9;dev-&gt;uninit(dev);   
</span><span class='line'>&#9;goto out;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>这里要注意有一个全局的struct net init_net;变量，这个变量保存了全局的name,index  hlist以及全局的网络设备链表。</p>

<p>net结构我们这里所需要的也就三个链表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 设备链表   
</span><span class='line'>struct list_head    dev_base_head;   
</span><span class='line'>// 名字为索引的hlist   
</span><span class='line'>struct hlist_head   *dev_name_head;   
</span><span class='line'>// index为索引的hlist   
</span><span class='line'>struct hlist_head   *dev_index_head;  </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int list_netdevice(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct net *net = dev_net(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;ASSERT_RTNL();   
</span><span class='line'>  
</span><span class='line'>&#9;write_lock_bh(&dev_base_lock);   
</span><span class='line'>&#9;// 插入全局的list   
</span><span class='line'>&#9;list_add_tail(&dev-&gt;dev_list, &net-&gt;dev_base_head);   
</span><span class='line'>&#9;// 插入全局的name_list以及index_hlist   
</span><span class='line'>&#9;hlist_add_head(&dev-&gt;name_hlist, dev_name_hash(net, dev-&gt;name));   
</span><span class='line'>&#9;hlist_add_head(&dev-&gt;index_hlist, dev_index_hash(net, dev-&gt;ifindex));   
</span><span class='line'>&#9;write_unlock_bh(&dev_base_lock);   
</span><span class='line'>&#9;return 0;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>最终执行完之后，注册函数将会执行rtnl_unlock函数，而此函数则会执行netdev_run_todo方法。也就是完成最终的注册。(要注意，当取消注册这个设备时也会调用这个函数来完成最终的取消注册)</p>

<p>这里有一个全局的net_todo_list的链表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static LIST_HEAD(net_todo_list);  </span></code></pre></td></tr></table></div></figure>


<p>而在取消注册的函数中会调用这个函数：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void net_set_todo(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;list_add_tail(&dev-&gt;todo_list, &net_todo_list);   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>也就是把当前将要取消注册的函数加入到todo_list链表中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void netdev_run_todo(void)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct list_head list;   
</span><span class='line'>  
</span><span class='line'>&#9;/* Snapshot list, allow later requests */  
</span><span class='line'>&#9;// replace掉net_todo_list用list代替。   
</span><span class='line'>&#9;list_replace_init(&net_todo_list, &list);   
</span><span class='line'>  
</span><span class='line'>&#9;__rtnl_unlock();   
</span><span class='line'>&#9;// 当注册设备时没有调用net_set_todo函数来设置net_todo_list，因此list为空，所以就会直接跳过。   
</span><span class='line'>&#9;while (!list_empty(&list)) {   
</span><span class='line'>&#9;&#9;// 通过todo_list得到当前的device对象。   
</span><span class='line'>&#9;&#9;struct net_device *dev   
</span><span class='line'>&#9;&#9;&#9;= list_entry(list.next, struct net_device, todo_list);   
</span><span class='line'>&#9;&#9;// 删除此todo_list;   
</span><span class='line'>&#9;&#9;list_del(&dev-&gt;todo_list);   
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (unlikely(dev-&gt;reg_state != NETREG_UNREGISTERING)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "network todo '%s' but state %d/n",   
</span><span class='line'>&#9;&#9;&#9;&#9;   dev-&gt;name, dev-&gt;reg_state);   
</span><span class='line'>&#9;&#9;&#9;dump_stack();   
</span><span class='line'>&#9;&#9;&#9;continue;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;&#9;// 设置注册状态为NETREG_UNREGISTERED.   
</span><span class='line'>&#9;&#9;dev-&gt;reg_state = NETREG_UNREGISTERED;   
</span><span class='line'>&#9;&#9;// 在每个cpu上调用刷新函数。   
</span><span class='line'>&#9;&#9;on_each_cpu(flush_backlog, dev, 1);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;// 等待引用此设备的所有系统释放资源，也就是引用计数清0.   
</span><span class='line'>&#9;&#9;netdev_wait_allrefs(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* paranoia */  
</span><span class='line'>&#9;&#9;BUG_ON(atomic_read(&dev-&gt;refcnt));   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;ip_ptr);   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;ip6_ptr);   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;dn_ptr);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (dev-&gt;destructor)   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;destructor(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* Free network device */  
</span><span class='line'>&#9;&#9;kobject_put(&dev-&gt;dev.kobj);   
</span><span class='line'>&#9;}   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>下面来看netdev_wait_allrefs函数，我们先看它的调用流程:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void netdev_wait_allrefs(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;unsigned long rebroadcast_time, warning_time;   
</span><span class='line'>  
</span><span class='line'>&#9;rebroadcast_time = warning_time = jiffies;   
</span><span class='line'>&#9;while (atomic_read(&dev-&gt;refcnt) != 0) {   
</span><span class='line'>&#9;&#9;if (time_after(jiffies, rebroadcast_time + 1 * HZ)) {   
</span><span class='line'>&#9;&#9;&#9;rtnl_lock();   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;// 给netdev_chain发送NETDEV_UNREGISTER事件，通知各个子模块释放资源   
</span><span class='line'>&#9;&#9;&#9;/* Rebroadcast unregister notification */  
</span><span class='line'>&#9;&#9;&#9;call_netdevice_notifiers(NETDEV_UNREGISTER, dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;if (test_bit(__LINK_STATE_LINKWATCH_PENDING,   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9; &dev-&gt;state)) {   
</span><span class='line'>&#9;&#9;&#9;&#9;/* We must not have linkwatch events  
</span><span class='line'>&#9;&#9;&#9;&#9; * pending on unregister. If this  
</span><span class='line'>&#9;&#9;&#9;&#9; * happens, we simply run the queue  
</span><span class='line'>&#9;&#9;&#9;&#9; * unscheduled, resulting in a noop  
</span><span class='line'>&#9;&#9;&#9;&#9; * for this device.  
</span><span class='line'>&#9;&#9;&#9;&#9; */  
</span><span class='line'>&#9;&#9;&#9;&#9;linkwatch_run_queue();   
</span><span class='line'>&#9;&#9;&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;__rtnl_unlock();   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;rebroadcast_time = jiffies;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;msleep(250);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (time_after(jiffies, warning_time + 10 * HZ)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_EMERG "unregister_netdevice: "  
</span><span class='line'>&#9;&#9;&#9;&#9;   "waiting for %s to become free. Usage "  
</span><span class='line'>&#9;&#9;&#9;&#9;   "count = %d/n",   
</span><span class='line'>&#9;&#9;&#9;&#9;   dev-&gt;name, atomic_read(&dev-&gt;refcnt));   
</span><span class='line'>&#9;&#9;&#9;warning_time = jiffies;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/03/27/kernel-net-tso3/">TCP的TSO/GSO处理（二）</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T17:45:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:45:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://book.51cto.com/art/201206/345021.htm">http://book.51cto.com/art/201206/345021.htm</a></p>

<p>有些网络设备硬件可以完成一些传统上由CPU完成的任务，最常见的例子就是计算三层和四层校验和。有些网络设备甚至可以维护四层协议的状态机，由硬件完成分段或分片，因此传输层通过网络层提交给网络设备时可能是个GSO段，参见1.3.1节。本节论述SKB的成员都是用来支持GSO的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_size </span></code></pre></td></tr></table></div></figure>


<p>生成GSO段时的MSS，因为GSO段的长度是与发送该段的套接口中合适MSS的整数倍。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_segs </span></code></pre></td></tr></table></div></figure>


<p>GSO段的长度是gso_size的倍数，即用gso_size来分割大段时产生的段数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_type </span></code></pre></td></tr></table></div></figure>


<p>该SKB中的数据支持的GSO类型，见表3-5。</p>

<p>表3-5  gso_type的取值</p>

<p>gso_type            描述<br/>
SKB_GSO_TCPV4   IPv4的TCP段卸载<br/>
SKB_GSO_UDP     IPv4的UDP分片卸载<br/>
SKB_GSO_DODGY   表明数据报是从一个不可信赖的来源发出的<br/>
SKB_GSO_TCP_ECN IPv4的TCP段卸载，当设置TCP首部的CWR时，使用此gos_type。CWR参见29.4节<br/>
SKB_GSO_TCPV6   IPv6的TCP段卸载</p>

<hr />

<p><a href="http://blog.csdn.net/majieyue/article/details/11881325">http://blog.csdn.net/majieyue/article/details/11881325</a></p>

<p>GSO用来扩展之前的TSO，目前已经并入upstream内核。TSO只能支持tcp协议，而GSO可以支持tcpv4, tcpv6, udp等协议。在GSO之前，skb_shinfo(skb)有两个成员ufo_size, tso_size，分别表示udp fragmentation offloading支持的分片长度，以及tcp segmentation offloading支持的分段长度，现在都用skb_shinfo(skb)->gso_size代替。skb_shinfo(skb)->ufo_segs, skb_shinfo(skb)->tso_segs也被替换成了skb_shinfo(skb)->gso_segs，表示分片的个数。</p>

<p>skb_shinfo(skb)->gso_type包括SKB_GSO_TCPv4, SKB_GSO_UDPv4，同时NETIF_F_XXX的标志也增加了相应的bit，标识设备是否支持TSO, GSO, e.g.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NETIF_F_TSO = SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT
</span><span class='line'>NETIF_F_UFO = SKB_GSO_UDPV4 &lt;&lt; NETIF_F_GSO_SHIFT
</span><span class='line'>#define NETIF_F_GSO_SHIFT 16</span></code></pre></td></tr></table></div></figure>


<p>dev_hard_start_xmit在调用设备驱动的发送函数之前，会通过netif_needs_gso判断是否需要软件做GSO，如果需要，那么会调用到dev_gso_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  dev_gso_segment - Perform emulated hardware segmentation on skb.
</span><span class='line'> *  @skb: buffer to segment
</span><span class='line'> *
</span><span class='line'> *  This function segments the given skb and stores the list of segments
</span><span class='line'> *  in skb-&gt;next.
</span><span class='line'> */
</span><span class='line'>static int dev_gso_segment(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct net_device *dev = skb-&gt;dev;
</span><span class='line'>&#9;struct sk_buff *segs;
</span><span class='line'>&#9;int features = dev-&gt;features & ~(illegal_highdma(dev, skb) ?
</span><span class='line'>&#9;                 NETIF_F_SG : 0);
</span><span class='line'>
</span><span class='line'>&#9;segs = skb_gso_segment(skb, features);
</span><span class='line'>
</span><span class='line'>&#9;/* Verifying header integrity only. */
</span><span class='line'>&#9;if (!segs)
</span><span class='line'>&#9;    return 0;
</span><span class='line'>
</span><span class='line'>&#9;if (IS_ERR(segs))
</span><span class='line'>&#9;    return PTR_ERR(segs);
</span><span class='line'>
</span><span class='line'>&#9;skb-&gt;next = segs;
</span><span class='line'>&#9;DEV_GSO_CB(skb)-&gt;destructor = skb-&gt;destructor;
</span><span class='line'>&#9;skb-&gt;destructor = dev_gso_skb_destructor;
</span><span class='line'>
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>分析skb_gso_segment之前，看下析构过程，此时skb经过分片之后已经是一个skb list，通过skb->next串在一起，此时把初始的skb->destructor函数存到skb->cb中，然后把skb->destructor变更为dev_gso_skb_destructor。</p>

<p>dev_gso_skb_destructor会把skb->next一个个通过kfree_skb释放掉，最后调用DEV_GSO_CB(skb)->destructor，即skb初始的析构函数做最后的清理。</p>

<p>skb_gso_segment是通过软件方式模拟网卡分段的函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *skb_gso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *segs = ERR_PTR(-EPROTONOSUPPORT);
</span><span class='line'>&#9;struct packet_type *ptype;
</span><span class='line'>&#9;__be16 type = skb-&gt;protocol;
</span><span class='line'>&#9;int err;
</span><span class='line'>
</span><span class='line'>&#9;skb_reset_mac_header(skb);
</span><span class='line'>&#9;skb-&gt;mac_len = skb-&gt;network_header - skb-&gt;mac_header;
</span><span class='line'>&#9;__skb_pull(skb, skb-&gt;mac_len);
</span><span class='line'>
</span><span class='line'>&#9;if (unlikely(skb-&gt;ip_summed != CHECKSUM_PARTIAL)) {
</span><span class='line'>&#9;    struct net_device *dev = skb-&gt;dev;
</span><span class='line'>&#9;    struct ethtool_drvinfo info = {};
</span><span class='line'>
</span><span class='line'>&#9;    if (dev && dev-&gt;ethtool_ops && dev-&gt;ethtool_ops-&gt;get_drvinfo)
</span><span class='line'>&#9;        dev-&gt;ethtool_ops-&gt;get_drvinfo(dev, &info);
</span><span class='line'>
</span><span class='line'>&#9;    WARN(1, "%s: caps=(0x%lx, 0x%lx) len=%d data_len=%d "
</span><span class='line'>&#9;        "ip_summed=%d",
</span><span class='line'>&#9;         info.driver, dev ? dev-&gt;features : 0L,
</span><span class='line'>&#9;         skb-&gt;sk ? skb-&gt;sk-&gt;sk_route_caps : 0L,
</span><span class='line'>&#9;         skb-&gt;len, skb-&gt;data_len, skb-&gt;ip_summed);
</span><span class='line'>
</span><span class='line'>&#9;    if (skb_header_cloned(skb) &&
</span><span class='line'>&#9;        (err = pskb_expand_head(skb, 0, 0, GFP_ATOMIC)))
</span><span class='line'>&#9;        return ERR_PTR(err);
</span><span class='line'>
</span><span class='line'>如果skb header是clone，分离出来
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>如果skb-&gt;ip_summed 不是 CHECKSUM_PARTIAL，那么报个warning，因为GSO类型的skb其ip_summed一般都是CHECKSUM_PARTIAL
</span><span class='line'>
</span><span class='line'>&#9;rcu_read_lock();
</span><span class='line'>&#9;list_for_each_entry_rcu(ptype,
</span><span class='line'>&#9;        &ptype_base[ntohs(type) & PTYPE_HASH_MASK], list) {
</span><span class='line'>&#9;    if (ptype-&gt;type == type && !ptype-&gt;dev && ptype-&gt;gso_segment) {
</span><span class='line'>&#9;        if (unlikely(skb-&gt;ip_summed != CHECKSUM_PARTIAL)) {
</span><span class='line'>&#9;            err = ptype-&gt;gso_send_check(skb);
</span><span class='line'>&#9;            segs = ERR_PTR(err);
</span><span class='line'>&#9;            if (err || skb_gso_ok(skb, features))
</span><span class='line'>&#9;                break;
</span><span class='line'>&#9;            __skb_push(skb, (skb-&gt;data -
</span><span class='line'>&#9;                     skb_network_header(skb)));
</span><span class='line'>&#9;        }
</span><span class='line'>&#9;        segs = ptype-&gt;gso_segment(skb, features);
</span><span class='line'>&#9;        break;
</span><span class='line'>
</span><span class='line'>把skb-&gt;data指向network header，然后调用inet_gso_segment，四层的gso_segment会在inet_gso_segment中被调用
</span><span class='line'>&#9;    }
</span><span class='line'>&#9;}
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>
</span><span class='line'>&#9;__skb_push(skb, skb-&gt;data - skb_mac_header(skb));
</span><span class='line'>
</span><span class='line'>把skb-&gt;data再次指向mac header
</span><span class='line'>
</span><span class='line'>&#9;return segs;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static struct sk_buff *inet_gso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>&#9;struct iphdr *iph;
</span><span class='line'>&#9;const struct net_protocol *ops;
</span><span class='line'>&#9;int proto;
</span><span class='line'>&#9;int ihl;
</span><span class='line'>&#9;int id;
</span><span class='line'>&#9;unsigned int offset = 0;
</span><span class='line'>
</span><span class='line'>&#9;if (!(features & NETIF_F_V4_CSUM))
</span><span class='line'>&#9;    features &= ~NETIF_F_SG;
</span><span class='line'>如果设备不支持NETIF_F_V4_CSUM，那么就当设备不支持SG
</span><span class='line'>
</span><span class='line'>&#9;if (unlikely(skb_shinfo(skb)-&gt;gso_type &
</span><span class='line'>&#9;         ~(SKB_GSO_TCPV4 |
</span><span class='line'>&#9;           SKB_GSO_UDP |
</span><span class='line'>&#9;           SKB_GSO_DODGY |
</span><span class='line'>&#9;           SKB_GSO_TCP_ECN |
</span><span class='line'>&#9;           0)))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>gso_type不合法，直接返错
</span><span class='line'>
</span><span class='line'>&#9;if (unlikely(!pskb_may_pull(skb, sizeof(*iph))))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>20字节ip头部无法获得，返错
</span><span class='line'>
</span><span class='line'>&#9;iph = ip_hdr(skb);
</span><span class='line'>&#9;ihl = iph-&gt;ihl * 4;
</span><span class='line'>&#9;if (ihl &lt; sizeof(*iph))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;if (unlikely(!pskb_may_pull(skb, ihl)))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>实际ip头部无法获得，返错
</span><span class='line'>
</span><span class='line'>&#9;__skb_pull(skb, ihl);
</span><span class='line'>&#9;skb_reset_transport_header(skb);
</span><span class='line'>&#9;iph = ip_hdr(skb);
</span><span class='line'>
</span><span class='line'>OK，现在拿到ip头部了
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;id = ntohs(iph-&gt;id);
</span><span class='line'>
</span><span class='line'>ip包的id
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;proto = iph-&gt;protocol & (MAX_INET_PROTOS - 1);
</span><span class='line'>&#9;segs = ERR_PTR(-EPROTONOSUPPORT);
</span><span class='line'>
</span><span class='line'>&#9;rcu_read_lock();
</span><span class='line'>&#9;ops = rcu_dereference(inet_protos[proto]);
</span><span class='line'>&#9;if (likely(ops && ops-&gt;gso_segment))
</span><span class='line'>&#9;    segs = ops-&gt;gso_segment(skb, features);
</span><span class='line'>
</span><span class='line'>如果是tcp，那么调用tcp_tso_segment，如果是udp，那么调用udp4_ufo_fragment
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>
</span><span class='line'>&#9;if (!segs || IS_ERR(segs))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;skb = segs;
</span><span class='line'>&#9;do {
</span><span class='line'>&#9;    iph = ip_hdr(skb);
</span><span class='line'>&#9;    if (proto == IPPROTO_UDP) {
</span><span class='line'>&#9;        iph-&gt;id = htons(id);
</span><span class='line'>&#9;        iph-&gt;frag_off = htons(offset &gt;&gt; 3);
</span><span class='line'>&#9;        if (skb-&gt;next != NULL)
</span><span class='line'>&#9;            iph-&gt;frag_off |= htons(IP_MF);
</span><span class='line'>&#9;        offset += (skb-&gt;len - skb-&gt;mac_len - iph-&gt;ihl * 4);
</span><span class='line'>&#9;    } else
</span><span class='line'>&#9;        iph-&gt;id = htons(id++);
</span><span class='line'>&#9;    iph-&gt;tot_len = htons(skb-&gt;len - skb-&gt;mac_len);
</span><span class='line'>&#9;    iph-&gt;check = 0;
</span><span class='line'>&#9;    iph-&gt;check = ip_fast_csum(skb_network_header(skb), iph-&gt;ihl);
</span><span class='line'>&#9;} while ((skb = skb-&gt;next));
</span><span class='line'>
</span><span class='line'>对每一个skb segment，填充ip包头，计算ip checksum。如果是tcp segmentation，那么ip头的id递增。如果是udp fragmentation，那么ip头的id不变，每次计算增加的offset，等于是在做ip分片
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>下面来看TCP协议的分段函数tcp_tso_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *tcp_tso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>&#9;struct tcphdr *th;
</span><span class='line'>&#9;unsigned thlen;
</span><span class='line'>&#9;unsigned int seq;
</span><span class='line'>&#9;__be32 delta;
</span><span class='line'>&#9;unsigned int oldlen;
</span><span class='line'>&#9;unsigned int mss;
</span><span class='line'>
</span><span class='line'>&#9;if (!pskb_may_pull(skb, sizeof(*th)))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;th = tcp_hdr(skb);
</span><span class='line'>&#9;thlen = th-&gt;doff * 4;
</span><span class='line'>&#9;if (thlen &lt; sizeof(*th))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;if (!pskb_may_pull(skb, thlen))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;oldlen = (u16)~skb-&gt;len;
</span><span class='line'>&#9;__skb_pull(skb, thlen);
</span><span class='line'>把tcp header移到skb header里，把skb-&gt;len存到oldlen中，此时skb-&gt;len就只有tcp payload的长度
</span><span class='line'>
</span><span class='line'>&#9;mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>&#9;if (unlikely(skb-&gt;len &lt;= mss))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;if (skb_gso_ok(skb, features | NETIF_F_GSO_ROBUST)) {
</span><span class='line'>&#9;    /* Packet is from an untrusted source, reset gso_segs. */
</span><span class='line'>&#9;    int type = skb_shinfo(skb)-&gt;gso_type;
</span><span class='line'>
</span><span class='line'>&#9;    if (unlikely(type &
</span><span class='line'>&#9;             ~(SKB_GSO_TCPV4 |
</span><span class='line'>&#9;               SKB_GSO_DODGY |
</span><span class='line'>&#9;               SKB_GSO_TCP_ECN |
</span><span class='line'>&#9;               SKB_GSO_TCPV6 |
</span><span class='line'>&#9;               0) ||
</span><span class='line'>&#9;             !(type & (SKB_GSO_TCPV4 | SKB_GSO_TCPV6))))
</span><span class='line'>&#9;        goto out;
</span><span class='line'>
</span><span class='line'>&#9;    skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss);
</span><span class='line'>重新计算skb_shinfo(skb)-&gt;gso_segs的个数，基于skb-&gt;len和mss值
</span><span class='line'>
</span><span class='line'>&#9;    segs = NULL;
</span><span class='line'>&#9;    goto out;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;segs = skb_segment(skb, features);
</span><span class='line'>&#9;if (IS_ERR(segs))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>skb_segment是真正的分段实现，后面再分析
</span><span class='line'>
</span><span class='line'>&#9;delta = htonl(oldlen + (thlen + mss));
</span><span class='line'>
</span><span class='line'>&#9;skb = segs;
</span><span class='line'>&#9;th = tcp_hdr(skb);
</span><span class='line'>&#9;seq = ntohl(th-&gt;seq);
</span><span class='line'>
</span><span class='line'>&#9;do {
</span><span class='line'>&#9;    th-&gt;fin = th-&gt;psh = 0;
</span><span class='line'>
</span><span class='line'>&#9;    th-&gt;check = ~csum_fold((__force __wsum)((__force u32)th-&gt;check +
</span><span class='line'>&#9;                   (__force u32)delta));
</span><span class='line'>&#9;    if (skb-&gt;ip_summed != CHECKSUM_PARTIAL)
</span><span class='line'>&#9;        th-&gt;check =
</span><span class='line'>&#9;             csum_fold(csum_partial(skb_transport_header(skb),
</span><span class='line'>&#9;                        thlen, skb-&gt;csum));
</span><span class='line'>对每个分段都要计算tcp checksum
</span><span class='line'>
</span><span class='line'>&#9;    seq += mss;
</span><span class='line'>&#9;    skb = skb-&gt;next;
</span><span class='line'>&#9;    th = tcp_hdr(skb);
</span><span class='line'>
</span><span class='line'>&#9;    th-&gt;seq = htonl(seq);
</span><span class='line'>
</span><span class='line'>对每个分段重新计算sequence值
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    th-&gt;cwr = 0;
</span><span class='line'>&#9;} while (skb-&gt;next);
</span><span class='line'>
</span><span class='line'>&#9;delta = htonl(oldlen + (skb-&gt;tail - skb-&gt;transport_header) +
</span><span class='line'>&#9;          skb-&gt;data_len);
</span><span class='line'>&#9;th-&gt;check = ~csum_fold((__force __wsum)((__force u32)th-&gt;check +
</span><span class='line'>&#9;            (__force u32)delta));
</span><span class='line'>&#9;if (skb-&gt;ip_summed != CHECKSUM_PARTIAL)
</span><span class='line'>&#9;    th-&gt;check = csum_fold(csum_partial(skb_transport_header(skb),
</span><span class='line'>&#9;                       thlen, skb-&gt;csum));
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>UDP协议的分片函数是udp4_ufo_fragment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *udp4_ufo_fragment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>&#9;unsigned int mss;
</span><span class='line'>&#9;int offset;
</span><span class='line'>&#9;__wsum csum;
</span><span class='line'>
</span><span class='line'>&#9;mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>&#9;if (unlikely(skb-&gt;len &lt;= mss))
</span><span class='line'>&#9;    goto out;
</span><span class='line'>
</span><span class='line'>&#9;if (skb_gso_ok(skb, features | NETIF_F_GSO_ROBUST)) {
</span><span class='line'>&#9;    /* Packet is from an untrusted source, reset gso_segs. */
</span><span class='line'>&#9;    int type = skb_shinfo(skb)-&gt;gso_type;
</span><span class='line'>
</span><span class='line'>&#9;    if (unlikely(type & ~(SKB_GSO_UDP | SKB_GSO_DODGY) ||
</span><span class='line'>&#9;             !(type & (SKB_GSO_UDP))))
</span><span class='line'>&#9;        goto out;
</span><span class='line'>
</span><span class='line'>&#9;    skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss);
</span><span class='line'>
</span><span class='line'>&#9;    segs = NULL;
</span><span class='line'>&#9;    goto out;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* Do software UFO. Complete and fill in the UDP checksum as HW cannot
</span><span class='line'>&#9; * do checksum of UDP packets sent as multiple IP fragments.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;offset = skb-&gt;csum_start - skb_headroom(skb);
</span><span class='line'>&#9;csum = skb_checksum(skb, offset, skb-&gt;len - offset, 0);
</span><span class='line'>&#9;offset += skb-&gt;csum_offset;
</span><span class='line'>&#9;*(__sum16 *)(skb-&gt;data + offset) = csum_fold(csum);
</span><span class='line'>&#9;skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>计算udp的checksum
</span><span class='line'>
</span><span class='line'>&#9;/* Fragment the skb. IP headers of the fragments are updated in
</span><span class='line'>&#9; * inet_gso_segment()
</span><span class='line'>&#9; */
</span><span class='line'>&#9;segs = skb_segment(skb, features);
</span><span class='line'>out:
</span><span class='line'>&#9;return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>udp的分段其实和ip的分片没什么区别，只是多一个计算checksum的步骤</p>

<p>最后来分析下skb_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *skb_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *segs = NULL;
</span><span class='line'>&#9;struct sk_buff *tail = NULL;
</span><span class='line'>&#9;struct sk_buff *fskb = skb_shinfo(skb)-&gt;frag_list;
</span><span class='line'>&#9;unsigned int mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>&#9;unsigned int doffset = skb-&gt;data - skb_mac_header(skb);
</span><span class='line'>&#9;unsigned int offset = doffset;
</span><span class='line'>&#9;unsigned int headroom;
</span><span class='line'>&#9;unsigned int len;
</span><span class='line'>&#9;int sg = features & NETIF_F_SG;
</span><span class='line'>&#9;int nfrags = skb_shinfo(skb)-&gt;nr_frags;
</span><span class='line'>&#9;int err = -ENOMEM;
</span><span class='line'>&#9;int i = 0;
</span><span class='line'>&#9;int pos;
</span><span class='line'>
</span><span class='line'>&#9;__skb_push(skb, doffset);
</span><span class='line'>&#9;headroom = skb_headroom(skb);
</span><span class='line'>&#9;pos = skb_headlen(skb);
</span><span class='line'>
</span><span class='line'>skb-&gt;data指向mac header，计算headroom，skb_headlen长度
</span><span class='line'>
</span><span class='line'>&#9;do {
</span><span class='line'>&#9;    struct sk_buff *nskb;
</span><span class='line'>&#9;    skb_frag_t *frag;
</span><span class='line'>&#9;    int hsize;
</span><span class='line'>&#9;    int size;
</span><span class='line'>
</span><span class='line'>&#9;    len = skb-&gt;len - offset;
</span><span class='line'>&#9;    if (len &gt; mss)
</span><span class='line'>&#9;        len = mss;
</span><span class='line'>len为skb-&gt;len减去直到offset的部分。开始时，offset只是mac header + ip header + tcp header的长度，len即tcp payload的长度。随着segment增加, offset每次都增加mss长度。因此len的定义是每个segment的payload长度（最后一个segment的payload可能小于一个mss长度）
</span><span class='line'>
</span><span class='line'>&#9;    hsize = skb_headlen(skb) - offset;
</span><span class='line'>
</span><span class='line'>hsize为skb header减去offset后的大小，如果hsize小于0，那么说明payload在skb的frags, frag_list中。随着offset一直增长，必定会有hsize一直&lt;0的情况开始出现，除非skb是一个完全linearize化的skb
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    if (hsize &lt; 0)
</span><span class='line'>&#9;        hsize = 0;
</span><span class='line'>
</span><span class='line'>这种情况说明skb_headlen没有tcp payload的部分，需要pull数据过来
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    if (hsize &gt; len || !sg)
</span><span class='line'>&#9;        hsize = len;
</span><span class='line'>
</span><span class='line'>如果不支持sg同时hsize大于len，那么hsize就为len，此时说明segment的payload还在skb header中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    if (!hsize && i &gt;= nfrags) {
</span><span class='line'>&#9;        BUG_ON(fskb-&gt;len != len);
</span><span class='line'>
</span><span class='line'>&#9;        pos += len;
</span><span class='line'>&#9;        nskb = skb_clone(fskb, GFP_ATOMIC);
</span><span class='line'>&#9;        fskb = fskb-&gt;next;
</span><span class='line'>
</span><span class='line'>&#9;        if (unlikely(!nskb))
</span><span class='line'>&#9;            goto err;
</span><span class='line'>
</span><span class='line'>&#9;        hsize = skb_end_pointer(nskb) - nskb-&gt;head;
</span><span class='line'>&#9;        if (skb_cow_head(nskb, doffset + headroom)) {
</span><span class='line'>&#9;            kfree_skb(nskb);
</span><span class='line'>&#9;            goto err;
</span><span class='line'>&#9;        }
</span><span class='line'>
</span><span class='line'>&#9;        nskb-&gt;truesize += skb_end_pointer(nskb) - nskb-&gt;head -
</span><span class='line'>&#9;                  hsize;
</span><span class='line'>&#9;        skb_release_head_state(nskb);
</span><span class='line'>&#9;        __skb_push(nskb, doffset);
</span><span class='line'>&#9;    } else {
</span><span class='line'>
</span><span class='line'>&#9;        nskb = alloc_skb(hsize + doffset + headroom,
</span><span class='line'>&#9;                 GFP_ATOMIC);
</span><span class='line'>
</span><span class='line'>&#9;        if (unlikely(!nskb))
</span><span class='line'>&#9;            goto err;
</span><span class='line'>
</span><span class='line'>&#9;        skb_reserve(nskb, headroom);
</span><span class='line'>&#9;        __skb_put(nskb, doffset);
</span><span class='line'>
</span><span class='line'>alloc新的skb，skb-&gt;data到skb-&gt;head之间保留headroom，skb-&gt;tail到skb-&gt;data之间保留mac header + ip header + tcp header + hsize的长度
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    }
</span><span class='line'>
</span><span class='line'>&#9;    if (segs)
</span><span class='line'>&#9;        tail-&gt;next = nskb;
</span><span class='line'>&#9;    else
</span><span class='line'>&#9;        segs = nskb;
</span><span class='line'>&#9;    tail = nskb;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    __copy_skb_header(nskb, skb);
</span><span class='line'>&#9;    nskb-&gt;mac_len = skb-&gt;mac_len;
</span><span class='line'>把老skb的skb_buff内容拷贝到新skb中
</span><span class='line'>
</span><span class='line'>&#9;    /* nskb and skb might have different headroom */
</span><span class='line'>&#9;    if (nskb-&gt;ip_summed == CHECKSUM_PARTIAL)
</span><span class='line'>&#9;        nskb-&gt;csum_start += skb_headroom(nskb) - headroom;
</span><span class='line'>修正下checksum计算的位置
</span><span class='line'>
</span><span class='line'>&#9;    skb_reset_mac_header(nskb);
</span><span class='line'>&#9;    skb_set_network_header(nskb, skb-&gt;mac_len);
</span><span class='line'>&#9;    nskb-&gt;transport_header = (nskb-&gt;network_header +
</span><span class='line'>&#9;                  skb_network_header_len(skb));
</span><span class='line'>&#9;    skb_copy_from_linear_data(skb, nskb-&gt;data, doffset);
</span><span class='line'>
</span><span class='line'>把skb-&gt;data开始doffset长度的内容拷贝到nskb-&gt;data中，即把mac header , ip header, tcp header都复制过去
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    if (fskb != skb_shinfo(skb)-&gt;frag_list)
</span><span class='line'>&#9;        continue;
</span><span class='line'>
</span><span class='line'>&#9;    if (!sg) {
</span><span class='line'>&#9;        nskb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>&#9;        nskb-&gt;csum = skb_copy_and_csum_bits(skb, offset,
</span><span class='line'>&#9;                            skb_put(nskb, len),
</span><span class='line'>&#9;                            len, 0);
</span><span class='line'>&#9;        continue;
</span><span class='line'>&#9;    }
</span><span class='line'>
</span><span class='line'>&#9;    frag = skb_shinfo(nskb)-&gt;frags;
</span><span class='line'>
</span><span class='line'>&#9;    skb_copy_from_linear_data_offset(skb, offset,
</span><span class='line'>&#9;                     skb_put(nskb, hsize), hsize);
</span><span class='line'>
</span><span class='line'>如果hsize不为0，那么拷贝hsize的内容到nskb header中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    while (pos &lt; offset + len && i &lt; nfrags) {
</span><span class='line'>
</span><span class='line'>offset + len长度超过了pos，即超过了nskb header，这时需要用到frag
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;        *frag = skb_shinfo(skb)-&gt;frags[i];
</span><span class='line'>&#9;        get_page(frag-&gt;page);
</span><span class='line'>&#9;        size = frag-&gt;size;
</span><span class='line'>
</span><span class='line'>&#9;        if (pos &lt; offset) {
</span><span class='line'>&#9;            frag-&gt;page_offset += offset - pos;
</span><span class='line'>&#9;            frag-&gt;size -= offset - pos;
</span><span class='line'>&#9;        }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;        skb_shinfo(nskb)-&gt;nr_frags++;
</span><span class='line'>
</span><span class='line'>&#9;        if (pos + size &lt;= offset + len) {
</span><span class='line'>&#9;            i++;
</span><span class='line'>&#9;            pos += size;
</span><span class='line'>&#9;        } else {
</span><span class='line'>&#9;            frag-&gt;size -= pos + size - (offset + len);
</span><span class='line'>&#9;            goto skip_fraglist;
</span><span class='line'>&#9;        }
</span><span class='line'>
</span><span class='line'>&#9;        frag++;
</span><span class='line'>&#9;    }
</span><span class='line'>
</span><span class='line'>如果skb header空间不够，那么通过frag，把一个mss的内容拷贝到nskb的frag中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;    if (pos &lt; offset + len) {
</span><span class='line'>&#9;        struct sk_buff *fskb2 = fskb;
</span><span class='line'>
</span><span class='line'>&#9;        BUG_ON(pos + fskb-&gt;len != offset + len);
</span><span class='line'>
</span><span class='line'>&#9;        pos += fskb-&gt;len;
</span><span class='line'>&#9;        fskb = fskb-&gt;next;
</span><span class='line'>
</span><span class='line'>&#9;        if (fskb2-&gt;next) {
</span><span class='line'>&#9;            fskb2 = skb_clone(fskb2, GFP_ATOMIC);
</span><span class='line'>&#9;            if (!fskb2)
</span><span class='line'>&#9;                goto err;
</span><span class='line'>&#9;        } else
</span><span class='line'>&#9;            skb_get(fskb2);
</span><span class='line'>
</span><span class='line'>&#9;        SKB_FRAG_ASSERT(nskb);
</span><span class='line'>&#9;        skb_shinfo(nskb)-&gt;frag_list = fskb2;
</span><span class='line'>&#9;    }
</span><span class='line'>
</span><span class='line'>如果frag都用完还是无法满足mss的大小，那么就要用到frag_list，这段代码跳过去了，因为基本永远不会走到这里
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>skip_fraglist:
</span><span class='line'>&#9;    nskb-&gt;data_len = len - hsize;
</span><span class='line'>&#9;    nskb-&gt;len += nskb-&gt;data_len;
</span><span class='line'>&#9;    nskb-&gt;truesize += nskb-&gt;data_len;
</span><span class='line'>&#9;} while ((offset += len) &lt; skb-&gt;len);
</span><span class='line'>
</span><span class='line'>完成一个nskb之后，继续下一个seg，一直到offset &gt;= skb-&gt;len
</span><span class='line'>
</span><span class='line'>&#9;return segs;
</span><span class='line'>
</span><span class='line'>err:
</span><span class='line'>&#9;while ((skb = segs)) {
</span><span class='line'>&#9;    segs = skb-&gt;next;
</span><span class='line'>&#9;    kfree_skb(skb);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return ERR_PTR(err);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/03/23/kernel-net-frto/">FRTO—虚假超时剖析</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-23T14:37:00+08:00'><span class='date'>2015-03-23</span> <span class='time'>14:37:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/zhangskd/article/details/7446441">http://blog.csdn.net/zhangskd/article/details/7446441</a></p>

<p>F-RTO：Forward RTO-Recovery，for a TCP sender to recover after a retransmission timeout.
F-RTO的主要目的：The main motivation of the algorithm is to recover efficiently from a spurious
RTO.</p>

<h4>F-RTO的基本思想</h4>

<p>The guideline behind F-RTO is, that an RTO either indicates a loss, or it is caused by an
excessive delay in packet delivery while there still are outstanding segments in flight. If the
RTO was due to delay, i.e. the RTO was spurious, acknowledgements for non-retransmitted
segments sent before the RTO should arrive at the sender after the RTO occurred. If no such
segments arrive, the RTO is concluded to be non-spurious and the conventional RTO
recovery with go-back-N retransmissions should take place at the TCP sender.</p>

<p>To implement the principle described above, an F-RTO sender acts as follows: if the first ACK
arriving after a RTO-triggered retransmission advances the window, transmit two new segments
instead of continuing retransmissions. If also the second incoming acknowledgement advances
the window, RTO is likely to be spurious, because the second ACK is triggered by an originally
transmitted segment that has not been retransmitted after the RTO. If either one of the two
acknowledgements after RTO is a duplicate ACK, the sender continues retransmissions similarly
to the conventional RTO recovery algorithm.</p>

<p>When the retransmission timer expires, the F-RTO algorithm takes the following steps at the TCP
sender. In the algorithm description below we use SND.UNA to indicate the first unacknowledged
segment.</p>

<p>1.When the retransmission timer expires, retransmit the segment that triggered the timeout. As
required by the TCP congestion control specifications, the ssthresh is adjusted to half of the
number of currently outstanding segments. However, the congestion window is not yet set to one
segment, but the sender waits for the next two acknowledgements before deciding on what to do
with the congestion window.</p>

<p>2.When the first acknowledgement after RTO arrives at the sender, the sender chooses the
following actions depending on whether the ACK advances the window or whether it is a duplicate
ACK.</p>

<p>（a）If the acknowledgement advances SND.UNA, transmit up to two new (previously unsent)
segments. This is the main point in which the F-RTO algorithm differs from the conventional way
of recovering from RTO. After transmitting the two new segments, the congestion window size
is set to have the same value as ssthresh. In effect this reduces the transmission rate of the
sender to half of the transmission rate before the RTO. At this point the TCP sender has transmitted
a total of three segments after the RTO, similarly to the conventional recovery algorithm. If
transmitting two new segments is not possible due to advertised window limitation, or because
there is no more data to send, the sender may transmit only one segment. If now new data can
be transmitted, the TCP sender follows the conventional RTO recovery algorithm and starts
retransmitting the unacknowledged data using slow start.</p>

<p>（b）If the acknowledgement is duplicate ACK, set the congestion window to one segment and
proceed with the conventional RTO recovery. Two new segments are not transmitted in this case,
because the conventional RTO recovery algorithm would not transmit anything at this point either.
Instead, the F-RTO sender continues with slow start and performs similarly to the conventional
TCP sender in retransmitting the unacknowledged segments. Step 3 of the F-RTO algorithm is
not entered in this case. A common reason for executing this branch is the loss of a segment,
in which case the segments injected by the sender before the RTO may still trigger duplicate
ACKs that arrive at the sender after the RTO.</p>

<p>3.When the second acknowledgement after the RTO arrives, either continue transmitting new
data, or start retransmitting with the slow start algorithm, depending on whether new data was
acknowledged.</p>

<p>（a）If the acknowledgement advances SND.UNA, continue transmitting new data following
the congestion avoidance algorithm. Because the TCP sender has retransmitted only one
segment after the RTO, this acknowledgement indicates that an originally transmitted
segment has arrived at the receiver. This is regarded as a strong indication of a suprious
RTO. However, since the TCP sender cannot surely know at this point whether the segment
that triggered the RTO was actually lost, adjusting the congestion control parameters after
the RTO is the conservative action. From this point on, the TCP sender continues as in the
normal congestion avoidance.</p>

<p>If this algorithm branch is taken, the TCP sender ignores the send_high variable that indicates
the highest sequence number transmitted so far. The send_high variable was proposed as a
bugfix for avoiding unnecessary multiple fast retransmits when RTO expires during fast recovery
with NewReon TCP. As the sender has not retransmitted other segments but the one that
triggered RTO, the problem addressed by the bugfix cannot occur. Therefore, if there are
duplicate ACKs arriving at the sender after the RTO, they are likely to indicate a packet loss,
hence fast retransmit should bu used to allow efficient recovery. Alternatively, if there are not
enough duplicate ACKs arriving at the sender after a packet loss, the retransmission timer
expires another time and the sender enters step 1 of this algorithm to detect whether the
new RTO is spurious.</p>

<p>（b）If the acknowledgement is duplicate ACK, set the congestion window to three segments,
continue with the slow start algorithm retransmitting unacknowledged segments. The duplicate
ACK indicates that at least one segment other than the segment that triggered RTO is lost in the
last window of data. There is no sufficient evidence that any of the segments was delayed.
Therefore the sender proceeds with retransmissions similarly to the conventional RTO recovery
algorithm, with the send_high variable stored when the retransmission timer expired to avoid
unnecessary fast retransmits.</p>

<h4>引起RTO的主要因素：</h4>

<p>（1）Sudden delays<br/>
The primary motivation of the F-RTO algorithm is to improve the TCP performance when sudden
delays cause spurious retransmission timeouts.</p>

<p>（2）Packet losses<br/>
These timeouts occur mainly when retransmissions are lost, since lost original packets are
usually recovered by fast retransmit.</p>

<p>（3）Bursty losses<br/>
Losses of several successive packets can result in a retransmission timeout.</p>

<h5>造成虚假RTO的原因还有：</h5>

<p>Wireless links may also suffer from link outages that cause persistent data loss for a period
of time.<br/>
Oher potential reasons for sudden delays that have been reported to trigger spurious RTOs
include a delay due to tedious actions required to complete a hand-off or re-routing of packets
to the new serving access point after the hand-off, arrival of competing traffic on a shared link
with low bandwidth, and a sudden bandwidth degradation due to reduced resources on a
wireless channel.</p>

<h5>造成真实RTO的原因：</h5>

<p>A RTO-triggered retransmission is needed when a retransmission is lost, or when nearly a whole
window of data is lost, thus making it impossible for the receiver to generate enough duplicate
ACKs for triggering TCP fast retransmit.</p>

<h4>虚假RTO的后果</h4>

<p>If no segments were lost but the retransmission timer expires spuriously, the segments retransmitted
in the slow-start are sent unnecessarily. Particularly, this phenomenon is very possible with the
various wireless access network technologies that are prone to sudden delay spikes.
The retransmission timer expires because of the delay, spuriously triggering the RTO recovery and
unnecessarily retransmission of all unacknowledged segments. This happens because after the
delay the ACKs for the original segments arrive at the sender one at the time but too late, because
the TCP sender has already entered the RTO recovery. Therefore, each of the ACKs trigger the
retransmission of segments for which the original ACKs will arrive after a while. This continues
until the whole window of segments is eventually unnecessarily retransmitted. Furthermore,
because a full window of retransmitted segments arrive unnecessarily at the receiver, it generates
duplicate ACKs for these out-of-order segments. Later on, the duplicate ACKs unnecessarily
trigger fast retransmit at the sender.</p>

<p>TCP uses the fast retransmit mechanism to trigger retransmissions after receiving three successive
duplicate acknowledgements (ACKs). If for a certain time period TCP sender does not receive ACKs
that acknowledge new data, the TCP retransmission timer expires as a backoff mechanism.
When the retransmission time expires, the TCP sender retransmits the first unacknowledged
segment assuming it was lost in the network. Because a retransmission timeout (RTO) can be
an indication of severe congestion in the network, the TCP sender resets its congestion window
to one segment and starts increasing it according to the slow start algorithm.
However, if the RTO occurs spuriously and there still are segments outstanding in the network,
a false slow start is harmful for the potentially congested network as it injects extra segments
to the network at increasing rate.</p>

<p>虚假的RTO不仅会降低吞吐量，而且由于丢包后会使用慢启动算法，快速的向网络中注入数据包，
而此时网络中还有原来发送的数据包，这样可能会造成真正的网络拥塞！</p>

<p>How about Reliable link-layer protocol ?
Since wireless networks are often subject to high packet loss rate due to corruption or hand-offs,
reliable link-layer protocols are widely employed with wireless links. The link-layer receiver often
aims to deliver the packets to the upper protocol layers in order, which implies that the later
arriving packets are blocked until the head of the queue arrives successfully. Due to the strict
link-layer ordering, the communication end point observe a pause in packet delivery that can
cause a spurious TCP RTO instead of getting out-of-order packets that could result in a false
fast retransmit instead. Either way, interaction between TCP retransmission mechanisms
and link-layer recovery can cause poor performance.</p>

<p>DSACK不能解决此问题
If the unnecessary retransmissions occurred due to spurious RTO caused by a sudden delay,
the acknowledgements with the DSACK information arrive at the sender only after the
acknowledgements of the original segments. Therefore, the unnecessary retransmissions
following the spurious RTO cannot be avoided by using DSACK. Instead, the suggested
recovery algorithm using DSACK can only revert the congestion control parameters to the
state preceding the spurious retransmissions.</p>

<h4>F-RTO实现</h4>

<p>F-RTO is implemented (mainly) in four functions:<br/>
（1）tcp_use_frto() is used to determine if TCP can use F-RTO.</p>

<p>（2）tcp_enter_frto() prepares TCP state on RTO if F-RTO is used, it is called when tcp_use_frto() showed green light.</p>

<p>（3）tcp_process_frto() handles incoming ACKs during F-RTO algorithm.</p>

<p>（4）tcp_enter_frto_loss() is called if there is not enough evidence to prove that the RTO is indeed spurious. It transfers the control from F-RTO to the conventional RTO recovery.</p>

<h4>判断是否可以使用F-RTO</h4>

<p> 调用时机：当TCP段传送超时后，会引起段的重传，在重传定时器的处理过程中会判断是否可以使用F-RTO算法。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void tcp_retransmit_timer (struct sock *sk)  
</span><span class='line'>{  
</span><span class='line'>&#9;....  
</span><span class='line'>  
</span><span class='line'>&#9;if (tcp_use_frto(sk)) {  
</span><span class='line'>&#9;&#9;tcp_enter_frto(sk);  
</span><span class='line'>&#9;} else {  
</span><span class='line'>&#9;&#9;tcp_enter_loss(sk);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;....  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>能够使用F-RTO的条件：<br/>
（1）tcp_frto非零，此为TCP参数<br/>
（2）MTU probe没使用，因为它和F-RTO有冲突<br/>
（3）a. 如果启用了sackfrto，则可以使用<br/>
  b. 如果没启用sackfrto，不能重传过除head以外的数据</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* F-RTO can only be used if TCP has never retransmitted anything other than 
</span><span class='line'> * head (SACK enhanced variant from Appendix B of RFC4138 is more robust here) 
</span><span class='line'> */  
</span><span class='line'>int tcp_use_frto(struct sock *sk)  
</span><span class='line'>{  
</span><span class='line'>&#9;const struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;const struct inet_connection_sock *icsk = inet_csk(sk);  
</span><span class='line'>&#9;struct sk_buff *skb;  
</span><span class='line'>  
</span><span class='line'>&#9;if (! sysctl_tcp_frto)  
</span><span class='line'>&#9;&#9;return 0;  
</span><span class='line'>  
</span><span class='line'>&#9;/* MTU probe and F-RTO won't really play nicely along currently */  
</span><span class='line'>&#9;if (icsk-&gt;icsk_mtup.probe_size)  
</span><span class='line'>&#9;&#9;return 0;  
</span><span class='line'>  
</span><span class='line'>&#9;if (tcp_is_sackfrto(tp))  
</span><span class='line'>&#9;&#9;return 1;  
</span><span class='line'>  
</span><span class='line'>&#9;/* Avoid expensive walking of rexmit queue if possible */  
</span><span class='line'>&#9;if (tp-&gt;retrans_out &gt; 1)  
</span><span class='line'>&#9;&#9;return 0; /* 不能重过传除了head以外的数据*/  
</span><span class='line'>  
</span><span class='line'>&#9;skb = tcp_write_queue_head(sk);  
</span><span class='line'>&#9;if (tcp_skb_is_last(sk, skb))  
</span><span class='line'>&#9;&#9;return 1;  
</span><span class='line'>&#9;skb = tcp_write_queue_next(sk, skb); /* Skips head */  
</span><span class='line'>&#9;tcp_for_write_queue_from(skb, sk) {  
</span><span class='line'>&#9;&#9;if (skb == tcp_send_head(sk))  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_RETRANS)  
</span><span class='line'>&#9;&#9;&#9;return 0; /* 不允许处head以外的数据包被重传过 */  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* Short-circut when first non-SACKed skb has been checked */  
</span><span class='line'>&#9;&#9;if (! (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_SACKED_ACKED))  
</span><span class='line'>&#9;&#9;break;  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return 1;  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>static int tcp_is_sackfrto(const struct tcp_sock *tp)  
</span><span class='line'>{  
</span><span class='line'>&#9;return (sysctl_tcp_frto == 0x2) && ! tcp_is_reno(tp);  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>进入F-RTO状态</h4>

<p>启用F-RTO后，虽然传送超时，但还没进入Loss状态，相反，先进入Disorder状态。减小慢启动阈值，而snd_cwnd暂时保持不变。此时对应head数据包还没重传前。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* RTO occurred, but do not yet enter Loss state. Instead, defer RTO recovery 
</span><span class='line'> * a bit and use heuristics in tcp_process_frto() to detect if the RTO was  
</span><span class='line'> * spurious. 
</span><span class='line'> */  
</span><span class='line'>  
</span><span class='line'>void tcp_enter_frto (struct sock *sk)  
</span><span class='line'>{  
</span><span class='line'>&#9;const struct inet_connection_sock *icsk = inet_csk(sk);  
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;struct sk_buff *skb;  
</span><span class='line'>  
</span><span class='line'>&#9;/* Do like tcp_enter_loss() would*/  
</span><span class='line'>&#9;if ((! tp-&gt;frto_counter && icsk-&gt;icsk_ca_state &lt;= TCP_CA_Disorder) ||  
</span><span class='line'>&#9;&#9;tp-&gt;snd_una == tp-&gt;high_seq ||   
</span><span class='line'>&#9;&#9;((icsk-&gt;icsk_ca_state == TCP_CA_Loss || tp-&gt;frto_counter) &&  
</span><span class='line'>&#9;&#9;! icsk-&gt;icsk_retransmits)) {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tp-&gt;prior_ssthresh = tcp_current_ssthresh(sk); /* 保存旧阈值*/  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (tp-&gt;frto_counter) {   
</span><span class='line'>&#9;&#9;&#9;u32 stored_cwnd;  
</span><span class='line'>&#9;&#9;&#9;stored_cwnd = tp-&gt;snd_cwnd;  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;snd_cwnd = 2;  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;snd_ssthresh = icsk-&gt;icsk_ca_ops-&gt;ssthresh(sk);  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;snd_cwnd = stored_cwnd;  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;snd_ssthresh = icsk-&gt;icsk_ca_ops-&gt;ssthresh(sk); /* 减小阈值*/  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tcp_ca_event(sk, CA_EVENT_FRTO); /* 触发FRTO事件 */  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;tp-&gt;undo_marker = tp-&gt;snd_una;  
</span><span class='line'>&#9;tp-&gt;undo_retrans = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;skb = tcp_write_queue_head(sk);  
</span><span class='line'>&#9;if (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_RETRANS)  
</span><span class='line'>&#9;&#9;tp-&gt;undo_marker = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;/* 清除head与重传相关的标志*/  
</span><span class='line'>&#9;if (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_SACKED_RETRANS) {  
</span><span class='line'>&#9;&#9;TCP_SKB_CB(skb)-&gt;sacked &= ~TCPCB_SACKED_RETRANS;  
</span><span class='line'>&#9;&#9;tp-&gt;retrans_out -= tcp_skb_pcount(skb);  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;tcp_verfify_left_out(tp);  
</span><span class='line'>  
</span><span class='line'>&#9;/* Too bad if TCP was application limited */  
</span><span class='line'>&#9;tp-&gt;snd_cwnd = min(tp-&gt;snd_cwnd, tcp_packets_in_flight(tp) + 1);  
</span><span class='line'>  
</span><span class='line'>&#9;/* Earlier loss recovery underway */  
</span><span class='line'>&#9;if (tcp_is_sackfrto(tp) && (tp-&gt;frto_counter ||   
</span><span class='line'>&#9;&#9;((1 &lt;&lt; icsk-&gt;icsk_ca_state) & (TCPF_CA_Recovery | TCPF_CA_Loss))) &&  
</span><span class='line'>&#9;&#9;after(tp-&gt;high_seq, tp-&gt;snd_una)) {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tp-&gt;frto_highmark = tp-&gt;high_seq;  
</span><span class='line'>  
</span><span class='line'>&#9;} else {  
</span><span class='line'>&#9;&#9;tp-&gt;frto_highmark = tp-&gt;snd_nxt;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;tcp_set_ca_state (sk, TCP_CA_Disorder); /* 设置拥塞状态*/  
</span><span class='line'>&#9;tp-&gt;high_seq = tp-&gt;snd_nxt;  
</span><span class='line'>&#9;tp-&gt;frto_counter = 1; /* 表示刚进入F-RTO状态！*/  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>F-RTO算法处理</h4>

<p>F-RTO算法的处理过程主要发生在重传完超时数据包后。发送方在接收到ACK后，在处理ACK时会检查是否处于F-RTO处理阶段。如果是则会调用tcp_process_frto()进行F-RTO阶段的处理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int tcp_ack (struct sock *sk, const struct sk_buff *skb, int flag)  
</span><span class='line'>{  
</span><span class='line'>&#9;....  
</span><span class='line'>  
</span><span class='line'>&#9;if (tp-&gt;frto_counter )  
</span><span class='line'>&#9;&#9;frto_cwnd = tcp_process_frto(sk, flag);  
</span><span class='line'>  
</span><span class='line'>&#9;....  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>2.6.20的F-RTO</h4>

<p>tcp_process_frto()用于判断RTO是否为虚假的，主要依据为RTO后的两个ACK。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void tcp_process_frto (struct sock *sk, u32 prior_snd_una)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;tcp_sync_left_out(tp);  
</span><span class='line'>  
</span><span class='line'>&#9;/* RTO was caused by loss, start retransmitting in 
</span><span class='line'>&#9; * go-back-N slow start. 
</span><span class='line'>&#9; * 包括两种情况： 
</span><span class='line'>&#9;  * （1）此ACK为dupack 
</span><span class='line'>&#9; * （2）此ACK确认完整个窗口 
</span><span class='line'>&#9;  * 以上两种情况都表示有数据包丢失了，需要采用传统的方法。 
</span><span class='line'>&#9;  */  
</span><span class='line'>&#9;if (tp-&gt;snd_una == prior_snd_una ||   
</span><span class='line'>&#9;&#9;! before(tp-&gt;snd_una, tp-&gt;frto_highmark)) {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tcp_enter_frto_loss(sk);  
</span><span class='line'>&#9;&#9;return;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;/* First ACK after RTO advances the window: allow two new  
</span><span class='line'>&#9; * segments out. 
</span><span class='line'>&#9; * frto_counter = 1表示收到第一个有效的ACK，则重新设置 
</span><span class='line'>&#9; * 拥塞窗口，确保可以在F-RTO处理阶段在输出两个数据包， 
</span><span class='line'>&#9; * 因为此时还没进入Loss状态，所以可以发送新数据包。 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;if (tp-&gt;frto_counter == 1) {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tp-&gt;snd_cwnd = tcp_packets_in_flight(tp) + 2;  
</span><span class='line'>  
</span><span class='line'>&#9;} else {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* Also the second ACK after RTO advances the window. 
</span><span class='line'>&#9;&#9; * The RTO was likely spurious. Reduce cwnd and continue 
</span><span class='line'>&#9;&#9; * in congestion avoidance. 
</span><span class='line'>&#9;&#9; * 第二个ACK有效，则调整拥塞窗口，直接进入拥塞避免阶段， 
</span><span class='line'>&#9;&#9;  * 而不用重传数据包。 
</span><span class='line'>&#9;&#9;  * / 
</span><span class='line'>&#9;&#9;tp-&gt;snd_cwnd = min(tp-&gt;snd_cwnd, tp-&gt;snd_ssthresh); 
</span><span class='line'>&#9;&#9;tcp_moderate_cwnd(tp); 
</span><span class='line'>&#9;} 
</span><span class='line'> 
</span><span class='line'>&#9;/* F-RTO affects on two new ACKs following RTO. 
</span><span class='line'>&#9; * At latest on third ACK the TCP behavior is back to normal. 
</span><span class='line'>&#9; * 如果能连续收到两个确认了新数据的ACK，则说明RTO是虚假的，因此 
</span><span class='line'>&#9;  * 退出F-RTO。 
</span><span class='line'>&#9;  */  
</span><span class='line'>&#9;tp-&gt;frto_counter = (tp-&gt;frto_counter + 1) % 3;  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>如果确定RTO为虚假的，则调用tcp_enter_frto_loss()，进入RTO恢复阶段，开始慢启动。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* Enter Loss state after F-RTO was applied. Dupack arrived after RTO, which 
</span><span class='line'> * indicates that we should follow the traditional RTO recovery, i.e. mark  
</span><span class='line'> * erverything lost and do go-back-N retransmission. 
</span><span class='line'> */  
</span><span class='line'>static void tcp_enter_frto_loss (struct sock *sk)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;struct sk_buff *skb;  
</span><span class='line'>&#9;int cnt = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;/* 进入Loss状态后，清零SACK、lost、retrans_out等数据*/  
</span><span class='line'>&#9;tp-&gt;sacked_out = 0;  
</span><span class='line'>&#9;tp-&gt;lost_out = 0;  
</span><span class='line'>&#9;tp-&gt;fackets_out = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;/* 遍历重传队列，重新标志LOST。对于那些在RTO发生后传输 
</span><span class='line'>&#9; * 的数据不用标志为LOST。 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;sk_stream_for_retrans_queue(skb, sk) {  
</span><span class='line'>&#9;&#9;cnt += tcp_skb_pcount(skb);  
</span><span class='line'>&#9;&#9;TCP_SKB_CB(skb)-&gt;sacked &= ~TCPCB_LOST;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* 对于那些没被SACK的数据包，需要把它标志为LOST。*/  
</span><span class='line'>&#9;&#9;if (! (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_SACKED_ACKED)) {  
</span><span class='line'>&#9;&#9;&#9;/* Do not mark those segments lost that were forward 
</span><span class='line'>&#9;&#9;&#9; * transmitted after RTO. 
</span><span class='line'>&#9;&#9;&#9; */  
</span><span class='line'>&#9;&#9;&#9; if (! after(TCP_SKB_CB(skb)-&gt;end_seq, tp-&gt;frto_highmark))  
</span><span class='line'>&#9;&#9;&#9; {  
</span><span class='line'>&#9;&#9;&#9;&#9;TCP_SKB_CB(skb)-&gt;sacked |= TCP_LOST;  
</span><span class='line'>&#9;&#9;&#9;&#9;tp-&gt;lost_out += tcp_skb_pcount(skb);  
</span><span class='line'>&#9;&#9;&#9; }  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;} else { /* 对于那些已被sacked的数据包，则不用标志LOST。*/  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;sacked_out += tcp_skb_pcount(skb);  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;fackets_out = cnt;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;tcp_syn_left_out(tp);  
</span><span class='line'>  
</span><span class='line'>&#9;tp-&gt;snd_cwnd = tp-&gt;frto_counter + tcp_packets_in_flight(tp) + 1;  
</span><span class='line'>&#9;tp-&gt;snd_cwnd_cnt = 0;  
</span><span class='line'>&#9;tp-&gt;snd_cwnd_stamp = tcp_time_stamp;  
</span><span class='line'>&#9;tp-&gt;undo_marker = 0; /* 不需要undo标志*/  
</span><span class='line'>&#9;tp-&gt;frto_counter = 0; /* 表示F-RTO结束了*/  
</span><span class='line'>  
</span><span class='line'>&#9;/* 更新乱序队列的最大值*/  
</span><span class='line'>&#9;tp-&gt;reordering = min_t(unsigned int, tp-&gt;reordering, sysctl_tcp_reordering);  
</span><span class='line'>&#9;tcp_set_ca_state(sk, TCP_CA_Loss); /* 进入loss状态*/  
</span><span class='line'>&#9;tp-&gt;high_seq = tp-&gt;frto_highmark; /*RTO时的最大序列号*/  
</span><span class='line'>&#9;TCP_ECN_queue_cwr(tp); /* 设置显示拥塞标志*/  
</span><span class='line'>&#9;clear_all_retrans_hints(tp);  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>3.2.12的F-RTO</h4>

<p>F-RTO spurious RTO detection algorithm (RFC4138)<br/>
F-RTO affects during two new ACKs following RTO (well, almost, see inline
comments). State (ACK number) is kept in frto_counter. When ACK advances
window (but not to or beyond highest sequence sent before RTO) :<br/>
On First ACK, send two new segments out.<br/>
On second ACK, RTO was likely spurious. Do spurious response (response<br/>
  algorithm is not part of the F-RTO detection algorithm given in RFC4138 but<br/>
  can be selected separately).</p>

<p>Otherwise (basically on duplicate ACK), RTO was (likely) caused by a loss and
TCP falls back to conventional RTO recovery. F-RTO allows overriding of Nagle,
this is done using frto_counter states 2 and 3, when a new data segment of any
size sent during F-RTO, state 2 is upgraded to 3.</p>

<p>Rationale: if the RTO was suprious, new ACKs should arrive from the original
window even after we transmit two new data segments.</p>

<p>SACK version:<br/>
  on first step, wait until first cumulative ACK arrives, then move to the second
  step. In second step, the next ACK decides.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int tcp_process_frto(struct sock *sk, int flag)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;tcp_verify_left_out(tp);  
</span><span class='line'>   
</span><span class='line'>&#9;/* Duplicate the behavior from Loss state (fastretrans_alert) */  
</span><span class='line'>&#9;if (flag & FLAG_DATA_ACKED)  
</span><span class='line'>&#9;&#9;inet_csk(sk)-&gt;icsk_retransmits = 0; /*重传次数归零*/  
</span><span class='line'>   
</span><span class='line'>&#9;if ((flag & FLAG_NONHEAD_RETRANS_ACKED) ||  
</span><span class='line'>&#9;&#9;((tp-&gt;frto_counter &gt;= 2) && (flag & FLAG_RETRANS_DATA_ACKED)))  
</span><span class='line'>&#9;&#9;tp-&gt;undo_marker = 0;  
</span><span class='line'>   
</span><span class='line'>&#9;/* 一个ACK确认完RTO时整个窗口，表示出现了丢包*/  
</span><span class='line'>&#9;if (! before(tp-&gt;snd_una, tp-&gt;frto_highmark)) {  
</span><span class='line'>&#9;&#9;tcp_enter_frto_loss(sk, (tp-&gt;frto_counter == 1 ? 2 : 3), flag) ;  
</span><span class='line'>&#9;&#9;return 1;  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;/* Reno的处理方式 */  
</span><span class='line'>&#9;if (! tcp_is_sackfrto(tp)) {   
</span><span class='line'>&#9;&#9;/* RFC4138 shortcoming in step2; should also have case c): 
</span><span class='line'>&#9;&#9; * ACK isn't duplicate nor advances window, e.g., opposite dir 
</span><span class='line'>&#9;&#9; * data, winupdate 
</span><span class='line'>&#9;&#9; */  
</span><span class='line'>&#9;&#9;if (! (flag & FLAG_ANY_PROGRESS) && (flag & FLAG_NOT_DUP))  
</span><span class='line'>&#9;&#9;&#9;return 1; /*不采取任何措施，忽略*/  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (! (flag & FLAG_DATA_ACKED)) { /* 没有确认新的数据*/  
</span><span class='line'>&#9;&#9;&#9;tcp_enter_frto_loss(sk, (tp-&gt;frto_counter == 1 ? 0 : 3), flag);  
</span><span class='line'>&#9;&#9;&#9;return 1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;} else { /* SACK的处理方式 */  
</span><span class='line'>&#9;&#9;/* Prevent sender of new data. 表示第一个ACK没有确认新数据， 
</span><span class='line'>&#9;&#9; * 这个时候不允许发送新的数据，直接返回。 
</span><span class='line'>&#9;&#9; */  
</span><span class='line'>&#9;&#9;if (! (flag & FLAG_DATA_ACKED) & (tp-&gt;frto_conter == 1) {  
</span><span class='line'>&#9;&#9;&#9;tp-&gt;snd_cwnd = min(tp-&gt;snd_cwnd, tcp_packets_in_flight(tp));  
</span><span class='line'>&#9;&#9;&#9;return 1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* 当第二个ACK也没有确认新的数据时，判定RTO真实，退出F-RTO。*/  
</span><span class='line'>&#9;&#9;if ( (tp-&gt;frto_counter &gt;= 2) &&   
</span><span class='line'>&#9;&#9;&#9;(! (flag & FLAG_FORWARD_PROGRESS) ||  
</span><span class='line'>&#9;&#9;&#9;((flag & FLAG_DATA_SACKED) && ! (flag & FLAG_ONLY_ORIG_SACKED))) {  
</span><span class='line'>&#9;&#9;&#9;/* RFC4138 shortcoming (see comment above) */  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;if (! (flag & FLAG_FORWARD_PROGRESS) &&   
</span><span class='line'>&#9;&#9;&#9;&#9;(flag & FLAG_NOT_DUP);  
</span><span class='line'>&#9;&#9;&#9;&#9;return 1;  
</span><span class='line'>   
</span><span class='line'>&#9;&#9;&#9;tcp_enter_frto_loss(sk, 3, flag);  
</span><span class='line'>&#9;&#9;&#9;return 1;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;if (tp-&gt;frto_counter == 1) {  
</span><span class='line'>&#9;&#9;/* tcp_may_send_now needs to see updated state */  
</span><span class='line'>&#9;&#9;tp-&gt;snd_cwnd = tcp_packets_in_flight(tp) + 2;  
</span><span class='line'>&#9;&#9;tp-&gt;frto_counter = 2;  
</span><span class='line'>&#9;&#9;  
</span><span class='line'>&#9;&#9;if (! tcp_may_send_now(sk))  
</span><span class='line'>&#9;&#9;&#9;tcp_enter_frto_loss(sk, 2, flag);  
</span><span class='line'>&#9;&#9;return 1;  
</span><span class='line'>  
</span><span class='line'>&#9;} else {  
</span><span class='line'>&#9;&#9;switch (sysctl_tcp_frto_response) {  
</span><span class='line'>&#9;&#9;case 2: /* 比较激进的，恢复到RTO前的窗口和阈值*/  
</span><span class='line'>&#9;&#9;&#9;tcp_undo_spur_to_response(sk, flag);  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;case 1: /* 非常保守，阈值减小B，可窗口一再减小，为B/2 */  
</span><span class='line'>&#9;&#9;&#9;tcp_conservative_spur_to_response(sk);  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;default:  
</span><span class='line'>&#9;&#9;&#9;/* 保守*/  
</span><span class='line'>&#9;&#9;&#9;tcp_ratehalving_spur_to_response(sk);  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;tp-&gt;frto_counter = 0; /*F-RTO算法结束标志*/  
</span><span class='line'>&#9;&#9;tp-&gt;undo_marker = 0; /*清零undo标志*/  
</span><span class='line'>&#9;&#9;NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_TCPSPURIOUSRTOS);  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;return 0;   
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>#define FLAG_DATA_ACKED 0x04 /* This ACK acknowledged new data. */  
</span><span class='line'>#define FLAG_NONHEAD_RETRANS_ACKED 0x1000 /* Non-head rexmit data was ACKed. */  
</span><span class='line'>#define FLAG_RETRANS_DATA_ACKED 0x08 /* some of which was retransmitted.*/  
</span><span class='line'>  
</span><span class='line'>#define FLAG_ACKED (FLAG_DATA_ACKED | FLAG_SYN_ACKED)  
</span><span class='line'>#define FLAG_FORWARD_PROGRESS (FLAG_ACKED | FLAG_DATA_SACKED)  
</span><span class='line'>#define FLAG_ANY_PROGRESS (FLAG_RORWARD_PROGRESS | FLAG_SND_UNA_ADVANCED)  
</span><span class='line'>   
</span><span class='line'>#define FLAG_NOT_DUP (FLAG_DATA | FLAG_WIN_UPDATE | FLAG_ACKED)</span></code></pre></td></tr></table></div></figure>


<h4>tcp_frto_response选项</h4>

<p>tcp_frto_response表示TCP在检测到虚假的RTO后，采用什么函数来进行阈值和拥塞窗口的调整，它有三种取值：</p>

<h5>（1）值为2</h5>

<p>表示使用tcp_undo_spur_to_response()，这是一种比较激进的处理方法，它把阈值和拥塞窗口都恢复到RTO前的值。</p>

<h5>（2）值为1</h5>

<p>表示使用tcp_conservative_spur_to_response()，这是一种很保守的处理方法。<br/>
假设减小因子为B，RTO前的窗口为C，那么一般情况下（因为阈值调整算法不同）<br/>
此后ssthresh=（1 - B）C，cwnd = （1 -B ）（1- B）C</p>

<h5>（3）值为0或其它（默认为0）</h5>

<p>表示使用默认的tcp_ratehalving_spur_to_response()，也是一种保守的处理方法。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void tcp_undo_spur_to_response (struct sock *sk, int flag)  
</span><span class='line'>{  
</span><span class='line'>&#9;/* 如果有显示拥塞标志，则进入CWR状态，最终阈值不变，窗口减半*/  
</span><span class='line'>&#9;if (flag & FLAG_ECE)  
</span><span class='line'>&#9;&#9;tcp_ratehalving_spur_to_response(sk);  
</span><span class='line'>&#9;else  
</span><span class='line'>&#9;/* 撤销阈值调整，撤销窗口调整，恢复RTO前的状态*/  
</span><span class='line'>&#9;&#9;tcp_undo_cwr(sk, true);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>/* A conservative spurious RTO response algorithm: reduce cwnd 
</span><span class='line'> * using rate halving and continue in congestion_avoidance. 
</span><span class='line'> */  
</span><span class='line'>static void tcp_ratehalving_spur_to_response(struct sock *sk)  
</span><span class='line'>{  
</span><span class='line'>&#9;tcp_enter_cwr(sk, 0);  
</span><span class='line'>}  
</span><span class='line'>  
</span><span class='line'>/* A very conservative spurious RTO response algorithm: reduce cwnd 
</span><span class='line'> * and continue in congestion avoidance. 
</span><span class='line'> */  
</span><span class='line'>static void tcp_conservative_spur_to_response(struct tcp_sock *tp)  
</span><span class='line'>{  
</span><span class='line'>&#9;tp-&gt;snd_cwnd = min(tp-&gt;snd_cwnd, tp-&gt;snd_ssthresh);  
</span><span class='line'>&#9;tp-&gt;snd_cwnd_cnt = 0;  
</span><span class='line'>&#9;tp-&gt;bytes_acked = 0;  
</span><span class='line'>&#9;/* 竟然又设置了显示拥塞标志，那窗口就还要减小到阈值的（1-B）！ 
</span><span class='line'>&#9; * 果然是非常保守。 
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;TCP_ECN_queue_cwr(tp);   
</span><span class='line'>&#9;tcp_moderate_cwnd(tp);  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>如果判断RTO是真实的，就调用tcp_enter_frto_loss()来处理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* Enter Loss state after F-RTO was applied. Dupack arrived after RTO, 
</span><span class='line'> * which indicates that we should follow the tradditional RTO recovery, 
</span><span class='line'> * i.e. mark everything lost and do go-back-N retransmission. 
</span><span class='line'> */  
</span><span class='line'>static void tcp_enter_frto_loss(struct sock *sk, int allowed_segments, int flag)  
</span><span class='line'>{  
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);  
</span><span class='line'>&#9;struct sk_buff *skb;  
</span><span class='line'>  
</span><span class='line'>&#9;tp-&gt;lost_out = 0;  
</span><span class='line'>&#9;tp-&gt;retrans_out = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;if (tcp_is_reno(tp))  
</span><span class='line'>&#9;&#9;tcp_reset_reno_sack(tp);  
</span><span class='line'>  
</span><span class='line'>&#9;tcp_for_write_queue(skb, sk) {  
</span><span class='line'>&#9;&#9;if (skb == tcp_send_head(sk))  
</span><span class='line'>&#9;&#9;&#9;break;  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;TCP_SKB_CB(skb)-&gt;sacked &= ~TCPCB_LOST;  
</span><span class='line'>&#9;&#9;/*  
</span><span class='line'>&#9;&#9; * Count the retransmission made on RTO correctly (only when waiting for 
</span><span class='line'>&#9;&#9; * the first ACK and did not get it. 
</span><span class='line'>&#9;&#9; */  
</span><span class='line'>&#9;&#9;if ((tp-&gt;frto_counter == 1) && !(flag & FLAG_DATA_ACKED)) {  
</span><span class='line'>&#9;&#9;&#9;/* For some reason this R-bit might get cleared ? */  
</span><span class='line'>&#9;&#9;&#9;if (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_SACKED_RETRANS)  
</span><span class='line'>&#9;&#9;&#9;&#9;tp-&gt;retrans_out += tcp_skb_pcount(skb);  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;/* enter this if branch just for the first segment */  
</span><span class='line'>&#9;&#9;&#9;flag |= FLAG_DATA_ACKED;  
</span><span class='line'>&#9;&#9;} else {  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;if (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_RETRANS)  
</span><span class='line'>&#9;&#9;&#9;&#9;tp-&gt;undo_marker = 0;  
</span><span class='line'>&#9;&#9;&#9;TCP_SKB_CB(skb)-&gt;sacked &= ~TCPCB_SACKED_RETRANS;  
</span><span class='line'>&#9;&#9;}  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* Marking forward transmissions that were made after RTO lost can 
</span><span class='line'>&#9;&#9;* cause unnecessary retransmissions in some scenarios, 
</span><span class='line'>&#9;&#9;* SACK blocks will mitigate that in some but not in all cases. 
</span><span class='line'>&#9;&#9;* We used to not mark them but it was casuing break-ups with 
</span><span class='line'>&#9;&#9;* receivers that do only in-order receival. 
</span><span class='line'>&#9;&#9;*  
</span><span class='line'>&#9;&#9;* TODO: we could detect presence of such receiver and select different 
</span><span class='line'>&#9;&#9;* behavior per flow. 
</span><span class='line'>&#9;&#9;*/  
</span><span class='line'>&#9;   if (! (TCP_SKB_CB(skb)-&gt;sacked & TCPCB_SACKED_ACKED)) {  
</span><span class='line'>&#9;&#9;  TCP_SKB_CB(skb)-&gt;sacked |= TCPCB_LOST;  
</span><span class='line'>&#9;&#9;   tp-&gt;lost_out += tcp_skb_pcount(skb);  
</span><span class='line'>&#9;&#9;   tp-&gt;retransmit_high = TCP_SKB_CB(skb)-&gt;end_seq;  
</span><span class='line'>&#9;   }  
</span><span class='line'>&#9;}  
</span><span class='line'>&#9;tcp_verify_left_out(tp);  
</span><span class='line'>  
</span><span class='line'>&#9;/* allowed_segments应该不大于3*/  
</span><span class='line'>&#9;tp-&gt;snd_cwnd = tcp_packets_in_flight(tp) + allowed_segments;  
</span><span class='line'>&#9;tp-&gt;snd_cwnd_cnt = 0;  
</span><span class='line'>&#9;tp-&gt;snd_cwnd_stamp = tcp_time_stamp;  
</span><span class='line'>&#9;tp-&gt;frto_counter = 0; /* F-RTO结束了*/  
</span><span class='line'>&#9;tp-&gt;bytes_acked = 0;  
</span><span class='line'>  
</span><span class='line'>&#9;/* 更新乱序队列的最大长度*/  
</span><span class='line'>&#9;tp-&gt;reordering = min_t(unsigned int, tp-&gt;reordering,  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;sysctl_tcp_reordering);  
</span><span class='line'>  
</span><span class='line'>&#9;tcp_set_ca_state(sk, TCP_CA_Loss); /*设置成Loss状态*/  
</span><span class='line'>&#9;tp-&gt;high_seq = tp-&gt;snd_nxt;  
</span><span class='line'>&#9;TCP_ECN_queue_cwr(tp); /*设置显式拥塞标志*/  
</span><span class='line'>&#9;tcp_clear_all_retrans_hints(tp);  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>总结</h4>

<p>现在内核（3.2.12）是默认使用F-RTO算法的。<br/>
其中tcp_frto默认为2，tcp_frto_response默认为0。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/225">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/223">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories
<span class='right_span'>(969)</span>

</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/medicine/'>medicine</a><a href='##' onmousedown=showDiv('medicine') id='aexp_medicine'><span class='exp_style' id='exp_medicine'>[+]</span></a><span class='right_span'>(4)</span></li>
<div id='medicine' class='catsub'><li><a href='/blog/cats/medicine~mimic/?opendiv=medicine'>mimic</a><a href='##' onmousedown=showDiv('medicine~mimic') id='aexp_medicine~mimic'><span class='exp_style' id='exp_medicine~mimic'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('medicine')) document.getElementById('aexp_medicine').style.visibility = 'hidden';
if (!document.getElementById('medicine~mimic')) document.getElementById('aexp_medicine~mimic').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(13)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(168)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>33</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~excel/?opendiv=language'>excel</a><a href='##' onmousedown=showDiv('language~excel') id='aexp_language~excel'><span class='exp_style' id='exp_language~excel'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~excel')) document.getElementById('aexp_language~excel').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~jsp/?opendiv=language'>jsp</a><a href='##' onmousedown=showDiv('language~jsp') id='aexp_language~jsp'><span class='exp_style' id='exp_language~jsp'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~jsp')) document.getElementById('aexp_language~jsp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~php/?opendiv=language'>php</a><a href='##' onmousedown=showDiv('language~php') id='aexp_language~php'><span class='exp_style' id='exp_language~php'>[+]</span></a><span class='right_span'>53</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~php')) document.getElementById('aexp_language~php').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~python/?opendiv=language'>python</a><a href='##' onmousedown=showDiv('language~python') id='aexp_language~python'><span class='exp_style' id='exp_language~python'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~python')) document.getElementById('aexp_language~python').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>61</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(16)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~win/?opendiv=assembly'>win</a><a href='##' onmousedown=showDiv('assembly~win') id='aexp_assembly~win'><span class='exp_style' id='exp_assembly~win'>[+]</span></a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~win')) document.getElementById('aexp_assembly~win').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(200)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~apache2/?opendiv=tools'>apache2</a><a href='##' onmousedown=showDiv('tools~apache2') id='aexp_tools~apache2'><span class='exp_style' id='exp_tools~apache2'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~apache2')) document.getElementById('aexp_tools~apache2').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~cloud/?opendiv=tools'>cloud</a><a href='##' onmousedown=showDiv('tools~cloud') id='aexp_tools~cloud'><span class='exp_style' id='exp_tools~cloud'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~cloud')) document.getElementById('aexp_tools~cloud').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>31</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~dns/?opendiv=tools'>dns</a><a href='##' onmousedown=showDiv('tools~dns') id='aexp_tools~dns'><span class='exp_style' id='exp_tools~dns'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~dns')) document.getElementById('aexp_tools~dns').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~graphviz,-codeviz/?opendiv=tools'>graphviz、codeviz</a><a href='##' onmousedown=showDiv('tools~graphviz、codeviz') id='aexp_tools~graphviz、codeviz'><span class='exp_style' id='exp_tools~graphviz、codeviz'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~graphviz、codeviz')) document.getElementById('aexp_tools~graphviz、codeviz').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~isal/?opendiv=tools'>isal</a><a href='##' onmousedown=showDiv('tools~isal') id='aexp_tools~isal'><span class='exp_style' id='exp_tools~isal'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~isal')) document.getElementById('aexp_tools~isal').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>31</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~nginx/?opendiv=tools'>nginx</a><a href='##' onmousedown=showDiv('tools~nginx') id='aexp_tools~nginx'><span class='exp_style' id='exp_tools~nginx'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~nginx')) document.getElementById('aexp_tools~nginx').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~obs/?opendiv=tools'>obs</a><a href='##' onmousedown=showDiv('tools~obs') id='aexp_tools~obs'><span class='exp_style' id='exp_tools~obs'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~obs')) document.getElementById('aexp_tools~obs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~openvpn/?opendiv=tools'>openvpn</a><a href='##' onmousedown=showDiv('tools~openvpn') id='aexp_tools~openvpn'><span class='exp_style' id='exp_tools~openvpn'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~openvpn')) document.getElementById('aexp_tools~openvpn').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~oracle/?opendiv=tools'>oracle</a><a href='##' onmousedown=showDiv('tools~oracle') id='aexp_tools~oracle'><span class='exp_style' id='exp_tools~oracle'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~oracle')) document.getElementById('aexp_tools~oracle').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~picture/?opendiv=tools'>picture</a><a href='##' onmousedown=showDiv('tools~picture') id='aexp_tools~picture'><span class='exp_style' id='exp_tools~picture'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~picture')) document.getElementById('aexp_tools~picture').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~redis/?opendiv=tools'>redis</a><a href='##' onmousedown=showDiv('tools~redis') id='aexp_tools~redis'><span class='exp_style' id='exp_tools~redis'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~redis')) document.getElementById('aexp_tools~redis').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~smb/?opendiv=tools'>smb</a><a href='##' onmousedown=showDiv('tools~smb') id='aexp_tools~smb'><span class='exp_style' id='exp_tools~smb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~smb')) document.getElementById('aexp_tools~smb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~socksvpn/?opendiv=tools'>socksvpn</a><a href='##' onmousedown=showDiv('tools~socksvpn') id='aexp_tools~socksvpn'><span class='exp_style' id='exp_tools~socksvpn'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~socksvpn')) document.getElementById('aexp_tools~socksvpn').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~sqlmap/?opendiv=tools'>sqlmap</a><a href='##' onmousedown=showDiv('tools~sqlmap') id='aexp_tools~sqlmap'><span class='exp_style' id='exp_tools~sqlmap'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~sqlmap')) document.getElementById('aexp_tools~sqlmap').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~sqlserver/?opendiv=tools'>sqlserver</a><a href='##' onmousedown=showDiv('tools~sqlserver') id='aexp_tools~sqlserver'><span class='exp_style' id='exp_tools~sqlserver'>[+]</span></a><span class='right_span'>12</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~sqlserver')) document.getElementById('aexp_tools~sqlserver').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~squid/?opendiv=tools'>squid</a><a href='##' onmousedown=showDiv('tools~squid') id='aexp_tools~squid'><span class='exp_style' id='exp_tools~squid'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~squid')) document.getElementById('aexp_tools~squid').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssl/?opendiv=tools'>ssl</a><a href='##' onmousedown=showDiv('tools~ssl') id='aexp_tools~ssl'><span class='exp_style' id='exp_tools~ssl'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ssl')) document.getElementById('aexp_tools~ssl').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~vim/?opendiv=tools'>vim</a><a href='##' onmousedown=showDiv('tools~vim') id='aexp_tools~vim'><span class='exp_style' id='exp_tools~vim'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~vim')) document.getElementById('aexp_tools~vim').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~wxwork/?opendiv=tools'>wxwork</a><a href='##' onmousedown=showDiv('tools~wxwork') id='aexp_tools~wxwork'><span class='exp_style' id='exp_tools~wxwork'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~wxwork')) document.getElementById('aexp_tools~wxwork').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(126)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>36</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~docker/?opendiv=system'>docker</a><a href='##' onmousedown=showDiv('system~docker') id='aexp_system~docker'><span class='exp_style' id='exp_system~docker'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~docker')) document.getElementById('aexp_system~docker').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~fs/?opendiv=system'>fs</a><a href='##' onmousedown=showDiv('system~fs') id='aexp_system~fs'><span class='exp_style' id='exp_system~fs'>[+]</span></a><span class='right_span'>12</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~fs')) document.getElementById('aexp_system~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~grub/?opendiv=system'>grub</a><a href='##' onmousedown=showDiv('system~grub') id='aexp_system~grub'><span class='exp_style' id='exp_system~grub'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~grub')) document.getElementById('aexp_system~grub').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~hik/?opendiv=system'>hik</a><a href='##' onmousedown=showDiv('system~hik') id='aexp_system~hik'><span class='exp_style' id='exp_system~hik'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~hik')) document.getElementById('aexp_system~hik').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~influx/?opendiv=system'>influx</a><a href='##' onmousedown=showDiv('system~influx') id='aexp_system~influx'><span class='exp_style' id='exp_system~influx'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~influx')) document.getElementById('aexp_system~influx').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~mail/?opendiv=system'>mail</a><a href='##' onmousedown=showDiv('system~mail') id='aexp_system~mail'><span class='exp_style' id='exp_system~mail'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~mail')) document.getElementById('aexp_system~mail').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~rpmbuild/?opendiv=system'>rpmbuild</a><a href='##' onmousedown=showDiv('system~rpmbuild') id='aexp_system~rpmbuild'><span class='exp_style' id='exp_system~rpmbuild'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~rpmbuild')) document.getElementById('aexp_system~rpmbuild').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>18</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(274)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~10gb/?opendiv=kernel'>10gb</a><a href='##' onmousedown=showDiv('kernel~10gb') id='aexp_kernel~10gb'><span class='exp_style' id='exp_kernel~10gb'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~10gb')) document.getElementById('aexp_kernel~10gb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~bonding/?opendiv=kernel'>bonding</a><a href='##' onmousedown=showDiv('kernel~bonding') id='aexp_kernel~bonding'><span class='exp_style' id='exp_kernel~bonding'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~bonding')) document.getElementById('aexp_kernel~bonding').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~clock/?opendiv=kernel'>clock</a><a href='##' onmousedown=showDiv('kernel~clock') id='aexp_kernel~clock'><span class='exp_style' id='exp_kernel~clock'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~clock')) document.getElementById('aexp_kernel~clock').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~crypto/?opendiv=kernel'>crypto</a><a href='##' onmousedown=showDiv('kernel~crypto') id='aexp_kernel~crypto'><span class='exp_style' id='exp_kernel~crypto'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~crypto')) document.getElementById('aexp_kernel~crypto').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fpu/?opendiv=kernel'>fpu</a><a href='##' onmousedown=showDiv('kernel~fpu') id='aexp_kernel~fpu'><span class='exp_style' id='exp_kernel~fpu'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fpu')) document.getElementById('aexp_kernel~fpu').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fs/?opendiv=kernel'>fs</a><a href='##' onmousedown=showDiv('kernel~fs') id='aexp_kernel~fs'><span class='exp_style' id='exp_kernel~fs'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fs')) document.getElementById('aexp_kernel~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~ipsec/?opendiv=kernel'>ipsec</a><a href='##' onmousedown=showDiv('kernel~ipsec') id='aexp_kernel~ipsec'><span class='exp_style' id='exp_kernel~ipsec'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~ipsec')) document.getElementById('aexp_kernel~ipsec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>34</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mptcp/?opendiv=kernel'>mptcp</a><a href='##' onmousedown=showDiv('kernel~mptcp') id='aexp_kernel~mptcp'><span class='exp_style' id='exp_kernel~mptcp'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mptcp')) document.getElementById('aexp_kernel~mptcp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>113</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~proc/?opendiv=kernel'>proc</a><a href='##' onmousedown=showDiv('kernel~proc') id='aexp_kernel~proc'><span class='exp_style' id='exp_kernel~proc'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~proc')) document.getElementById('aexp_kernel~proc').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>20</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~signature/?opendiv=kernel'>signature</a><a href='##' onmousedown=showDiv('kernel~signature') id='aexp_kernel~signature'><span class='exp_style' id='exp_kernel~signature'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~signature')) document.getElementById('aexp_kernel~signature').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sound/?opendiv=kernel'>sound</a><a href='##' onmousedown=showDiv('kernel~sound') id='aexp_kernel~sound'><span class='exp_style' id='exp_kernel~sound'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~sound')) document.getElementById('aexp_kernel~sound').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~tcp/?opendiv=kernel'>tcp</a><a href='##' onmousedown=showDiv('kernel~tcp') id='aexp_kernel~tcp'><span class='exp_style' id='exp_kernel~tcp'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~tcp')) document.getElementById('aexp_kernel~tcp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~vpn/?opendiv=kernel'>vpn</a><a href='##' onmousedown=showDiv('kernel~vpn') id='aexp_kernel~vpn'><span class='exp_style' id='exp_kernel~vpn'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~vpn')) document.getElementById('aexp_kernel~vpn').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/network/'>network</a><a href='##' onmousedown=showDiv('network') id='aexp_network'><span class='exp_style' id='exp_network'>[+]</span></a><span class='right_span'>(9)</span></li>
<div id='network' class='catsub'><li><a href='/blog/cats/network~base/?opendiv=network'>base</a><a href='##' onmousedown=showDiv('network~base') id='aexp_network~base'><span class='exp_style' id='exp_network~base'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('network')) document.getElementById('aexp_network').style.visibility = 'hidden';
if (!document.getElementById('network~base')) document.getElementById('aexp_network~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(84)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~http/?opendiv=debug'>http</a><a href='##' onmousedown=showDiv('debug~http') id='aexp_debug~http'><span class='exp_style' id='exp_debug~http'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~http')) document.getElementById('aexp_debug~http').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~ksplice/?opendiv=debug'>ksplice</a><a href='##' onmousedown=showDiv('debug~ksplice') id='aexp_debug~ksplice'><span class='exp_style' id='exp_debug~ksplice'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~ksplice')) document.getElementById('aexp_debug~ksplice').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(28)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>15</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~g9300/?opendiv=android'>g9300</a><a href='##' onmousedown=showDiv('android~g9300') id='aexp_android~g9300'><span class='exp_style' id='exp_android~g9300'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~g9300')) document.getElementById('aexp_android~g9300').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(33)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>24</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~game/?opendiv=algorithm'>game</a><a href='##' onmousedown=showDiv('algorithm~game') id='aexp_algorithm~game'><span class='exp_style' id='exp_algorithm~game'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~game')) document.getElementById('aexp_algorithm~game').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/lernel~ipsec/?opendiv=algorithm'>ipsec</a><a href='##' onmousedown=showDiv('algorithm~ipsec') id='aexp_algorithm~ipsec'><span class='exp_style' id='exp_algorithm~ipsec'>[+]</span></a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~ipsec')) document.getElementById('aexp_algorithm~ipsec').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories
<span class='right_span'>(969)</span>

</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2024/'>2024</a><a href='##' onmousedown=showDiv('2024')><span class='exp_style' id='exp_2024'>[+]</span></a><span class='right_span'>(89)</span></li>
<div id='2024' class='catsub'><li><a href='/blog/cats/2024~12/?opendiv=2024'>2024-12</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2024~10/?opendiv=2024'>2024-10</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~09/?opendiv=2024'>2024-09</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2024~08/?opendiv=2024'>2024-08</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2024~07/?opendiv=2024'>2024-07</a><span class='right_span'>26</span></li>
<li><a href='/blog/cats/2024~06/?opendiv=2024'>2024-06</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2024~05/?opendiv=2024'>2024-05</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~04/?opendiv=2024'>2024-04</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~03/?opendiv=2024'>2024-03</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2024~02/?opendiv=2024'>2024-02</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2024~01/?opendiv=2024'>2024-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2023/'>2023</a><a href='##' onmousedown=showDiv('2023')><span class='exp_style' id='exp_2023'>[+]</span></a><span class='right_span'>(87)</span></li>
<div id='2023' class='catsub'><li><a href='/blog/cats/2023~12/?opendiv=2023'>2023-12</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2023~11/?opendiv=2023'>2023-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2023~10/?opendiv=2023'>2023-10</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2023~09/?opendiv=2023'>2023-09</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2023~08/?opendiv=2023'>2023-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2023~07/?opendiv=2023'>2023-07</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2023~06/?opendiv=2023'>2023-06</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2023~05/?opendiv=2023'>2023-05</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2023~04/?opendiv=2023'>2023-04</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2023~03/?opendiv=2023'>2023-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2023~02/?opendiv=2023'>2023-02</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2023~01/?opendiv=2023'>2023-01</a><span class='right_span'>18</span></li>
</div><li class='catclass'><a href='/blog/cats/2022/'>2022</a><a href='##' onmousedown=showDiv('2022')><span class='exp_style' id='exp_2022'>[+]</span></a><span class='right_span'>(83)</span></li>
<div id='2022' class='catsub'><li><a href='/blog/cats/2022~12/?opendiv=2022'>2022-12</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2022~11/?opendiv=2022'>2022-11</a><span class='right_span'>16</span></li>
<li><a href='/blog/cats/2022~10/?opendiv=2022'>2022-10</a><span class='right_span'>17</span></li>
<li><a href='/blog/cats/2022~09/?opendiv=2022'>2022-09</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2022~08/?opendiv=2022'>2022-08</a><span class='right_span'>29</span></li>
<li><a href='/blog/cats/2022~07/?opendiv=2022'>2022-07</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2021/'>2021</a><a href='##' onmousedown=showDiv('2021')><span class='exp_style' id='exp_2021'>[+]</span></a><span class='right_span'>(73)</span></li>
<div id='2021' class='catsub'><li><a href='/blog/cats/2021~07/?opendiv=2021'>2021-07</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2021~06/?opendiv=2021'>2021-06</a><span class='right_span'>34</span></li>
<li><a href='/blog/cats/2021~05/?opendiv=2021'>2021-05</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2021~04/?opendiv=2021'>2021-04</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2021~03/?opendiv=2021'>2021-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2021~01/?opendiv=2021'>2021-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2020/'>2020</a><a href='##' onmousedown=showDiv('2020')><span class='exp_style' id='exp_2020'>[+]</span></a><span class='right_span'>(70)</span></li>
<div id='2020' class='catsub'><li><a href='/blog/cats/2020~12/?opendiv=2020'>2020-12</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2020~11/?opendiv=2020'>2020-11</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2020~10/?opendiv=2020'>2020-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2020~09/?opendiv=2020'>2020-09</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2020~08/?opendiv=2020'>2020-08</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2020~07/?opendiv=2020'>2020-07</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2020~05/?opendiv=2020'>2020-05</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2020~01/?opendiv=2020'>2020-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2019/'>2019</a><a href='##' onmousedown=showDiv('2019')><span class='exp_style' id='exp_2019'>[+]</span></a><span class='right_span'>(22)</span></li>
<div id='2019' class='catsub'><li><a href='/blog/cats/2019~12/?opendiv=2019'>2019-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2019~10/?opendiv=2019'>2019-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2019~08/?opendiv=2019'>2019-08</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2019~06/?opendiv=2019'>2019-06</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2019~01/?opendiv=2019'>2019-01</a><span class='right_span'>3</span></li>
</div><li class='catclass'><a href='/blog/cats/2018/'>2018</a><a href='##' onmousedown=showDiv('2018')><span class='exp_style' id='exp_2018'>[+]</span></a><span class='right_span'>(56)</span></li>
<div id='2018' class='catsub'><li><a href='/blog/cats/2018~12/?opendiv=2018'>2018-12</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2018~11/?opendiv=2018'>2018-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2018~10/?opendiv=2018'>2018-10</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~09/?opendiv=2018'>2018-09</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~08/?opendiv=2018'>2018-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2018~07/?opendiv=2018'>2018-07</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2018~06/?opendiv=2018'>2018-06</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2018~04/?opendiv=2018'>2018-04</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2018~03/?opendiv=2018'>2018-03</a><span class='right_span'>10</span></li>
<li><a href='/blog/cats/2018~02/?opendiv=2018'>2018-02</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2018~01/?opendiv=2018'>2018-01</a><span class='right_span'>9</span></li>
</div><li class='catclass'><a href='/blog/cats/2017/'>2017</a><a href='##' onmousedown=showDiv('2017')><span class='exp_style' id='exp_2017'>[+]</span></a><span class='right_span'>(10)</span></li>
<div id='2017' class='catsub'><li><a href='/blog/cats/2017~12/?opendiv=2017'>2017-12</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2017~07/?opendiv=2017'>2017-07</a><span class='right_span'>8</span></li>
</div><li class='catclass'><a href='/blog/cats/2016/'>2016</a><a href='##' onmousedown=showDiv('2016')><span class='exp_style' id='exp_2016'>[+]</span></a><span class='right_span'>(21)</span></li>
<div id='2016' class='catsub'><li><a href='/blog/cats/2016~08/?opendiv=2016'>2016-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~05/?opendiv=2016'>2016-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2016~03/?opendiv=2016'>2016-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2016~02/?opendiv=2016'>2016-02</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~01/?opendiv=2016'>2016-01</a><span class='right_span'>6</span></li>
</div><li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(207)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~12/?opendiv=2015'>2015-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2015~11/?opendiv=2015'>2015-11</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2015~10/?opendiv=2015'>2015-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 124%" href="/tags/10gb/">10gb(7)</a>
<a style="font-size: 119%" href="/tags/lvm/">LVM(6)</a>
<a style="font-size: 100%" href="/tags/chrome-debug/">chrome_debug(3)</a>
<a style="font-size: 131%" href="/tags/gdb/">gdb(9)</a>
<a style="font-size: 127%" href="/tags/git/">git(8)</a>
<a style="font-size: 114%" href="/tags/ipv6/">ipv6(5)</a>
<a style="font-size: 124%" href="/tags/ixgbe/">ixgbe(7)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 100%" href="/tags/lvs/">lvs(3)</a>
<a style="font-size: 131%" href="/tags/mptcp/">mptcp(9)</a>
<a style="font-size: 119%" href="/tags/nginx/">nginx(6)</a>
<a style="font-size: 114%" href="/tags/squid/">squid(5)</a>
<a style="font-size: 131%" href="/tags/vpn/">vpn(9)</a>
<a style="font-size: 108%" href="/tags/shu-ju-cai-ji/">数据采集(4)</a>
<a style="font-size: 141%" href="/tags/hui-bian/">汇编(13)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2024/12/12/tools-mysql-bin/">删除MySQL下的bin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/12/12/network-sfp/">光模块配置</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/10/27/network-ap-ac/">无线AP与AC详解</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/10/27/network-arp-mac/">为什么二层交换机上没有arp表项</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/10/27/network-hybrid/">Hybrid端口模式详解</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/10/27/network-telnet-proto/">telnet 协议详解</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/10/27/network-php-telnet/">交换机php telnet</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/09/26/network-telnet/">交换机开启telnet</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/09/20/ffmpeg-mp3/">ffmpeg分离MP3文件报错</a>
      </li>
    
      <li class="post">
        <a href="/blog/2024/09/20/sqlserver-_/">`_` 通配符 -- 匹配一个字符</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href='https://blog.csdn.net/abcdxyzk2?type=blog' target=_blank>CSDN博客</a>
	</li>
	<li>
		<a href='https://www.cnblogs.com/abcdxyzk' target=_blank>博客园</a>
	</li>
	<li>
		<a href='http://blog.chinaunix.net/uid/29997432.html' target=_blank>ChinaUnix博客</a>
	</li>
	<li>
		<a href='https://blog.51cto.com/u_16189960' target=_blank>51CTO博客</a>
	</li>
	<li>
		<a href='https://segmentfault.com/a/1190000044015394' target=_blank>segmentfault博客</a>
	</li>
	<li>
		<a href='http://hi.baidu.com/abcdxyzk' target=_blank>hi.baidu</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/zhangskd' target=_blank>zhangsk</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/justlinux2010' target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href='http://simohayha.iteye.com/' target=_blank>simohayha</a>
	</li>
	<li>
		<a href='http://linux.chinaunix.net/techdoc/net/' target=_blank>技术文档</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/cybertan' target=_blank>cybertan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/newnewman80' target=_blank>newnewman80</a>
	</li>
	<li>
		<a href='http://www.cppblog.com/fwxjj/' target=_blank>fwxjj</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/ustc_dylan' target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/nkguohao' target=_blank>nkguohao</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/yusiguyuan' target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href='http://www.oenhan.com/' target=_blank>oenhan</a>
	</li>
	<li>
		<a href='http://blog.csdn.net/bullbat' target=_blank>bullbat</a>
	</li>
	<li>
		<a href='http://www.wowotech.net/' target=_blank>wowotech</a>
	</li>
	<li>
		<a href='http://www.lenky.info/' target=_blank>lenky</a>
	</li>
	<li>
		<a href='http://smilejay.com/' target=_blank>smilejay</a>
	</li>
	<li>
		<a href='http://blog.chinaunix.net/uid/10167808.html' target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<!--
<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>
-->

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo">  Copyright &copy; 2024 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//www.abcxyzkk.xyz/matomo/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->


<!-- Histats.com  (div with counter) --><div id="histats_counter"></div>
<!-- Histats.com  START  (aync)-->
<!--
<script type="text/javascript">var _Hasync= _Hasync|| [];
_Hasync.push(['Histats.start', '1,4673876,4,107,170,20,00010000']);
_Hasync.push(['Histats.fasi', '1']);
_Hasync.push(['Histats.track_hits', '']);
(function() {
var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
hs.src = ('//s10.histats.com/js15_as.js');
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
})();</script>
<noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4673876&101" alt="simple hit counter" border="0"></a></noscript>
-->
<!-- Histats.com  END  -->

<!--  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
-->


<!--
<script>

// TODO 无法获取框架内元素
function autoads()
{
try {
	console.log('start');
	var txt = document.getElementById('mys-content').innerHTML;
	var len = txt.length;
	var url = '';
	console.log(len);
	for (var i = 0; i < len - 10; i ++) {
		if (txt.substring(i, i + 6) == 'href="') {
			i = i + 6;
			url = '';
			for ( ; i < len; i ++) {
				if (txt[i] == '"')
					break;
				url += txt[i];
			}
			url = url.replace(/&amp;/g, '&');
		//	console.log(url);
		}
	}
	console.log(url);
	if (url != '' && Math.random() < 0.3)
		window.open(url, "_blank");
} catch (e) {
}
}

window.onload = function() {
	setTimeout("autoads()", 5*1000);
}
</script>
-->


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
